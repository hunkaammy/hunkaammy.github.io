<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>ULTIMATE DJ CONSOLE - V26 (FIXED)</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-body: #050505; --deck-surface: #121212; --mixer-surface: #181818; --cyan: #00f0ff; --pink: #ff0055; --lime: #ccff00; --text-main: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Rajdhani', sans-serif; background: radial-gradient(circle at center, #111 0%, #000 100%); color: var(--text-main); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { background: #080808; height: 50px; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #333; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .logo { font-weight: 700; letter-spacing: 2px; color: #fff; display:flex; align-items:center; gap:8px; font-size: 16px; text-shadow: 0 0 15px rgba(0, 240, 255, 0.4); }
        .header-controls { display:flex; gap:10px; }
        .btn-icon { background: linear-gradient(145deg, #222, #181818); border: 1px solid #333; color: #aaa; width: 38px; height: 34px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .btn-icon:active { transform: translateY(2px); color: #fff; }
        .btn-lib { width: auto; padding: 0 15px; color: var(--cyan); border-color: rgba(0,240,255,0.2); font-weight: bold; }

        /* CONSOLE LAYOUT */
        .console { display: flex; flex-direction: column; flex: 1; overflow: hidden; height: 100%; width: 100%; padding: 5px; gap: 5px; }
        .console-upper { display: flex; gap: 5px; overflow: hidden; min-height: 0; align-items: stretch; }
        .console-bottom { height: 80px; flex-shrink: 0; background: #101010; border: 1px solid #333; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; padding: 5px 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        
        /* DECKS */
        .deck { flex: 1; display: flex; flex-direction: column; gap: 6px; padding: 8px; background: var(--deck-surface); border-radius: 8px; border: 1px solid #222; position: relative; transition: box-shadow 0.3s; min-width: 0; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); }
        .deck.active-deck-a { border-color: rgba(0,240,255,0.3); box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 0 15px rgba(0, 240, 255, 0.15); }
        .deck.active-deck-b { border-color: rgba(255,0,85,0.3); box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 0 15px rgba(255, 0, 85, 0.15); }

        .deck-header { display: flex; align-items: center; gap: 8px; height: 35px; flex-shrink: 0; }
        .deck-id { font-size: 18px; font-weight: 900; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: #000; border: 1px solid #333; }
        .deck:first-child .deck-id { color: var(--cyan); text-shadow: 0 0 8px var(--cyan); }
        .deck:last-child .deck-id { color: var(--pink); text-shadow: 0 0 8px var(--pink); }

        /* SEARCH & DROPDOWN */
        .search-area { flex: 1; position: relative; }
        .inp-search { width: 100%; background: #050505; border: 1px solid #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 13px; font-family: inherit; }
        .inp-search:focus { outline: none; border-color: #555; background: #000; }
        .dropdown { position: absolute; top: 45px; left: 0; width: 100%; height: 400px; background: rgba(20,20,20,0.98); border: 1px solid #444; z-index: 2000; overflow-y: auto; display: none; box-shadow: 0 10px 50px #000; border-radius: 6px; backdrop-filter: blur(10px); }
        .dd-item { display: flex; padding: 10px; border-bottom: 1px solid #333; cursor: pointer; align-items: center; transition: 0.2s; }
        .dd-item:hover { background: #252525; }
        .dd-img { width: 60px; height: 45px; object-fit: cover; margin-right: 12px; border-radius: 4px; flex-shrink: 0;}
        .dd-info { flex: 1; overflow: hidden; }
        .dd-title { font-size: 14px; font-weight: bold; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dd-sub { font-size: 11px; color: #888; display: flex; align-items: center; gap: 6px;}
        .channel-link { color: #aaa; font-weight: bold; cursor: pointer; padding: 2px 4px; border-radius: 3px; transition: 0.2s; z-index: 5; display:inline-flex; align-items:center; gap:4px; }
        .channel-link:hover { color: var(--cyan); background: rgba(255,255,255,0.1); text-decoration: none; }
        .dd-loader { padding: 20px; text-align: center; color: #666; font-style: italic; }

        /* VISUALS (HYBRID) */
        .vis-box { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 6px; overflow: hidden; border: 1px solid #333; position: relative; flex-shrink: 0; box-shadow: inset 0 0 20px #000; }
        .video-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; }
        .mp3-visual { display: none; width: 100%; height: 100%; align-items: center; justify-content: center; background: radial-gradient(#222, #000); flex-direction: column; }
        .vinyl-disc { width: 120px; height: 120px; border-radius: 50%; background: repeating-radial-gradient(#111, #111 2px, #222 3px); border: 2px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.8); animation: spin 2s linear infinite; animation-play-state: paused; display: flex; align-items: center; justify-content: center;}
        .vinyl-label { width: 40px; height: 40px; background: var(--pink); border-radius: 50%; }
        .deck:first-child .vinyl-label { background: var(--cyan); }
        .mp3-tag { margin-top: 10px; font-size: 10px; letter-spacing: 2px; color: #666; font-weight: bold; border: 1px solid #333; padding: 2px 6px; border-radius: 3px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* CONTROLS */
        .info-box { background: linear-gradient(180deg, #0a0a0a, #000); border: 1px solid #333; padding: 0 10px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; gap: 10px; height: 36px; flex-shrink: 0; margin-top:5px; box-shadow: inset 0 2px 5px rgba(0,0,0,1); }
        .marquee-wrap { flex: 1; overflow: hidden; white-space: nowrap; position: relative; mask-image: linear-gradient(90deg, transparent, #000 5%, #000 95%, transparent); }
        .track-name { font-weight: 700; font-size: 13px; color: #fff; display: inline-block; letter-spacing: 0.5px; }
        .scrolling { animation: scroll-text 12s linear infinite; padding-left: 100%; }
        @keyframes scroll-text { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .time-badge { font-family: 'Courier New', monospace; font-size: 14px; color: var(--lime); font-weight: bold; text-shadow: 0 0 5px rgba(204, 255, 0, 0.5); }

        .scrubber-container { width: 100%; padding: 5px 0; flex-shrink: 0; }
        input[type=range].scrubber { -webkit-appearance: none; width: 100%; height: 8px; background: #000; border-radius: 5px; border: 1px solid #333; box-shadow: inset 0 2px 5px rgba(0,0,0,1); }
        input[type=range].scrubber::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; background: #ddd; border-radius: 2px; margin-top: -5px; cursor: grab; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .deck:first-child .scrubber::-webkit-slider-runnable-track { background: linear-gradient(90deg, var(--cyan) var(--prog, 0%), #222 var(--prog, 0%)); height: 100%; border-radius:5px; }
        .deck:last-child .scrubber::-webkit-slider-runnable-track { background: linear-gradient(90deg, var(--pink) var(--prog, 0%), #222 var(--prog, 0%)); height: 100%; border-radius:5px; }

        .controls-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; flex-shrink: 0; }
        .btn-pad { background: linear-gradient(180deg, #222, #151515); border: 1px solid #333; color: #888; height: 42px; border-radius: 6px; font-weight: 700; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: 0.1s; box-shadow: 0 3px 0 #000, 0 3px 5px rgba(0,0,0,0.5); }
        .btn-pad:active { transform: translateY(3px); box-shadow: 0 1px 0 #000; }
        .btn-pad.play { color: #ccc; border-bottom: 3px solid #2ecc71; }
        .btn-pad.play.playing { background: #2ecc71; color: #000; box-shadow: 0 0 15px #2ecc71; }
        .btn-pad.cue { color: #ccc; border-bottom: 3px solid #f1c40f; }
        .btn-pad.cue:active { background: #f1c40f; color: #000; }
        .btn-pad.active-loop { background: var(--lime); color: #000; border-color: var(--lime); box-shadow: 0 0 15px var(--lime); }
        .btn-pad.hot.set { border-top: 3px solid #fff; color: #fff; background: rgba(255,255,255,0.1); }
        
        .tempo-container { display: flex; align-items: center; gap: 8px; background: #080808; padding: 6px 10px; border-radius: 6px; margin-top: 6px; border: 1px solid #222; flex-shrink: 0; box-shadow: inset 0 2px 5px #000; }
        .tempo-slider { flex: 1; height: 6px; -webkit-appearance: none; background: #151515; border-radius: 3px; border: 1px solid #333; }
        .tempo-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 24px; background: linear-gradient(180deg, #666, #333); border-radius: 3px; margin-top: -6px; border: 1px solid #000; box-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* MIXER */
        .mixer { flex: 0 0 140px; background: var(--mixer-surface); background-image: linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.2) 50%); background-size: 20px 20px; border-left: 1px solid #2a2a2a; border-right: 1px solid #2a2a2a; display: flex; flex-direction: column; padding-bottom: 5px; z-index: 10; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); }
        .eq-group { display: flex; justify-content: space-around; width: 100%; flex-shrink: 0; padding-top: 5px;}
        .knob-stack { display:flex; flex-direction:column; gap:8px; align-items:center; }
        .knob { width: 38px; height: 38px; border-radius: 50%; background: conic-gradient(#333 0deg, #111 180deg, #333 360deg); border: 1px solid #000; position: relative; box-shadow: 0 5px 10px rgba(0,0,0,0.8); cursor: ns-resize; }
        .knob::before { content: ''; position: absolute; inset: 4px; background: #1a1a1a; border-radius: 50%; }
        .knob::after { content: ''; position: absolute; top: 5px; left: 50%; width: 3px; height: 12px; background: #fff; transform: translateX(-50%); border-radius: 2px; }
        .knob-label { font-size: 8px; color: #777; font-weight: bold; margin-top: 3px; }

        .fader-group { display: flex; justify-content: space-between; width: 100%; flex: 1; min-height: 0; padding: 10px 15px; margin-top: 5px; background: repeating-linear-gradient(0deg, #222, #222 1px, transparent 1px, transparent 10px); border: 1px solid #222; border-radius:4px; box-shadow: inset 0 0 10px #000; }
        input[type=range].v-fader { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 40px; cursor: pointer; background: transparent; margin: 0; height: 100%; }
        input[type=range].v-fader::-webkit-slider-thumb { -webkit-appearance: none; height: 40px; width: 40px; background: linear-gradient(180deg, #444, #111, #000); border: 1px solid #000; border-radius: 2px; box-shadow: 0 4px 8px rgba(0,0,0,0.9); margin-left: -17px; position: relative; z-index: 5; background-image: repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(255,255,255,0.1) 11px, transparent 12px); }

        .autofade-box { width: 100%; display: flex; justify-content: space-between; gap: 20px; flex-shrink: 0; margin-bottom: 5px;}
        .btn-xf { background: #222; border: 1px solid #444; color: #888; font-size: 11px; width: 80px; padding: 4px; border-radius: 3px; cursor: pointer; font-weight: bold;}
        .xfader-container { width: 100%; height: 50px; background: #050505; border-radius: 4px; border: 1px solid #333; display: flex; align-items: center; padding: 0 20px; flex-shrink: 0; box-shadow: inset 0 2px 10px #000; background-image: linear-gradient(#000, #000), linear-gradient(90deg, #111 0%, #111 100%); background-size: 100% 2px, 90% 6px; background-position: center, center; background-repeat: no-repeat; }
        .xfader { -webkit-appearance: none; width: 100%; height: 100%; background: transparent; cursor: pointer; }
        .xfader::-webkit-slider-thumb { -webkit-appearance: none; width: 80px; height: 40px; background: linear-gradient(180deg, #f0f0f0, #aaa, #555); border: 1px solid #fff; border-radius: 3px; box-shadow: 0 5px 15px rgba(0,0,0,1), inset 0 1px 0 rgba(255,255,255,0.8); background-image: linear-gradient(90deg, transparent 48%, #ff0000 48%, #ff0000 52%, transparent 52%); }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center; }
        .modal-box { background: #121212; width: 95%; height: 90%; max-width: 900px; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .lib-header { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; }
        
        /* RESTORED STATUS BAR */
        .lib-status-bar { height: 32px; display: flex; margin-bottom: 15px; border-radius: 4px; overflow: hidden; background: #000; border: 1px solid #333; }
        .lib-status-side { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; color: #444; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .lib-status-side.active-a { background: var(--cyan); color: #000; box-shadow: 0 0 20px var(--cyan); }
        .lib-status-side.active-b { background: var(--pink); color: #fff; box-shadow: 0 0 20px var(--pink); }
        .lib-status-side.active-mix { background: #ffaa00; color: #000; }

        .lib-scroll { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; background: #222; padding: 12px; color: #888; position: sticky; top: 0; font-size:11px; text-transform:uppercase; letter-spacing:1px; }
        td { padding: 14px 12px; border-bottom: 1px solid #222; color: #ccc; }
        tr:hover { background: #1a1a1a; }
        .type-badge { font-size: 9px; padding: 2px 4px; border-radius: 3px; font-weight: bold; text-transform: uppercase; margin-right: 5px; }
        .type-yt { background: #d32f2f; color: #fff; }
        .type-mp3 { background: #fbc02d; color: #000; }
        
        .btn-load { padding: 8px 16px; border-radius: 4px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; font-family:inherit; }
        .btn-load.a { background: rgba(0, 240, 255, 0.1); color: var(--cyan); border: 1px solid rgba(0, 240, 255, 0.3); }
        .btn-load.b { background: rgba(255, 0, 85, 0.1); color: var(--pink); border: 1px solid rgba(255, 0, 85, 0.3); }
        .btn-load:hover { filter:brightness(1.5); }
        
        @media (max-width: 800px) {
            .mixer { flex: 0 0 90px; } .knob { width: 30px; height: 30px; }
            .vis-box { aspect-ratio: 16/9; height: auto; } .deck-id { display: none; }
            .btn-pad { font-size: 9px; height: 40px; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo"><i class="fas fa-compact-disc fa-spin" style="color:var(--cyan)"></i> V26 HYBRID PRO</div>
    <div class="header-controls">
        <button class="btn-icon btn-lib" onclick="toggleLibrary()"><i class="fas fa-music"></i> &nbsp;LIBRARY</button>
        <button class="btn-icon" onclick="exportData()" title="Backup History"><i class="fas fa-download"></i></button>
        <button class="btn-icon" onclick="document.getElementById('file-restore').click()" title="Restore History"><i class="fas fa-upload"></i></button>
        <input type="file" id="file-restore" hidden onchange="importData(event)">
        <button class="btn-icon" onclick="toggleNotes()"><i class="fas fa-sticky-note"></i></button>
        <button class="btn-icon" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
    </div>
</header>

<div class="console">
    <div class="console-upper">
        <div class="deck" id="deck1">
            <div class="deck-header">
                <div class="deck-id">A</div>
                <div class="search-area">
                    <input type="text" class="inp-search" id="search1" placeholder="Search YouTube..." oninput="handleType(1)">
                    <div class="dropdown" id="dd1"></div>
                </div>
            </div>
            
            <div class="vis-box">
                <div id="p1-wrap" class="video-container"></div>
                <div id="vis1" class="mp3-visual"><div class="vinyl-disc"><div class="vinyl-label"></div></div><div class="mp3-tag">MP3 MODE</div></div>
            </div>

            <div class="info-box">
                <div class="marquee-wrap"><span class="track-name" id="title1">No Track Loaded</span></div>
                <div class="time-badge" id="time1">00:00</div>
            </div>

            <div class="scrubber-container">
                <input type="range" class="scrubber" id="seek1" min="0" max="100" value="0" oninput="startSeek(1)" onchange="endSeek(1)">
            </div>

            <div class="controls-grid">
                <button class="btn-pad play" id="play1" onclick="playPause(1)"><i class="fas fa-play"></i></button>
                <button class="btn-pad cue" onclick="cue(1)">CUE</button>
                <button class="btn-pad" onclick="loop(1,4)" id="loop1-4">LOOP 4</button>
                <button class="btn-pad" onclick="loop(1,8)" id="loop1-8">LOOP 8</button>
                <button class="btn-pad hot" id="hot1-A" onclick="hotCue(1,'A')">HOT 1</button>
                <button class="btn-pad hot" id="hot1-B" onclick="hotCue(1,'B')">HOT 2</button>
                <button class="btn-pad hot" id="hot1-C" onclick="hotCue(1,'C')">HOT 3</button>
                <button class="btn-pad" onclick="delCue(1)" style="color:#d32f2f">DEL</button>
            </div>

            <div class="tempo-container">
                <div class="tempo-label">TEMPO</div>
                <input type="range" class="tempo-slider" id="tempo1" min="0.5" max="1.5" step="0.01" value="1" oninput="setRate(1)">
                <div class="tempo-val" id="rate1">0%</div>
            </div>
        </div>

        <div class="mixer">
            <div class="eq-group">
                <div class="knob-stack"><div class="knob"></div><span class="knob-label">HIGH</span></div>
                <div class="knob-stack"><div class="knob"></div><span class="knob-label">MID</span></div>
                <div class="knob-stack"><div class="knob"></div><span class="knob-label">LOW</span></div>
            </div>
            <div class="fader-group">
                <input type="range" class="v-fader" id="vol1" min="0" max="100" value="100" oninput="setVol()">
                <input type="range" class="v-fader" id="vol2" min="0" max="100" value="100" oninput="setVol()">
            </div>
        </div>

        <div class="deck" id="deck2">
            <div class="deck-header">
                <div class="deck-id">B</div>
                <div class="search-area">
                    <input type="text" class="inp-search" id="search2" placeholder="Search YouTube..." oninput="handleType(2)">
                    <div class="dropdown" id="dd2"></div>
                </div>
            </div>
            
            <div class="vis-box">
                <div id="p2-wrap" class="video-container"></div>
                <div id="vis2" class="mp3-visual"><div class="vinyl-disc"><div class="vinyl-label"></div></div><div class="mp3-tag">MP3 MODE</div></div>
            </div>

            <div class="info-box">
                <div class="marquee-wrap"><span class="track-name" id="title2">No Track Loaded</span></div>
                <div class="time-badge" id="time2">00:00</div>
            </div>

            <div class="scrubber-container">
                <input type="range" class="scrubber" id="seek2" min="0" max="100" value="0" oninput="startSeek(2)" onchange="endSeek(2)">
            </div>

            <div class="controls-grid">
                <button class="btn-pad play" id="play2" onclick="playPause(2)"><i class="fas fa-play"></i></button>
                <button class="btn-pad cue" onclick="cue(2)">CUE</button>
                <button class="btn-pad" onclick="loop(2,4)" id="loop2-4">LOOP 4</button>
                <button class="btn-pad" onclick="loop(2,8)" id="loop2-8">LOOP 8</button>
                <button class="btn-pad hot" id="hot2-A" onclick="hotCue(2,'A')">HOT 1</button>
                <button class="btn-pad hot" id="hot2-B" onclick="hotCue(2,'B')">HOT 2</button>
                <button class="btn-pad hot" id="hot2-C" onclick="hotCue(2,'C')">HOT 3</button>
                <button class="btn-pad" onclick="delCue(2)" style="color:#d32f2f">DEL</button>
            </div>

            <div class="tempo-container">
                <div class="tempo-label">TEMPO</div>
                <input type="range" class="tempo-slider" id="tempo2" min="0.5" max="1.5" step="0.01" value="1" oninput="setRate(2)">
                <div class="tempo-val" id="rate2">0%</div>
            </div>
        </div>
    </div>

    <div class="console-bottom">
        <div class="autofade-box">
            <button class="btn-xf" onclick="autoFade(1,2)">AUTO &rarr;</button>
            <div style="color:#444; font-size:10px; font-weight:bold; letter-spacing:2px; display:flex; align-items:center;">CROSSFADER</div>
            <button class="btn-xf" onclick="autoFade(2,1)">&larr; AUTO</button>
        </div>
        <div class="xfader-container">
            <input type="range" class="xfader" id="xfader" min="0" max="100" value="50" oninput="setVol()">
        </div>
    </div>
</div>

<div class="modal" id="modal-library" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-box">
        <div class="lib-header">
            <div class="lib-status-bar">
                <div class="lib-status-side" id="status-a">DECK A</div>
                <div class="lib-status-side" id="status-b">DECK B</div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:10px">
                <button class="btn-load" style="background:#333; color:#fff; border:1px solid #555" onclick="document.getElementById('file-inp').click()">
                    <i class="fas fa-file-audio"></i> &nbsp; IMPORT LOCAL MP3s
                </button>
                <input type="file" id="file-inp" hidden multiple accept="audio/*" onchange="importMp3s(this)">
                <div style="color:#666; font-size:11px; display:flex; align-items:center;">
                    (Files saved to browser memory)
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <select id="cat-filter" class="inp-search" style="width:30%" onchange="refreshLib()">
                    <option value="">All Categories</option>
                </select>
                <input type="text" id="lib-filter" class="inp-search" style="flex:1" placeholder="Filter Library..." onkeyup="refreshLib()">
                <button class="btn-icon" style="color:var(--pink)" onclick="document.getElementById('modal-library').style.display='none'"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="lib-scroll">
            <table id="lib-table">
                <thead>
                    <tr>
                        <th style="width:10%">Type</th>
                        <th style="width:50%">Track</th>
                        <th style="width:15%">Cat</th>
                        <th style="width:25%; text-align:right">Load</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal" id="modal-notes" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-box" style="height:auto; max-height:80%;">
        <div class="lib-header"><h3>DJ NOTES</h3></div>
        <div style="padding:15px">
            <textarea id="notes-text" style="width:100%; height:200px; background:#222; color:#fff; border:1px solid #444; padding:10px; border-radius:4px; font-family:inherit;"></textarea>
            <button class="btn-icon btn-lib" style="width:100%; margin-top:10px; height:40px;" onclick="saveNotes()">SAVE NOTES</button>
        </div>
    </div>
</div>

<script>
    /* ----- 1. CONFIGURATION & STATE ----- */
    const fbConfig = { apiKey: "AIzaSyBPc51z-pGrtKwtB5dKTMPei-fVRg4ePME", authDomain: "pagdi-6f8ce.firebaseapp.com", databaseURL: "https://pagdi-6f8ce-default-rtdb.firebaseio.com", projectId: "pagdi-6f8ce", storageBucket: "pagdi-6f8ce.appspot.com", messagingSenderId: "746289566527", appId: "1:746289566527:web:4c32c4fec73bb7e898798a" };
    firebase.initializeApp(fbConfig);
    const db = firebase.database();

    // Database for MP3s (Persistent Storage)
    const mp3DB = new Dexie("DJConsoleV26");
    mp3DB.version(1).stores({ tracks: "++id, title, blob, date" });

    // Global Variables
    const deckState = {
        1: { type: 'yt', playing: false, loops: {}, hots: {A:null,B:null,C:null}, dragging: false, ready: false },
        2: { type: 'yt', playing: false, loops: {}, hots: {A:null,B:null,C:null}, dragging: false, ready: false }
    };
    const searchState = { 1: { query:'', token:null, loading:false, timer:null }, 2: { query:'', token:null, loading:false, timer:null } };
    const players = { 1: null, 2: null }; 
    const audioNodes = { 1: new Audio(), 2: new Audio() }; 
    let libraryData = [], categories = ['Pop','House','HipHop'];
    
    // API Keys Rotation (Reliability)
    const apiKeys = ['13452c8109msh7750057c5193b47p1c47c0jsn5d53a80bb998', 'd85300e47amsh5ad671c2832cec6p1b7953jsnab9c3a237b6e'];
    let currentKeyIndex = 0;
    function getApiKey() { return apiKeys[currentKeyIndex]; }
    function switchKey() { if(currentKeyIndex < apiKeys.length - 1) { currentKeyIndex++; return true; } return false; }

    /* ----- 2. INITIALIZATION ----- */
    window.onload = function() {
        // Load YouTube API
        const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; document.body.appendChild(tag);
        
        // Listeners for Firebase Data
        db.ref('djCategories').on('value', snap => { categories = snap.val() || ['Pop','House','HipHop']; updateCatFilter(); refreshLib(); });
        db.ref('djNotes').on('value', s => document.getElementById('notes-text').value = s.val() || '');
        db.ref('playedHistory').on('value', snap => {
            const val = snap.val();
            libraryData = libraryData.filter(x => x.source === 'local'); // Preserve locals
            if(val) Object.keys(val).forEach(k => libraryData.push({...val[k], id:k, source:'yt'}));
            refreshLib();
        });

        // Load MP3s from IndexDB
        mp3DB.tracks.toArray().then(tracks => {
            tracks.forEach(t => libraryData.push({ ...t, source:'local', videoId: t.id, category: 'Local' }));
            refreshLib();
        });

        // UI Interactions
        initKnobs();
        [1,2].forEach(d => {
            audioNodes[d].onended = () => { deckState[d].playing = false; updatePlayBtn(d); };
            audioNodes[d].ontimeupdate = () => {
                if(deckState[d].type === 'mp3' && !deckState[d].dragging) updateUI(d, audioNodes[d].currentTime, audioNodes[d].duration);
            };
            document.getElementById(`dd${d}`).onscroll = () => checkScroll(d);
        });
        document.addEventListener('click', e => { if(!e.target.closest('.search-area')) document.querySelectorAll('.dropdown').forEach(d => d.style.display='none'); });
    };

    window.onYouTubeIframeAPIReady = function() {
        players[1] = new YT.Player('p1-wrap', { height:'100%', width:'100%', events: { 'onStateChange': e => onYTState(1, e), 'onReady': () => { deckState[1].ready=true; setVol(); } } });
        players[2] = new YT.Player('p2-wrap', { height:'100%', width:'100%', events: { 'onStateChange': e => onYTState(2, e), 'onReady': () => { deckState[2].ready=true; setVol(); } } });
    };

    /* ----- 3. HYBRID PLAYER ENGINE ----- */
    async function loadTrack(d, id, title, source) {
        deckState[d].playing = false;
        deckState[d].loops = {};
        deckState[d].hots = {A:null,B:null,C:null};
        document.getElementById(`title${d}`).innerText = title;
        document.getElementById(`title${d}`).className = title.length > 25 ? 'track-name scrolling' : 'track-name';
        
        updatePlayBtn(d);
        document.getElementById(`seek${d}`).value = 0;
        document.getElementById('modal-library').style.display='none';
        
        // SWITCH ENGINE
        if (source === 'yt') {
            deckState[d].type = 'yt';
            document.getElementById(`p${d}-wrap`).style.opacity = '1';
            document.getElementById(`vis${d}`).style.display = 'none';
            audioNodes[d].pause();
            players[d].loadVideoById(id);
            if(deckState[d].ready) setVol();
        } else {
            deckState[d].type = 'mp3';
            document.getElementById(`p${d}-wrap`).style.opacity = '0'; // Hide YT
            document.getElementById(`vis${d}`).style.display = 'flex';
            if(deckState[d].ready) players[d].stopVideo();

            const track = await mp3DB.tracks.get(parseInt(id));
            if(track) {
                audioNodes[d].src = URL.createObjectURL(track.blob);
                audioNodes[d].load();
                setVol();
            }
        }
    }

    function playPause(d) {
        const isYT = deckState[d].type === 'yt';
        if (isYT) {
            if(!deckState[d].ready) return;
            players[d].getPlayerState() === 1 ? players[d].pauseVideo() : players[d].playVideo();
        } else {
            if(audioNodes[d].paused) {
                audioNodes[d].play();
                deckState[d].playing = true;
                document.getElementById(`vis${d}`).querySelector('.vinyl-disc').style.animationPlayState = 'running';
            } else {
                audioNodes[d].pause();
                deckState[d].playing = false;
                document.getElementById(`vis${d}`).querySelector('.vinyl-disc').style.animationPlayState = 'paused';
            }
            updatePlayBtn(d);
            startTmr(d);
        }
    }

    function cue(d) {
        if(deckState[d].type === 'yt') { players[d].pauseVideo(); players[d].seekTo(0); }
        else { audioNodes[d].pause(); audioNodes[d].currentTime = 0; deckState[d].playing = false; updatePlayBtn(d); }
    }

    function startSeek(d) { deckState[d].dragging = true; }
    function endSeek(d) {
        const v = document.getElementById(`seek${d}`).value;
        if(deckState[d].type === 'yt') {
            const dur = players[d].getDuration();
            players[d].seekTo((v/100)*dur, true);
        } else {
            const dur = audioNodes[d].duration;
            if(dur) audioNodes[d].currentTime = (v/100)*dur;
        }
        setTimeout(() => deckState[d].dragging = false, 500);
    }

    /* ----- 4. DJ TOOLS (LOOPS, CUES, EQ) ----- */
    function loop(d, l) {
        const btn = document.getElementById(`loop${d}-${l}`);
        if(deckState[d].loops[l]) { 
            clearInterval(deckState[d].loops[l]); delete deckState[d].loops[l]; btn.classList.remove('active-loop'); 
        } else {
            btn.classList.add('active-loop');
            const getT = () => deckState[d].type==='yt' ? players[d].getCurrentTime() : audioNodes[d].currentTime;
            const setT = (t) => deckState[d].type==='yt' ? players[d].seekTo(t,true) : (audioNodes[d].currentTime=t);
            const rate = deckState[d].type==='yt' ? players[d].getPlaybackRate() : audioNodes[d].playbackRate;
            const start = getT();
            const dur = (l*0.5) / rate;
            deckState[d].loops[l] = setInterval(() => { if(getT() >= start + dur) setT(start); }, 50);
        }
    }

    function hotCue(d, k) {
        const btn = document.getElementById(`hot${d}-${k}`);
        const getT = () => deckState[d].type==='yt' ? players[d].getCurrentTime() : audioNodes[d].currentTime;
        const setT = (t) => deckState[d].type==='yt' ? players[d].seekTo(t,true) : (audioNodes[d].currentTime=t);
        if(deckState[d].hots[k] !== null) setT(deckState[d].hots[k]);
        else { deckState[d].hots[k] = getT(); btn.classList.add('set'); }
    }
    function delCue(d) { ['A','B','C'].forEach(k => { deckState[d].hots[k]=null; document.getElementById(`hot${d}-${k}`).classList.remove('set'); }); }

    function setRate(d) {
        const v = parseFloat(document.getElementById(`tempo${d}`).value);
        const p = Math.round((v-1)*100);
        document.getElementById(`rate${d}`).innerText = (p>0?'+':'') + p + '%';
        if(deckState[d].type === 'yt' && deckState[d].ready) players[d].setPlaybackRate(v);
        else audioNodes[d].playbackRate = v;
    }

    function setVol() {
        try {
            const x = parseInt(document.getElementById('xfader').value) / 100;
            const v1 = parseInt(document.getElementById('vol1').value) / 100;
            const v2 = parseInt(document.getElementById('vol2').value) / 100;
            const g1 = Math.cos(x * 1.57), g2 = Math.sin(x * 1.57);
            if(deckState[1].ready) players[1].setVolume(v1 * g1 * 100);
            if(deckState[2].ready) players[2].setVolume(v2 * g2 * 100);
            audioNodes[1].volume = v1 * g1;
            audioNodes[2].volume = v2 * g2;
            updateLibStatus(x); // UPDATE LIBRARY STATUS
        } catch(e){}
    }
    
    // NEW: Update Status Bar in Library
    function updateLibStatus(x) {
        const stA = document.getElementById('status-a');
        const stB = document.getElementById('status-b');
        if(!stA || !stB) return;
        
        stA.className = 'lib-status-side'; stB.className = 'lib-status-side';
        stA.innerText = "DECK A"; stB.innerText = "DECK B";
        
        if (x < 0.4) {
            stA.classList.add('active-a'); stA.innerText = "DECK A LIVE";
        } else if (x > 0.6) {
            stB.classList.add('active-b'); stB.innerText = "DECK B LIVE";
        } else {
            stA.classList.add('active-mix'); stB.classList.add('active-mix');
            stA.innerText = "MIX LIVE"; stB.innerText = "MIX LIVE";
        }
    }

    /* ----- 5. ADVANCED SEARCH & BROWSING ----- */
    function handleType(d) {
        clearTimeout(searchState[d].timer);
        const val = document.getElementById(`search${d}`).value;
        if(!val) { document.getElementById(`dd${d}`).style.display='none'; return; }
        searchState[d].timer = setTimeout(() => searchYouTube(d), 1000);
    }

    async function searchYouTube(d, retry=false) {
        const q = document.getElementById(`search${d}`).value; if(!q) return;
        const dd = document.getElementById(`dd${d}`);
        if(!retry) { searchState[d].query=q; searchState[d].token=null; dd.innerHTML='<div class="dd-loader">Searching...</div>'; dd.style.display='block'; }
        
        try {
            const res = await fetch(`https://youtube-search-and-download.p.rapidapi.com/search?query=${encodeURIComponent(q)}&type=all`, { method:'GET', headers:{'x-rapidapi-key':getApiKey(),'x-rapidapi-host':'youtube-search-and-download.p.rapidapi.com'} });
            if(!res.ok) { if(switchKey()) return searchYouTube(d, true); throw new Error(); }
            const data = await res.json();
            searchState[d].token = data.continuation || data.token || data.next || null;
            dd.innerHTML = '';
            renderResults(d, data.contents || []);
        } catch(e) { dd.innerHTML='<div class="dd-loader" style="color:#ff5555">Error</div>'; }
    }

    function renderResults(d, items, append=false) {
        const dd = document.getElementById(`dd${d}`);
        if(!append) dd.innerHTML = '';
        items.forEach(item => {
            const v = item.video; const c = item.channel;
            const el = document.createElement('div'); el.className='dd-item';
            if(v) {
                const cName = v.channelName || (v.channel?v.channel.name:'Unknown');
                const cId = v.channelId || (v.channel?v.channel.id:'');
                el.innerHTML = `<img src="${v.thumbnails[0].url}" class="dd-img"><div class="dd-info"><div class="dd-title">${v.title}</div><div class="dd-sub"><span>${v.durationText||''}</span> &bull; <span class="channel-link" onclick="event.stopPropagation(); browseChannel(${d}, '${cId}', '${cName.replace(/'/g, "\\'")}')">${cName}</span></div></div>`;
                el.onclick = () => { loadTrack(d, v.videoId, v.title, 'yt'); db.ref('playedHistory').push({title:v.title, videoId:v.videoId, category:'Uncategorized', timestamp:Date.now()}); };
                dd.appendChild(el);
            } else if(c) {
                el.innerHTML = `<img src="${c.thumbnails[0].url}" class="dd-img" style="border-radius:50%"><div class="dd-info"><div class="dd-title">${c.title}</div><div class="dd-sub">Channel - Browse</div></div>`;
                el.onclick = (e) => { e.stopPropagation(); browseChannel(d, c.channelId, c.title); };
                dd.appendChild(el);
            }
        });
    }

    async function browseChannel(d, id, name) {
        searchState[d].token = null; 
        const dd = document.getElementById(`dd${d}`); dd.style.display='block'; dd.innerHTML=`<div class="dd-loader">Loading ${name}...</div>`;
        try {
            const res = await fetch(`https://youtube-search-and-download.p.rapidapi.com/search?query=${encodeURIComponent(name)}&type=video`, { method:'GET', headers:{'x-rapidapi-key':getApiKey(),'x-rapidapi-host':'youtube-search-and-download.p.rapidapi.com'} });
            const data = await res.json();
            dd.innerHTML = '';
            const back = document.createElement('div'); back.className='dd-item'; back.style.cssText='justify-content:center;background:#222;position:sticky;top:0;z-index:10;color:#fff';
            back.innerHTML='<i class="fas fa-arrow-left"></i> &nbsp; Back to Search'; back.onclick=(e)=>{e.stopPropagation(); searchYouTube(d);}; dd.appendChild(back);
            renderResults(d, data.contents||[], true);
        } catch(e) { dd.innerHTML='<div class="dd-loader">Error</div>'; }
    }

    function checkScroll(d) {
        const dd = document.getElementById(`dd${d}`);
        if(dd.scrollHeight - dd.scrollTop <= dd.clientHeight + 100 && !searchState[d].loading && searchState[d].token) loadMore(d);
    }

    async function loadMore(d) {
        searchState[d].loading = true;
        try {
            const res = await fetch(`https://youtube-search-and-download.p.rapidapi.com/search?next=${searchState[d].token}`, { method:'GET', headers:{'x-rapidapi-key':getApiKey(),'x-rapidapi-host':'youtube-search-and-download.p.rapidapi.com'} });
            if(!res.ok && switchKey()) throw new Error();
            const data = await res.json();
            searchState[d].token = data.continuation || data.token || data.next || null;
            renderResults(d, data.contents || [], true);
        } catch(e){}
        searchState[d].loading = false;
    }

    /* ----- 6. LIBRARY, IMPORT/EXPORT & NOTES ----- */
    async function importMp3s(el) {
        if(!el.files.length) return;
        let count = 0;
        for(let f of el.files) {
            await mp3DB.tracks.add({ title: f.name.replace('.mp3',''), blob: f, date: Date.now() });
            count++;
        }
        alert(`${count} Tracks added to Browser Storage!`);
        window.location.reload();
    }

    function toggleLibrary() { 
        document.getElementById('modal-library').style.display='flex'; 
        setVol(); // Triggers updateLibStatus
        refreshLib(); 
    }
    function toggleNotes() { document.getElementById('modal-notes').style.display='flex'; }
    function saveNotes() { db.ref('djNotes').set(document.getElementById('notes-text').value); document.getElementById('modal-notes').style.display='none'; }
    
    function refreshLib() {
        const tbody = document.querySelector('#lib-table tbody');
        const txt = document.getElementById('lib-filter').value.toLowerCase();
        const cat = document.getElementById('cat-filter').value;
        tbody.innerHTML = '';
        
        const sorted = libraryData.sort((a,b) => (b.timestamp||b.date) - (a.timestamp||a.date));

        sorted.forEach(h => {
            if((cat && h.category!==cat) || (txt && !h.title.toLowerCase().includes(txt))) return;
            const tr = document.createElement('tr');
            const typeClass = h.source === 'yt' ? 'type-yt' : 'type-mp3';
            const typeLabel = h.source === 'yt' ? 'YouTube' : 'MP3';
            
            let opts = `<option>Uncategorized</option>`;
            if(h.source === 'yt') {
                categories.forEach(c => opts+=`<option ${c===h.category?'selected':''}>${c}</option>`);
                opts+=`<option style="color:cyan">+ New</option>`;
            } else {
                opts = `<option>Local File</option>`;
            }

            tr.innerHTML = `
                <td><span class="type-badge ${typeClass}">${typeLabel}</span></td>
                <td>${h.title}</td>
                <td><select ${h.source==='local'?'disabled':''} onchange="changeCat('${h.id}',this)" style="background:#222;color:#fff;border:none;width:100%">${opts}</select></td>
                <td style="text-align:right">
                    <button class="btn-load a" onclick="loadTrack(1,'${h.videoId || h.id}','${h.title.replace(/'/g,"\\'")}','${h.source}')">A</button> 
                    <button class="btn-load b" onclick="loadTrack(2,'${h.videoId || h.id}','${h.title.replace(/'/g,"\\'")}','${h.source}')">B</button>
                    <button onclick="${h.source==='local'?`delMp3(${h.id})`:`delHistory('${h.id}')`}" style="color:#d32f2f;background:none;border:none;cursor:pointer">&times;</button>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function changeCat(id, el) {
        if(el.value.includes('+ New')) {
            const n = prompt("Category:"); if(n) { if(!categories.includes(n)) { categories.push(n); db.ref('djCategories').set(categories); } db.ref(`playedHistory/${id}/category`).set(n); }
        } else db.ref(`playedHistory/${id}/category`).set(el.value);
    }
    
    function delMp3(id) { if(confirm('Delete MP3?')) mp3DB.tracks.delete(id).then(()=>window.location.reload()); }
    function delHistory(id) { if(confirm('Remove from History?')) db.ref(`playedHistory/${id}`).remove(); }
    
    function updateCatFilter() { document.getElementById('cat-filter').innerHTML = '<option value="">All Categories</option>' + categories.map(c=>`<option>${c}</option>`).join(''); }

    function exportData() {
        const historyOnly = libraryData.filter(x => x.source === 'yt'); // Only export YT history metadata
        const b = new Blob([JSON.stringify({history: historyOnly, categories})], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='dj_backup.json'; a.click();
    }
    function importData(e) {
        const r = new FileReader();
        r.onload = ev => {
            const d = JSON.parse(ev.target.result);
            if(d.history) { db.ref('playedHistory').remove(); d.history.forEach(x=>db.ref('playedHistory').push(x)); }
            if(d.categories) db.ref('djCategories').set(d.categories);
        };
        r.readAsText(e.target.files[0]);
    }

    /* ----- 7. UTILS & UI UPDATES ----- */
    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); }
    function initKnobs() {
        document.querySelectorAll('.knob-stack').forEach(stack => {
            const knob = stack.querySelector('.knob');
            let isDragging = false, startY = 0, rotation = 0;
            stack.addEventListener('mousedown', (e) => { isDragging = true; startY = e.clientY; document.body.style.cursor = 'ns-resize'; e.preventDefault(); });
            window.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = 'default'; });
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaY = startY - e.clientY; startY = e.clientY; rotation += deltaY * 3; 
                if (rotation > 140) rotation = 140; if (rotation < -140) rotation = -140;
                knob.style.transform = `rotate(${rotation}deg)`;
            });
        });
    }
    
    function onYTState(d, e) { deckState[d].playing = e.data === 1; updatePlayBtn(d); if(deckState[d].playing) startTmr(d); }
    function updatePlayBtn(d) {
        const el = document.getElementById(`play${d}`); const deck = document.getElementById(`deck${d}`); const disc = document.getElementById(`vis${d}`).querySelector('.vinyl-disc');
        if(deckState[d].playing) { el.classList.add('playing'); deck.classList.add(d===1?'active-deck-a':'active-deck-b'); disc.style.animationPlayState = 'running'; } 
        else { el.classList.remove('playing'); deck.classList.remove('active-deck-a'); deck.classList.remove('active-deck-b'); disc.style.animationPlayState = 'paused'; }
    }
    function startTmr(d) {
        if(window[`tmr${d}`]) clearInterval(window[`tmr${d}`]);
        window[`tmr${d}`] = setInterval(() => {
            if(deckState[d].playing) {
                let t=0, dur=0;
                if(deckState[d].type === 'yt' && deckState[d].ready) { t = players[d].getCurrentTime(); dur = players[d].getDuration(); } 
                else { t = audioNodes[d].currentTime; dur = audioNodes[d].duration; }
                updateUI(d, t, dur);
            }
        }, 500);
    }
    function updateUI(d, t, dur) {
        if(!dur) return;
        const m = Math.floor(t/60).toString().padStart(2,'0'); const s = Math.floor(t%60).toString().padStart(2,'0');
        document.getElementById(`time${d}`).innerText = `${m}:${s}`;
        if(!deckState[d].dragging) { const p = (t/dur)*100; document.getElementById(`seek${d}`).value = p; document.getElementById(`seek${d}`).style.setProperty('--prog', p+'%'); }
    }
    function autoFade(from, to) {
        const el = document.getElementById('xfader'); const end = to===2 ? 100 : 0, step = to===2 ? 2 : -2;
        let c = parseInt(el.value);
        const t = setInterval(() => { if((to===2 && c>=100) || (to===1 && c<=0)) clearInterval(t); else { c+=step; el.value=c; setVol(); } }, 20);
    }
</script>
</body>
</html>
