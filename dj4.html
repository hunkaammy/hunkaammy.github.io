<!DOCTYPE html>
<html>
<head>
  <title>Hindi Pop 2024-2025 Video Player</title>
  <!-- Update Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    .video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
    }
    video {
      width: 100%;
      height: 100%;
      display: none; /* Hidden until play button is clicked */
      object-fit: cover; /* Ensure video fills screen */
    }
    button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .watermark {
      position: absolute;
      top: 10px;
      right: 10px; /* Positioned in top-right corner */
      z-index: 1002; /* Higher than video z-index */
      background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black background */
      color: white;
      padding: 5px 10px;
      font-size: 16px;
      font-family: Arial, sans-serif;
      display: none; /* Hidden until playback starts */
      border-radius: 3px;
      pointer-events: none; /* Prevents watermark from intercepting clicks */
    }
  </style>
</head>
<body>
  <div class="video-container">
    <video id="player"></video>
    <div id="watermark" class="watermark">Sammy TV</div>
  </div>
  <button id="playButton">Play</button>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDM7HUVDfdy_UXAaCx3kYWmDhxrF0y8jyA",
      authDomain: "model-poses.firebaseapp.com",
      databaseURL: "https://model-poses.firebaseio.com",
      projectId: "model-poses",
      storageBucket: "model-poses.firebasestorage.app",
      messagingSenderId: "10510371385",
      appId: "1:10510371385:web:1f93c15f032b729fe61be8"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const player = document.getElementById('player');
    const playButton = document.getElementById('playButton');
    const watermark = document.getElementById('watermark');
    const videoContainer = document.querySelector('.video-container');
    let originalPlaylist = [];
    let playlist = [];
    let totalDuration = 0;
    let currentSongUrl = '';
    let hasEnteredFullscreen = false;
    let isSyncing = false; // Flag to prevent concurrent syncs

    // Function to fetch playlist from Firebase
    async function fetchPlaylist() {
      try {
        const snapshot = await database.ref('videos').once('value');
        const data = snapshot.val();
        console.log("Received data from Firebase:", data);
        
        if (!data) {
          throw new Error("No data received from Firebase");
        }
        
        // Convert object to array
        const playlistArray = Object.keys(data).map(key => ({
          ...data[key],
          id: key
        }));
        
        if (playlistArray.length === 0) {
          throw new Error("Received empty data from Firebase");
        }
        
        originalPlaylist = playlistArray;
        playlist = seededShuffle(originalPlaylist, startTime / 1000);
        totalDuration = playlist.reduce((sum, song) => sum + Number(song.duration), 0);
        console.log("Successfully loaded playlist with", playlist.length, "songs");
      } catch (error) {
        console.error("Error fetching playlist:", error);
        originalPlaylist = [];
        playlist = [];
        totalDuration = 0;
      }
    }

    // Deterministic shuffle function using a seed
    function seededShuffle(array, seed) {
      const newArray = [...array];
      let m = newArray.length, t, i;
      function seededRandom() {
        const x = Math.sin(seed++) * 10000;
        return x - Math.floor(x);
      }
      while (m) {
        i = Math.floor(seededRandom() * m--);
        t = newArray[m];
        newArray[m] = newArray[i];
        newArray[i] = t;
      }
      return newArray;
    }

    // Use startTime as the seed for consistent shuffling
    const startTime = new Date("2025-04-20T00:00:00Z").getTime();

    // Corrected function to calculate current position
    function getCurrentPosition() {
      const now = Date.now();
      const elapsed = (now - startTime) / 1000;
      return ((elapsed % totalDuration) + totalDuration) % totalDuration;
    }

    // Optimized syncVideo function for smooth playback
    async function syncVideo() {
      if (isSyncing || playlist.length === 0) {
        return; // Prevent concurrent syncs or empty playlist
      }
      isSyncing = true;

      try {
        const playlistPosition = getCurrentPosition();

        let accumulatedTime = 0;
        let currentSong = null;
        for (let i = 0; i < playlist.length; i++) {
          accumulatedTime += Number(playlist[i].duration);
          if (playlistPosition < accumulatedTime) {
            currentSong = playlist[i];
            break;
          }
        }

        if (!currentSong) {
          console.error("No current song found");
          isSyncing = false;
          return;
        }

        const songStartTime = accumulatedTime - Number(currentSong.duration);
        const positionInSong = playlistPosition - songStartTime;

        // Log syncing details
        console.log(`Syncing: ${currentSong.title} at ${positionInSong.toFixed(2)}s`);

        // Check if the current song is still playing and position is close
        if (currentSongUrl === currentSong.url && !player.paused) {
          const currentTime = player.currentTime;
          const desync = Math.abs(currentTime - positionInSong);
          if (desync < 1) { // Allow 1-second tolerance
            isSyncing = false;
            return; // No need to adjust if within tolerance
          }
          // Adjust position if desync is significant
          player.currentTime = positionInSong;
          console.log(`Adjusted position to ${positionInSong.toFixed(2)}s due to desync of ${desync.toFixed(2)}s`);
          isSyncing = false;
          return;
        }

        // Load new song if different
        if (currentSongUrl !== currentSong.url) {
          currentSongUrl = currentSong.url;
          player.src = currentSong.url;

          player.addEventListener('canplay', () => {
            console.log(`Successfully loaded video: ${currentSong.url}`);
            player.currentTime = positionInSong;
            player.play().catch(e => console.error("Playback failed:", e));
          }, { once: true });

          player.addEventListener('error', () => {
            console.error(`Error loading video: ${currentSong.url}`);
            setTimeout(() => syncVideo(), 1000);
          }, { once: true });
        } else {
          // Same song, just adjust position
          player.currentTime = positionInSong;
          player.play().catch(e => console.error("Playback failed:", e));
        }
      } catch (e) {
        console.error("Sync error:", e);
      } finally {
        isSyncing = false;
      }
    }

    function enterFullScreen() {
      if (hasEnteredFullscreen) return;
      try {
        if (videoContainer.requestFullscreen) {
          videoContainer.requestFullscreen();
        } else if (videoContainer.webkitRequestFullscreen) {
          videoContainer.webkitRequestFullscreen();
        } else if (videoContainer.msRequestFullscreen) {
          videoContainer.msRequestFullscreen();
        }
        console.log("Full Screen Requested");
        hasEnteredFullscreen = true;
        watermark.style.display = 'block';
      } catch (e) {
        console.error("Full Screen Error:", e);
      }
    }

    // Periodic sync to maintain synchronization
    setInterval(() => {
      if (!player.paused && !isSyncing) {
        syncVideo();
      }
    }, 10000); // Sync every 10 seconds

    // Handle video end for smooth transitions
    player.addEventListener('ended', () => {
      console.log("Video Ended, Switching Track");
      syncVideo();
      player.play().catch(e => console.error("Playback failed:", e));
    });

    // Play button click handler
    playButton.addEventListener('click', () => {
      playButton.style.display = 'none';
      player.style.display = 'block';
      watermark.style.display = 'block';
      syncVideo();
      player.play().catch(e => console.error("Playback failed:", e));
      enterFullScreen();
    });

    // Ensure watermark stays visible in fullscreen
    document.addEventListener('fullscreenchange', () => {
      if (document.fullscreenElement) {
        watermark.style.display = 'block';
      }
    });
    document.addEventListener('webkitfullscreenchange', () => {
      if (document.webkitFullscreenElement) {
        watermark.style.display = 'block';
      }
    });
    document.addEventListener('msfullscreenchange', () => {
      if (document.msFullscreenElement) {
        watermark.style.display = 'block';
      }
    });

    // Initialize playlist on page load
    fetchPlaylist().then(() => {
      if (playlist.length > 0) {
        // Remove initial syncVideo call to avoid premature playback
        // Sync every 10 minutes for long-term alignment
        setInterval(() => {
          if (!isSyncing) {
            syncVideo();
          }
        }, 600000);
      } else {
        console.error("Failed to load playlist");
      }
    });
  </script>
</body>
</html>
