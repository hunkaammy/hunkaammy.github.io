<!DOCTYPE html>
<html lang="en" ng-app="myApp" ng-cloak>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hindustan Toys - Order Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <style>
    :root{
      --primary-color:#388e3c;
      --secondary-color:#0d6efd;
      --danger-color:#dc3545;
      --light-gray:#f8f9fa;
      --dark-gray:#333;
      --card-shadow:0 4px 12px rgba(0,0,0,0.08);
    }

    html,body{overscroll-behavior:none;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      font-size:14px;line-height:1.5;color:var(--dark-gray);background-color:var(--light-gray);margin:0;
      -webkit-tap-highlight-color:transparent;user-select:none;
    }
    [ng-cloak]{display:none!important;}

    /* Page containers */
    #content,#login-container{max-width:768px;margin:0 auto;box-sizing:border-box;}
    #login-container{
      background-size:cover;background-position:center;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;
    }
    #inside{
      background-color:rgba(255,255,255,0.95);padding:30px;border-radius:12px;box-shadow:var(--card-shadow);text-align:center;width:100%;max-width:360px;
    }

    /* Navbar */
    .navbar{
      background:#fff;padding:8px 15px;position:fixed;width:100%;max-width:768px;top:0;z-index:1030;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);left:50%;transform:translateX(-50%);
    }

    .page-title{font-size:18px;font-weight:600;}
    .section-container{background:#fff;border-radius:12px;box-shadow:var(--card-shadow);padding:2px;}

    /* Category cards */
    .category-grid-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:12px;}
    .category-card{
      background:#fff;border-radius:12px;box-shadow:var(--card-shadow);padding:12px;text-align:center;cursor:pointer;
      transition:transform .2s ease,box-shadow .2s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;height:110px;
    }
    .category-card:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(0,0,0,0.12);}
    .category-card img{width:60%;height:auto;object-fit:contain;margin-bottom:8px;border-radius:8px;}
    .category-card span{font-size:11px;font-weight:500;color:#555;}

    /* Product grid default layout (used by main product content) */
    .product-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}

    .card{
      box-shadow:var(--card-shadow);width:100%;border-radius:8px;text-align:center;background:#fff;overflow:hidden;padding-bottom:8px;
      display:flex;flex-direction:column;align-items:stretch;
    }

    /* Full image (no cropping), preserve aspect ratio */
    .card img{
      width:100%;height:auto;max-height:240px;object-fit:contain;display:block;margin:0 auto;background:#fff;
    }

    .containers{padding:8px;position:relative;flex:0 0 auto;}
    .containers h4{margin:0 0 4px;font-size:13px;font-weight:bold;}
    .containers p{margin:0 0 4px;white-space:normal;overflow:visible;text-overflow:initial;font-size:11px;}
    .containers a.watch-video{font-size:11px;color:var(--secondary-color);cursor:pointer;}

    .qtyclass{height:32px;width:50px;margin-right:5px;font-size:12px;border-radius:6px;border:1px solid #ced4da;text-align:center;}
    .saved-feedback{color:var(--primary-color);font-size:10px;font-weight:700;position:absolute;top:8px;right:8px;animation:fadeOut 2s forwards;}
    @keyframes fadeOut{from{opacity:1}to{opacity:0}}

    .enlarged-image-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1060;cursor:pointer;}
    .enlarged-image-content{max-width:95%;max-height:95%;border-radius:8px;object-fit:contain;}

    /* Skeleton */
    @keyframes skeleton-pulse{0%{background:#e0e0e0}50%{background:#f0f0f0}100%{background:#e0e0e0}}
    .skeleton-card{background:#fff;padding:0;}
    .skeleton-image{width:100%;height:140px;animation:skeleton-pulse 1.5s infinite;}
    .skeleton-line{height:12px;width:90%;margin:8px auto;border-radius:4px;animation:skeleton-pulse 1.5s infinite;}
    .skeleton-line.short{width:60%;}

    /* Order list */
    .order-item-img{width:50px;height:50px;object-fit:contain;border-radius:4px;margin-right:15px;background:#fff;}
    .qty-control{display:flex;align-items:center;}
    .qty-display{width:40px;text-align:center;font-weight:700;font-size:16px;}

    /* Manual slideshow helper */
    .manual-slideshow-scroll-wrapper{display:flex;flex-wrap:nowrap;overflow-x:auto!important;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;padding-bottom:10px;gap:12px;scrollbar-width:none;-ms-overflow-style:none;}
    .manual-slideshow-scroll-wrapper::-webkit-scrollbar{display:none;}
    .manual-slideshow-scroll-wrapper .card{flex-shrink:0;width:150px;scroll-snap-align:start;}
    .manual-slideshow-scroll-wrapper .card img{width:100%;height:auto;max-height:140px;object-fit:contain;background:#fff;}

    .view-all-container{text-align:right;padding:0 12px 12px;}
    .view-all-button{display:inline-block;color:black;border:none;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:background-color .2s ease;}

    /* Video modal */
    .video-modal-content{max-width:90%;max-height:90vh;margin:auto;display:flex;flex-direction:column;align-items:center;}
    .video-modal-content video{width:100%;max-height:70vh;border-radius:8px;}
    .video-modal-content .download-btn{margin-top:10px;padding:8px 16px;background:var(--primary-color);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;}
    .video-modal-content .download-btn:hover{background:#2e7d32;}
    .video-error{color:var(--danger-color);font-size:12px;margin-top:10px;text-align:center;}
    #videoModal{z-index:1060;}

    .search-results-container{max-width:768px;margin:0 auto;box-sizing:border-box;}
    .modal-dialog{max-width:768px;margin:1.75rem auto;}

    /* Sticky header inside product modal */
    #productModal .modal-header{position:sticky;top:0;background:#fff;z-index:1050;padding:10px 15px;border-bottom:1px solid #dee2e6;display:flex;align-items:center;justify-content:space-between;flex-wrap:nowrap;}
    #productModal .modal-title{margin:0;font-size:18px;font-weight:600;flex-grow:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    #productModal .sort-container{flex-shrink:0;margin-left:10px;}
    #productModal .form-select-sm{width:auto;min-width:120px;font-size:12px;padding:4px 8px;}
    #productModal .btn-close{flex-shrink:0;margin-left:10px;}
    #productModal .modal-body{padding-top:10px;}

    /* Fixed Your Order Button */
    .fixed-order-button{
      position:fixed;bottom:20px;right:20px;z-index:1070;background:var(--primary-color);color:#fff;border:none;border-radius:50px;padding:8px 12px;font-size:12px;font-weight:500;box-shadow:var(--card-shadow);cursor:pointer;transition:background .2s ease,transform .2s ease;
    }
    .fixed-order-button:hover{background:#2e7d32;transform:scale(1.05);}

    /* Layout: sidebar + products */
    .main-content-layout{display:flex;gap:20px;max-width:768px;margin:0 auto;min-height:calc(100vh - 70px);}
    .sidebar-container{
      flex-shrink:0;width:180px;background:linear-gradient(135deg,#f8f9fa 0%,#fff 100%);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.1);
      padding:20px 12px;position:sticky;top:80px;align-self:flex-start;max-height:calc(100vh - 110px);overflow-y:auto;
    }
    .sidebar-title{font-size:16px;font-weight:600;margin:0 0 20px;padding:0 10px;color:var(--dark-gray);}
    .vertical-tabs{display:flex;flex-direction:column;gap:10px;}
    .tab-item{
      display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px 10px;border-radius:12px;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);
      gap:8px;border:2px solid transparent;text-align:center;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.05);position:relative;
    }
    .tab-item:hover{background:linear-gradient(135deg,#f0f4f8 0%,#e8eff5 100%);transform:translateY(-2px) scale(1.02);box-shadow:0 4px 12px rgba(56,142,60,0.15);border-color:rgba(56,142,60,0.2);}
    .tab-item.active{background:linear-gradient(135deg,var(--primary-color) 0%,#2e7d32 100%);color:#fff;border-color:var(--primary-color);box-shadow:0 6px 16px rgba(56,142,60,0.3);transform:scale(1.03);}
    .tab-icon-img{width:32px;height:32px;object-fit:contain;border-radius:8px;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,0.1);background:#fff;}
    .tab-text{font-size:11px;font-weight:500;color:var(--dark-gray);word-break:break-word;text-align:center;line-height:1.3;width:100%;}
    .tab-count{font-size:9px;color:var(--dark-gray);opacity:.8;font-weight:500;margin-top:-2px;}

    .products-container{flex:1;min-width:0;}
    .products-header{background:#fff;padding:15px;border-radius:12px;box-shadow:var(--card-shadow);margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
    .products-title{margin:0;font-size:18px;font-weight:600;color:var(--dark-gray);}
    .products-content{background:#fff;padding:15px;border-radius:12px;box-shadow:var(--card-shadow);}

    /* Responsive breakpoints */
    @media (max-width: 767.98px){
      /* Main layout becomes narrower; keep sidebar compact */
      .main-content-layout{flex-direction:row;gap:10px;padding:0 5px 20px;}
      .sidebar-container{width:95px;padding:12px 8px;position:sticky;top:0;max-height:calc(100vh - 70px);overflow-y:auto;}
      .sidebar-title{font-size:13px;margin-bottom:12px;}
      .vertical-tabs{gap:8px;}
      .tab-item{padding:10px 6px;gap:6px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,0.06);}
      .tab-icon-img{width:40px;height:40px;border-radius:6px;}
      .tab-text{font-size:10px;line-height:1.2;}
      .products-header{padding:10px;margin-bottom:10px;}
      .products-title{font-size:16px;}
      .products-content{padding:10px;}
      .containers h4{font-size:14px;}
      .containers p{font-size:12px;}
      .qtyclass{height:36px;width:60px;font-size:13px;}
      .order-item-img{width:60px;height:60px;}
      .manual-slideshow-scroll-wrapper .card{width:220px;min-width:220px;}

      /* MAIN product area becomes single column on small screens (original behavior) */
      .main-content-layout .product-grid{grid-template-columns:1fr;}
    }

    /* Search results should always be 2 columns (targeted, high specificity so it doesn't affect main area) */
    .search-results-container .product-grid{
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }

    /* Tweak for very small phones */
    @media (max-width:420px){
      .manual-slideshow-scroll-wrapper .card{width:180px;min-width:180px;}
      .tab-icon-img{width:36px;height:36px;}
      .tab-text{font-size:9px;}
      .qtyclass{width:56px;height:34px;}
      .card img{max-height:200px;}
      .search-results-container .product-grid{gap:8px;}
    }

    /* small performance/visual tweaks */
    .card img,.category-card img,.tab-icon-img{image-rendering:auto;-webkit-backface-visibility:hidden;backface-visibility:hidden;}
    .fixed-order-button{position:fixed;bottom:20px;right:20px;z-index:1070;}
  </style>
</head>
<body ng-controller="imagesController as vm">
  <!-- LOGIN -->
  <div id="login-container" style="background-image: url('https://hunkaammy.github.io/mywebsite/NEWWEBSITE/loginpg.jpeg');">
    <div id="inside">
      <h2 class="mb-4">HINDUSTAN TOYS</h2>
      <input type="text" id="name" placeholder="Enter your shop name" class="form-control mb-2" autocomplete="off">
      <input type="tel" id="mobile" placeholder="Enter your mobile number" class="form-control mb-3" autocomplete="off">
      <button class="btn btn-success w-100" onclick="validateLogin()">Login</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div id="content" style="display:none;">
    <div class="navbar">
      <div class="d-flex w-100 align-items-center">
        <div class="input-group input-group-sm me-2">
          <input type="text" ng-model="searchQuery" ng-change="onSearchChange()" ng-model-options="{ debounce: 400 }" placeholder="Search all products..." class="form-control" />
          <span class="input-group-text"><i class="fas fa-search"></i></span>
        </div>
        <div class="dropdown">
          <button class="btn btn-light btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-bars"></i></button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#myModal">Your Order</a></li>
            <li><a class="dropdown-item" href="#" ng-click="logout()">Logout</a></li>
          </ul>
        </div>
      </div>
      <div class="d-flex w-100 justify-content-center align-items-center mt-1">
        <small class="text-muted me-3">Welcome, {{dynamicField2Value}}</small>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="priceToggle" ng-model="priceVisible" ng-change="togglePriceVisibility()">
        </div>
      </div>
    </div>

    <!-- Fixed Your Order Button -->
    <button class="fixed-order-button" ng-if="dynamicField2Value && !isOrderModalOpen && !isEnlargedImageOpen" ng-click="openOrderModal()">
      <i class="fas fa-shopping-cart me-1"></i>Your Order
    </button>

    <!-- SEARCH RESULTS (keeps 2-up layout always) -->
    <div class="search-results-container p-3" ng-if="isSearching">
      <h2 class="page-title">Search Results for "{{ searchQuery }}"</h2>

      <div ng-if="isLoadingSearchResults" class="product-grid">
        <div class="card skeleton-card" ng-repeat="i in [1,2,3,4]">
          <div class="skeleton-image"></div>
          <div class="containers">
            <div class="skeleton-line short"></div>
            <div class="skeleton-line"></div>
          </div>
        </div>
      </div>

      <div ng-if="!isLoadingSearchResults">
        <div class="product-grid">
          <div class="card" ng-repeat="product in searchResults">
            <img ng-src="{{product.url}}" alt="{{product.name}}" ng-click="showEnlargedImage(product.url)" loading="lazy"/>
            <div class="containers">
              <span class="saved-feedback" ng-if="product.justSaved">Saved!</span>
              <h4 ng-if="priceVisible"><b>{{product.price | currency:'₹':0}}</b></h4>
              <p>{{product.name}}</p>
              <p ng-if="product.videourl"><a href="#" class="watch-video" ng-click="showVideoModal($event, product.videourl, false)">Watch Video</a></p>
              <input type="number" class="qtyclass" placeholder="Qty" ng-model="product.field3" ng-change="submitData(product)" ng-model-options="{ debounce: 800 }"/>
            </div>
          </div>
        </div>
        <div ng-if="searchResults.length === 0" class="text-center p-5"><p class="text-muted">No products found matching your search.</p></div>
      </div>
    </div>

    <!-- MAIN LAYOUT (sidebar + products) -->
    <div ng-if="!isSearching" class="main-content-layout">
      <div class="sidebar-container">
        <div class="vertical-tabs">
          <div class="tab-loading" ng-if="isLoadingCategories">
            <div class="skeleton-tab" ng-repeat="i in [1,2,3,4,5,6,7,8]">
              <div class="tab-icon" style="width:24px;height:24px;background:#e0e0e0;border-radius:4px;"></div>
              <div class="tab-text" style="height:12px;width:60%;background:#e0e0e0;border-radius:4px;"></div>
            </div>
          </div>

          <div class="tab-item" ng-if="!isLoadingCategories" ng-class="{'active': activeTabId === category.id}" ng-click="selectCategory(category.filter, category.id)" ng-repeat="category in categories">
            <img ng-src="{{category.imageUrl}}" alt="{{category.name}}" class="tab-icon-img"/>
            <span class="tab-text">{{category.name}}</span>
            <small class="tab-count" ng-if="category.productCount > 0">({{category.productCount}})</small>
          </div>
        </div>
      </div>

      <div class="products-container">
        <div class="products-header">
          <select ng-model="sortOrder" ng-change="updateDisplayedProducts()" class="form-select form-select-sm">
            <option value="default">Sort: Newest</option>
            <option value="price">Sort: Price Low</option>
            <option value="-price">Sort: Price High</option>
          </select>
        </div>

        <div class="products-content">
          <div ng-if="isLoading" class="product-grid">
            <div class="card skeleton-card" ng-repeat="i in [1,2,3,4,5,6]">
              <div class="skeleton-image"></div>
              <div class="containers">
                <div class="skeleton-line short"></div>
                <div class="skeleton-line"></div>
              </div>
            </div>
          </div>

          <div ng-if="!isLoading">
            <div class="product-grid">
              <div class="card" ng-repeat="product in displayedProducts" ng-hide="product.markedForRemoval">
                <img ng-src="{{product.url}}" alt="{{product.name}}" ng-click="showEnlargedImage(product.url, false)" loading="lazy"/>
                <button ng-if="dynamicField2Value === 'sammyadmin'" class="btn btn-danger btn-sm mt-2 mx-2" ng-click="markOutOfStock(product)">Mark Out of Stock</button>
                <div class="containers">
                  <span class="saved-feedback" ng-if="product.justSaved">Saved!</span>
                  <h4 ng-if="priceVisible"><b>{{product.price | currency:'₹':0}}</b></h4>
                  <p>{{product.name}}</p>
                  <p ng-if="product.videourl"><a href="#" class="watch-video" ng-click="showVideoModal($event, product.videourl, false)">Watch Video</a></p>
                  <input type="number" class="qtyclass" placeholder="Qty" ng-model="product.field3" ng-change="submitData(product)" ng-model-options="{ debounce: 800 }"/>
                </div>
              </div>
            </div>

            <div ng-if="displayedProducts.length === 0" class="text-center p-5">
              <p class="text-muted">No products found.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRODUCT MODAL -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-uppercase">{{ activeCategoryName }}</h5>
          <div class="sort-container">
            <select ng-model="sortOrder" ng-change="updateDisplayedProducts()" class="form-select form-select-sm">
              <option value="default">Sort: Newest</option>
              <option value="price">Sort: Price Low</option>
              <option value="-price">Sort: Price High</option>
            </select>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div ng-if="isLoading" class="product-grid"></div>
          <div ng-if="!isLoading">
            <div class="product-grid">
              <div class="card" ng-repeat="image in displayedProducts" ng-hide="image.markedForRemoval">
                <img ng-src="{{image.url}}" alt="{{image.name}}" ng-click="showEnlargedImage(image.url, true)" loading="lazy"/>
                <button ng-if="dynamicField2Value === 'sammyadmin'" class="btn btn-danger btn-sm mt-2 mx-2" ng-click="markOutOfStock(image)">Mark Out of Stock</button>
                <div class="containers">
                  <span class="saved-feedback" ng-if="image.justSaved">Saved!</span>
                  <h4 ng-if="priceVisible"><b>{{image.price | currency:'₹':0}}</b></h4>
                  <p>{{image.name}}</p>
                  <p ng-if="image.videourl"><a href="#" class="watch-video" ng-click="showVideoModal($event, image.videourl, true)">Watch Video</a></p>
                  <input type="number" class="qtyclass" placeholder="Qty" ng-model="image.field3" ng-change="submitData(image)" ng-model-options="{ debounce: 800 }"/>
                </div>
              </div>
            </div>

            <div ng-if="!isLoading && displayedProducts.length === 0" class="text-center p-5">
              <p class="text-muted">No products found.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIDEO MODAL -->
  <div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content video-modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Product Video</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" ng-click="closeVideoModal()"></button>
        </div>
        <div class="modal-body">
          <video controls autoplay id="videoPlayer">
            <source ng-src="{{currentVideoUrl}}" type="video/mp4"/>
            Your browser does not support the video tag.
          </video>
          <p class="video-error" ng-if="videoError">{{videoError}}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ENLARGED IMAGE OVERLAY -->
  <div id="enlarged-image-overlay" class="enlarged-image-overlay" ng-click="closeEnlargedImage()">
    <img class="enlarged-image-content" id="enlarged-image" src=""/>
  </div>

  <!-- ORDER MODAL -->
  <div class="modal fade" id="myModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{dynamicField2Value}}'s Order List</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center" ng-repeat="item in allOrders | filter:{field2: dynamicField2Value}:true | orderBy:'-serverTimestamp'">
              <div class="d-flex align-items-center">
                <img ng-src="{{item.field1}}" class="order-item-img"/>
                <div>
                  <div class="fw-bold">{{item.productName}}</div>
                  <small class="text-muted" ng-if="priceVisible">{{item.productPrice | currency:'₹':0}}</small>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <div class="qty-control">
                  <button class="btn btn-secondary btn-sm" ng-click="decrementOrderItem(item)">-</button>
                  <span class="qty-display">{{item.field3}}</span>
                  <button class="btn btn-secondary btn-sm" ng-click="incrementOrderItem(item)">+</button>
                </div>
                <button class="btn btn-outline-danger btn-sm ms-3" ng-click="deleteOrderItem(item)"><i class="fas fa-trash"></i></button>
              </div>
            </li>
          </ul>
          <div ng-if="(allOrders | filter:{field2: dynamicField2Value}:true).length === 0" class="text-center p-5"><p class="text-muted">You have not ordered any items yet.</p></div>
        </div>
        <div class="modal-footer">
          <strong class="me-auto" ng-if="priceVisible">Total: {{ calculateOrderTotal() | currency:'₹':0 }}</strong>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.firebase.com/libs/angularfire/2.3.0/angularfire.min.js"></script>

  <script>
    // Global flag to track if enlarged image is open
    var isEnlargedImageOpen = false;

    // Global error handler
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Script Error:', {message, source, lineno, colno, error});
      alert('An error occurred. Please try refreshing the page.');
      return true;
    };

    // Back button control (preserve your behavior)
    history.pushState({ state: 'home' }, null, location.href);
    window.addEventListener('popstate', function (event) {
      try {
        var productModalEl = document.getElementById('productModal');
        var orderModalEl = document.getElementById('myModal');
        var videoModalEl = document.getElementById('videoModal');
        var enlargedOverlayEl = document.getElementById('enlarged-image-overlay');

        var productModal = bootstrap.Modal.getInstance(productModalEl);
        var orderModal = bootstrap.Modal.getInstance(orderModalEl);
        var videoModal = bootstrap.Modal.getInstance(videoModalEl);
        var scope = angular.element(document.body).scope();

        if (!scope) { console.error('Angular scope not found'); return; }

        scope.$applyAsync(function() {
          if (isEnlargedImageOpen && enlargedOverlayEl && enlargedOverlayEl.style.display === 'flex') {
            scope.closeEnlargedImage();
            isEnlargedImageOpen = false;
            if (productModal && productModalEl.classList.contains('show')) history.pushState({ state: 'productModal' }, null, location.href);
            else history.pushState({ state: 'home' }, null, location.href);
            return;
          }
          if (productModal && productModalEl.classList.contains('show')) { productModal.hide(); scope.isProductModalOpen = false; history.pushState({ state: 'home' }, null, location.href); return; }
          if (videoModal && videoModalEl.classList.contains('show')) {
            scope.closeVideoModal();
            if (event.state && event.state.fromProductModal && productModal && productModalEl.classList.contains('show')) history.pushState({ state: 'productModal' }, null, location.href);
            else history.pushState({ state: 'home' }, null, location.href);
            return;
          }
          if (orderModal && orderModalEl.classList.contains('show')) { orderModal.hide(); history.pushState({ state: 'home' }, null, location.href); return; }
          if (scope.isSearching || (scope.searchQuery && scope.searchQuery.length > 0)) {
            scope.searchQuery = ''; scope.isSearching = false; scope.onSearchChange(); history.pushState({ state: 'home' }, null, location.href); return;
          }
          history.pushState({ state: 'home' }, null, location.href);
        });
      } catch (e) { console.error('Popstate error:', e); }
    });

    document.getElementById('enlarged-image-overlay').addEventListener('transitionend', function() {
      isEnlargedImageOpen = this.style.display === 'flex';
    });

    /* LOGIN (unchanged) */
    (function(){
      var loginConfig = {
        apiKey: "AIzaSyAr8dYBz_D1DVnGfT_fQhTwD1YmtTvuzMk",
        authDomain: "shop-reminder-3ce10.firebaseapp.com",
        databaseURL: "https://shop-reminder-3ce10-default-rtdb.firebaseio.com",
      };
      var blockedNumbers = ['7000913701','9846434664','8269731362','9876543210','9123456789','8987854256','9039199794','9166220046','8269731352','6263821242','6616495946','6266242180','9109390639','9658695825','8576911011'];
      var blockedPageUrl = 'https://www.hindustantoys.in/mywebsite/NEWWEBSITE/blocked.html';

      try {
        var loginApp = firebase.apps.find(app => app.name === 'loginApp') || firebase.initializeApp(loginConfig, 'loginApp');
        var loginDb = loginApp.database();

        window.validateLogin = function(){
          try {
            var nameInput = document.getElementById('name');
            var mobileInput = document.getElementById('mobile');
            var name = nameInput.value.trim();
            var mobile = mobileInput.value.trim();

            if (blockedNumbers.includes(mobile)) { window.location.href = blockedPageUrl; return; }
            if (name.length < 4 || !/^[6-9]\d{9}$/.test(mobile)) { alert('Please enter valid details.'); return; }

            loginDb.ref('users').push({ name: name, mobile: mobile, timestamp: firebase.database.ServerValue.TIMESTAMP }).then(function(){
              localStorage.setItem('name', name);
              localStorage.setItem('mobile', mobile);
              showContent(name);
            }).catch(function(e){ console.error("Login Firebase Error:", e); alert('Login failed. Please try again.'); });
          } catch (e) { console.error("Validate Login Error:", e); alert('An error occurred during login.'); }
        };

        function showContent(name){
          try {
            var scope = angular.element(document.body).scope();
            if (scope) scope.$applyAsync(function(){ scope.dynamicField2Value = name; });
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            history.pushState({ state: 'home' }, null, location.href);
          } catch (e) { console.error("Show Content Error:", e); }
        }

        function checkAuthentication(){
          try {
            var name = localStorage.getItem('name');
            var mobile = localStorage.getItem('mobile');
            if (mobile && blockedNumbers.includes(mobile)) { window.location.href = blockedPageUrl; return; }
            if (name && mobile) {
              document.getElementById('name').value = name;
              document.getElementById('mobile').value = mobile;
              loginDb.ref('users').push({ name: name, mobile: mobile, timestamp: firebase.database.ServerValue.TIMESTAMP, loginType: 'auto' }).catch(e => console.error("Auto-login Firebase Error:", e));
              showContent(name);
            }
          } catch (e) { console.error("Check Authentication Error:", e); }
        }
        checkAuthentication();
      } catch (e) { console.error("Firebase Initialization Error:", e); alert('Failed to initialize application. Please check your network and try again.'); }
    })();

    /* ANGULAR CONTROLLER (keeps functionality) */
    var app = angular.module('myApp', ['firebase']);
    app.controller('imagesController', ['$scope', '$firebaseArray', '$filter', '$window', '$timeout', '$sce', function($scope, $firebaseArray, $filter, $window, $timeout, $sce){
      try {
        var vm = this; vm.images = [];
        $scope.displayedProducts = []; $scope.sortOrder = 'default';
        $scope.dynamicField2Value = localStorage.getItem('name') || '';
        $scope.priceVisible = localStorage.getItem('priceVisible') !== 'false';
        $scope.isOrderModalOpen = false; $scope.isEnlargedImageOpen = false;
        $scope.isLoading = true; $scope.isLoadingCategories = true;
        $scope.isSearching = false; $scope.searchResults = []; $scope.isLoadingSearchResults = false;
        $scope.currentVideoUrl = ''; $scope.videoError = ''; $scope.isProductModalOpen = false;

        var fetchConfig = { databaseURL: "https://htshop-e9c51-default-rtdb.firebaseio.com" };
        var submitConfig = { databaseURL: "https://notes-12519-default-rtdb.firebaseio.com" };

        var fetchApp = firebase.apps.find(app => app.name === 'fetchApp') || firebase.initializeApp(fetchConfig, 'fetchApp');
        var fetchDb = fetchApp.database().ref();
        var submitApp = firebase.apps.find(app => app.name === 'submitApp') || firebase.initializeApp(submitConfig, 'submitApp');
        var submitDb = submitApp.database().ref();

        var productsListener = fetchDb.on('value', function(snapshot){
          const allData = [];
          snapshot.forEach(function(childSnapshot){ var item = childSnapshot.val(); item.$id = childSnapshot.key; allData.push(item); });
          vm.images = allData.filter(item => !item.outOfStock);
          $scope.$applyAsync(function(){
            angular.forEach($scope.categories, function(category){
              if (category.filter === '') category.productCount = vm.images.length;
              else category.productCount = $filter('filter')(vm.images, { name: category.filter }).length;
            });
            $scope.isLoading = false; $scope.isLoadingCategories = false;
            if (!$scope.activeTabId && $scope.activeTabId !== 0) $scope.activeTabId = 0;
            $scope.selectCategory($scope.categories.find(c => c.id === $scope.activeTabId)?.filter || '', $scope.activeTabId);
          });
        }, function(error){
          console.error("Error loading products:", error);
          $scope.$applyAsync(function(){ $scope.isLoading = false; $scope.isLoadingCategories = false; });
          alert('Failed to load products. Please check your network and try again.');
        });

        $scope.allOrders = $firebaseArray(submitDb);
        $scope.activeTabId = 0; $scope.activeCategoryName = 'ALL PRODUCTS';

        $scope.categories = [
          { id:0, name:'ALL PRODUCTS', filter:'', imageUrl:'https://www.hindustantoys.in/images/all.jpeg' },
          { id:6, name:'RACKET', filter:'RACKET', imageUrl:'https://www.hindustantoys.in/images/racket.jpeg' },
          { id:9, name:'MIX TOYS', filter:'MIX', imageUrl:'https://www.hindustantoys.in/images/mix.jpeg' },
          { id:39, name:'EDUCATIONAL TOYS', filter:'EDUCATIONAL', imageUrl:'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2025-08-23T08%3A21%3A08.778Z_KIDS%20EDUCATIONAL%20CALENDER%20(MIX)_cfb4fb41-e790-4b0a-8cbd-d0f33f1d392b.jpg?alt=media&token=97e8c36a-6efe-4812-a40a-f99ab08b7b09' },
          { id:41, name:'BATTERY CAR/JEEP', filter:'BATTERY CAR', imageUrl:'https://www.hindustantoys.in/images/Jeep.jpg' },
          { id:40, name:'BATTERY BIKES', filter:'BATTERY BIKE', imageUrl:'https://www.hindustantoys.in/images/bike.jpg' },
          { id:38, name:'UMBRELLA', filter:'UMBRELLA', imageUrl:'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2024-06-24T16%3A35%3A31.407Z_RAINBOW%20UMBRELLA_IMG-20240529-WA0047.jpg?alt=media&token=64ee5147-65c7-4de8-897d-55df6cb84857' },
          { id:10, name:'LUMO & OTHER', filter:'LUMO', imageUrl:'https://www.hindustantoys.in/images/lumo.jpeg' },
          { id:36, name:'BAT BALL & SET', filter:'BAT BALL', imageUrl:'https://www.hindustantoys.in/images/bat.jpeg' },
          { id:35, name:'CARROM BOARD', filter:'CARROM', imageUrl:'https://www.hindustantoys.in/images/carrom.jpeg' },
          { id:37, name:'SWINGS', filter:'SWING', imageUrl:'https://www.hindustantoys.in/images/swing.jpeg' },
          { id:3, name:'INDIAN TOYS', filter:'INDIAN TOYS', imageUrl:'https://www.hindustantoys.in/images/JCB.jpeg' },
          { id:13, name:'BATTERY OPERATED', filter:'BATTERY', imageUrl:'https://www.hindustantoys.in/images/battery.jpeg' },
          { id:34, name:'VALENTINES/TEDDY', filter:'TEDDY', imageUrl:'https://www.hindustantoys.in/images/TEDDY.jpg' },
          { id:31, name:'KITCHEN SETS', filter:'KITCHEN', imageUrl:'https://www.hindustantoys.in/images/KITCHEN.jpg' },
          { id:7, name:'REMOTE CAR', filter:'REMOTE', imageUrl:'https://www.hindustantoys.in/images/remote.jpeg' },
          { id:11, name:'MAGIC RIDDER', filter:'RIDDER', imageUrl:'https://www.hindustantoys.in/images/ridder.jpeg' },
          { id:25, name:'HIGH QUALITY', filter:'HIGH QUALITY', imageUrl:'https://www.hindustantoys.in/images/high.jpeg' },
          { id:30, name:'HT PRODUCTS', filter:'OWN', imageUrl:'https://www.hindustantoys.in/images/htquality.jpg' },
          { id:29, name:'PALNA', filter:'PALNA', imageUrl:'https://www.hindustantoys.in/images/palna.png' },
          { id:5, name:'WALKER', filter:'WALKER', imageUrl:'https://www.hindustantoys.in/images/walker.jpeg' },
          { id:28, name:'LUNCH BOX', filter:'LUNCH BOX', imageUrl:'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2025-07-01T08%3A45%3A26.021Z_LUNCH%20BOX_667798d8-2789-471f-985a-8605b19313b1.jpg?alt=media&token=bb3a00ab-a86c-43c5-9e10-d18f4a427451' },
          { id:27, name:'PENCIL BOX', filter:'PENCIL BOX', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:23, name:'WATER BOTTLE', filter:'BOTTLE', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:26, name:'BOARD GAME', filter:'BOARD GAME', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:22, name:'EDUCATIONAL', filter:'EDUCATIONAL', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:21, name:'BIG ITEMS', filter:'BIG', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:19, name:'TRICYCLES', filter:'TRICYCLE', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:18, name:'SPORTS ITEM', filter:'SPORTS', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:17, name:'PATTA ITEMS', filter:'PATTA', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:15, name:'GUNS VARIETY', filter:'GUN', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:1, name:'STATIONERY', filter:'STATIONERY', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:8, name:'DOLL', filter:'DOLL', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:12, name:'FANCY ITEMS', filter:'FANCY', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:14, name:'DOZEN PACKING', filter:'DOZEN', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:32, name:'GODOWN-1', filter:'G1', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:33, name:'GODOWN-2', filter:'G2', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id:16, name:'EMPTY', filter:'GUN', imageUrl:'https://www.hindustantoys.in/images/DUMMY.jpeg' }
        ];

        var productModal = null, videoModal = null;
        $timeout(function(){ try { productModal = new bootstrap.Modal(document.getElementById('productModal')); videoModal = new bootstrap.Modal(document.getElementById('videoModal')); } catch(e){ console.error("Modal init error", e); } }, 0);

        $scope.openOrderModal = function(){ try { var orderModalEl = document.getElementById('myModal'); var orderModal = bootstrap.Modal.getInstance(orderModalEl) || new bootstrap.Modal(orderModalEl); orderModal.show(); } catch(e){ console.error("Open order modal error", e); } };

        $scope.onSearchChange = function(){
          try {
            if ($scope.searchQuery && $scope.searchQuery.length > 0) {
              $scope.isSearching = true; $scope.isLoadingSearchResults = true; history.pushState({ state: 'search' }, null, location.href);
              $timeout(function(){ $scope.searchResults = $filter('filter')(vm.images, { name: $scope.searchQuery }) || []; $scope.isLoadingSearchResults = false; }, 100);
            } else { $scope.isSearching = false; $scope.searchResults = []; history.pushState({ state: 'home' }, null, location.href); }
          } catch (e) { console.error("Search Change Error:", e); $scope.isSearching = false; $scope.isLoadingSearchResults = false; }
        };

        $scope.selectCategory = function(filter, tabId){ try { $scope.searchQuery = ''; $scope.isSearching = false; $scope.productNameFilter = filter; $scope.activeCategoryName = $scope.categories.find(c => c.id === tabId)?.name || 'Products'; $scope.activeTabId = tabId; $scope.updateDisplayedProducts(); $timeout(function(){ window.scrollTo(0,0); },0); } catch(e){ console.error("Select Category Error:", e); } };

        $scope.setTab = function(filter, tabId){ try { $scope.searchQuery = ''; $scope.isSearching = false; $scope.productNameFilter = filter; $scope.activeCategoryName = $scope.categories.find(c => c.id === tabId)?.name || 'Products'; $scope.updateDisplayedProducts(); $scope.isProductModalOpen = true; history.pushState({ state: 'productModal' }, null, location.href); if (productModal) productModal.show(); } catch(e){ console.error("Set Tab Error:", e);} };

        $scope.togglePriceVisibility = function(){ try { localStorage.setItem('priceVisible', $scope.priceVisible); } catch(e){ console.error("Toggle Price Visibility Error:", e); } };

        $scope.incrementOrderItem = function(item){ try { if(item){ item.field3 = parseInt(item.field3 || 0) + 1; $scope.allOrders.$save(item).catch(e=>console.error("Inc error",e)); } } catch(e){ console.error("Increment error",e); } };
        $scope.decrementOrderItem = function(item){ try { if(item){ var newQty = parseInt(item.field3 || 0) - 1; if(newQty < 1) newQty = 1; item.field3 = newQty; $scope.allOrders.$save(item).catch(e=>console.error("Dec error",e)); } } catch(e){ console.error("Decrement error",e); } };
        $scope.deleteOrderItem = function(item){ try { if(item) $scope.allOrders.$remove(item).catch(e=>console.error("Delete error",e)); } catch(e){ console.error("Delete error",e); } };

        $scope.calculateOrderTotal = function(){ try { var total = 0; if(!$scope.allOrders) return 0; for(var i=0;i<$scope.allOrders.length;i++){ var item = $scope.allOrders[i]; if(item.field2 === $scope.dynamicField2Value) total += (parseFloat(item.productPrice)||0) * (parseInt(item.field3)||0); } return total; } catch(e){ console.error("Calc total error",e); return 0; } };

        $scope.markOutOfStock = function(image){ try { if(!image || !image.$id || image.markedForRemoval) return; image.markedForRemoval = true; var itemRef = fetchDb.child(image.$id); itemRef.update({ outOfStock:true, lastModified: firebase.database.ServerValue.TIMESTAMP }).then(function(){ $timeout(function(){ const masterIndex = vm.images.findIndex(i=>i.$id===image.$id); if(masterIndex>-1) vm.images.splice(masterIndex,1); const displayIndex = $scope.displayedProducts.findIndex(p=>p.$id===image.$id); if(displayIndex>-1) $scope.displayedProducts.splice(displayIndex,1); },200); }).catch(function(error){ console.error("Error marking out of stock:", error); alert("An error occurred: " + error.message); image.markedForRemoval = false; }); } catch(e){ console.error("Mark out error",e); } };

        $scope.submitData = function(image){ try { if(!image) return; var baseId = image.$id || image.name.replace(/[^a-zA-Z0-9]/g,''); var uniqueId = $scope.dynamicField2Value.replace(/[^a-zA-Z0-9]/g,'') + '-' + baseId; var recordRef = submitDb.child(uniqueId); if(!image.field3 || image.field3 <= 0){ recordRef.remove().catch(e=>console.error("Remove order error",e)); return; } const now = new Date(); const date = now.toLocaleDateString('en-IN',{day:'2-digit',month:'2-digit',year:'numeric'}); const time = now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true}).toUpperCase(); var dataToSubmit = { field1: image.url, field2: $scope.dynamicField2Value, field3: image.field3, productName: image.name, productPrice: image.price, serverTimestamp: firebase.database.ServerValue.TIMESTAMP, submitDate: date, submitTime: time }; recordRef.set(dataToSubmit).then(function(){ image.justSaved = true; $timeout(()=>{ image.justSaved = false; },2000); }).catch(function(error){ console.error("Error submitting data:", error); alert("Could not save order: " + error.message); }); } catch(e){ console.error("Submit data error",e); } };

        $scope.showEnlargedImage = function(src, fromProductModal){ try { const overlay = document.getElementById('enlarged-image-overlay'); if(overlay){ overlay.style.display = 'flex'; overlay.querySelector('img').src = src || ''; isEnlargedImageOpen = true; $scope.isEnlargedImageOpen = true; $scope.$applyAsync(); history.pushState({ state: 'enlargedImage', fromProductModal: !!fromProductModal }, null, location.href); } } catch(e){ console.error("Show enlarged error",e); } };

        $scope.closeEnlargedImage = function(){ try { const overlay = document.getElementById('enlarged-image-overlay'); if(overlay){ overlay.style.display = 'none'; isEnlargedImageOpen = false; $scope.isEnlargedImageOpen = false; $scope.$applyAsync(); var productModalEl = document.getElementById('productModal'); var productModal = bootstrap.Modal.getInstance(productModalEl); if(productModal && productModalEl.classList.contains('show')) history.pushState({ state: 'productModal' }, null, location.href); else history.pushState({ state: 'home' }, null, location.href); } } catch(e){ console.error("Close enlarged error",e); } };

        $scope.showVideoModal = function(event, videourl, fromProductModal){ try { if(event){ event.preventDefault(); event.stopPropagation(); } $scope.videoError = ''; if(videourl){ $scope.currentVideoUrl = $sce.trustAsResourceUrl(videourl); history.pushState({ state: 'videoModal', fromProductModal: fromProductModal }, null, location.href); if(videoModal) videoModal.show(); $timeout(function(){ var videoElement = document.getElementById('videoPlayer'); if(videoElement){ videoElement.load(); videoElement.onerror = function(){ $scope.$applyAsync(function(){ $scope.videoError = 'Error loading video. Please check the URL or try again later.'; console.error('Video playback error:', videourl); }); }; videoElement.onloadeddata = function(){ console.log('Video loaded successfully:', videourl); }; } },0); } else { $scope.videoError = 'No video URL provided.'; console.error('No video URL provided'); } } catch(e){ console.error("Show video modal error",e); } };

        $scope.closeVideoModal = function(){ try { var videoElement = document.getElementById('videoPlayer'); if(videoElement){ videoElement.pause(); videoElement.currentTime = 0; } if(videoModal) videoModal.hide(); $scope.currentVideoUrl = ''; $scope.videoError = ''; var productModalEl = document.getElementById('productModal'); var productModal = bootstrap.Modal.getInstance(productModalEl); if(productModal && productModalEl.classList.contains('show')) history.pushState({ state: 'productModal' }, null, location.href); else history.pushState({ state: 'home' }, null, location.href); } catch(e){ console.error("Close video modal error",e); } };

        $scope.updateDisplayedProducts = function(){ try { if($scope.isLoading || !$scope.dynamicField2Value) return; let filteredImages = vm.images; if($scope.productNameFilter) filteredImages = $filter('filter')(vm.images, { name: $scope.productNameFilter }) || []; if($scope.searchQuery && !$scope.productNameFilter) filteredImages = $filter('filter')(filteredImages, { name: $scope.searchQuery }) || []; if($scope.sortOrder === 'price') filteredImages = $filter('orderBy')(filteredImages, 'price'); else if($scope.sortOrder === '-price') filteredImages = $filter('orderBy')(filteredImages, '-price'); else filteredImages = $filter('orderBy')(filteredImages, '-date'); $scope.displayedProducts = filteredImages; } catch(e){ console.error("Update displayed products error",e); } };

        $scope.logout = function(){ try { fetchDb.off('value', productsListener); localStorage.clear(); $window.location.reload(); } catch(e){ console.error("Logout error",e); } };

        // Modal listeners (keep behavior)
        $timeout(function(){ try {
          var productModalEl = document.getElementById('productModal');
          if(productModalEl){
            productModalEl.addEventListener('show.bs.modal', function(){ $scope.$applyAsync(function(){ $scope.isProductModalOpen = true; }); });
            productModalEl.addEventListener('hide.bs.modal', function(){ $scope.$applyAsync(function(){ $scope.isProductModalOpen = false; history.pushState({ state: 'home' }, null, location.href); }); });
          }
          var videoModalEl = document.getElementById('videoModal');
          if(videoModalEl){
            videoModalEl.addEventListener('show.bs.modal', function(){ var productModalEl = document.getElementById('productModal'); if($scope.isProductModalOpen && productModalEl.classList.contains('show')){ document.body.classList.add('modal-open'); var backdrop = document.querySelector('.modal-backdrop'); if(backdrop) backdrop.style.display = 'block'; } });
            videoModalEl.addEventListener('hide.bs.modal', function(){ var productModalEl = document.getElementById('productModal'); if($scope.isProductModalOpen && productModalEl.classList.contains('show')){ productModalEl.style.display = 'block'; document.body.classList.add('modal-open'); if(!document.querySelector('.modal-backdrop')){ var backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop fade show'; document.body.appendChild(backdrop); } } });
          }
          var orderModalEl = document.getElementById('myModal');
          if(orderModalEl){
            orderModalEl.addEventListener('show.bs.modal', function(){ $scope.$applyAsync(function(){ $scope.isOrderModalOpen = true; }); });
            orderModalEl.addEventListener('hide.bs.modal', function(){ $scope.$applyAsync(function(){ $scope.isOrderModalOpen = false; }); });
          }
        } catch(e){ console.error("Modal listeners error", e); } }, 0);

      } catch (e) { console.error("Controller init error", e); alert('Application initialization failed. Please refresh the page.'); }
    }]);
  </script>
</body>
</html>
