<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YT Music Player</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: #ffffff;
        }
        .main-wrapper {
            background-color: #181818;
            max-width: 800px;
            width: 100%;
            margin: 20px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
        }
        h1 {
            text-align: center;
            color: #1db954;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        #search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            align-items: center;
        }
        #query {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 1em;
            background-color: #282828;
            color: #ffffff;
            transition: border-color 0.3s ease;
        }
        #query:focus {
            border-color: #1db954;
            outline: none;
        }
        button {
            padding: 12px 20px;
            background-color: #1db954;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            background-color: #1ed760;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        #results {
            list-style: none;
            padding: 0;
            margin-top: 0;
            border: 1px solid #333;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            background-color: #282828;
        }
        #results li {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease;
        }
        #results li:last-child {
            border-bottom: none;
        }
        #results li:hover {
            background-color: #373737;
        }
        #results li span {
            flex: 1;
            color: #ffffff;
        }
        #results li img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            object-fit: cover;
        }
        #results li button {
            padding: 8px 14px;
            font-size: 0.9em;
            border-radius: 6px;
            background-color: #1db954;
        }
        #player-container {
            margin-top: 30px;
            padding: 20px;
            background: #181818;
            border-radius: 10px;
            border: 1px solid #333;
            text-align: center;
        }
        #album-art {
            width: 300px;
            height: 300px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin: 0 auto 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        #now-playing {
            margin-bottom: 15px;
            font-weight: bold;
            color: #ffffff;
            font-size: 1.1em;
        }
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .controls button {
            background: none;
            border: 1px solid #b3b3b3;
            color: #b3b3b3;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .controls button:hover {
            border-color: #ffffff;
            color: #ffffff;
        }
        #play-pause {
            background-color: #1db954;
            border-color: #1db954;
            color: white;
            font-size: 1.2em;
        }
        .progress-container {
            background-color: #333;
            height: 4px;
            border-radius: 2px;
            margin: 0 20px;
            cursor: pointer;
        }
        #progress-bar {
            background-color: #1db954;
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: width 0.1s ease;
        }
        .loading {
            display: none;
            margin: 15px 0;
            text-align: center;
            color: #b3b3b3;
            font-style: italic;
        }
        #youtube-player {
            height: 0 !important;
            width: 100%;
            border: none;
            visibility: hidden;
        }
        .playing-item {
            background-color: #373737 !important;
            border-left: 4px solid #1db954;
            padding-left: 15px;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <h1>YT Music Player</h1>
        <div id="search-container">
            <input type="text" id="query" placeholder="Enter song">
            <button onclick="search()">Search</button>
        </div>
        <div class="loading" id="loading">Searching...</div>
        <ul id="results"></ul>
        <div id="player-container">
            <div id="album-art"></div>
            <div id="now-playing"></div>
            <div class="controls">
                <button onclick="previousTrack()">⏮</button>
                <button id="play-pause" onclick="togglePlay()">▶</button>
                <button onclick="nextTrack()">⏭</button>
            </div>
            <div class="progress-container" onclick="seek(event)">
                <div id="progress-bar"></div>
            </div>
            <div id="youtube-player"></div>
        </div>
    </div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const KEY = '13452c8109msh7750057c5193b47p1c47c0jsn5d53a80bb998';
        const HOST = 'youtube-search-and-download.p.rapidapi.com';

        let ytPlayer;
        let currentPlayingLi = null;
        let currentIndex = -1;
        let progressInterval;

        function onYouTubeIframeAPIReady() {
            console.log('YouTube Iframe API is ready.');
        }

        function onPlayerReady(event) {
            event.target.playVideo();
            startProgress();
        }

        function onPlayerStateChange(event) {
            const playerStatus = event.data;
            let currentTitle = ytPlayer ? ytPlayer.getVideoData().title : '';
            if (currentTitle === '' && currentPlayingLi) {
                currentTitle = currentPlayingLi.querySelector('span').textContent.replace(/^\d+\.\s/, '');
            }
            const nowPlayingEl = document.getElementById('now-playing');
            const playPauseBtn = document.getElementById('play-pause');
            switch (playerStatus) {
                case YT.PlayerState.PLAYING:
                    nowPlayingEl.textContent = `Now Playing: ${currentTitle}`;
                    playPauseBtn.textContent = '⏸';
                    startProgress();
                    break;
                case YT.PlayerState.PAUSED:
                    nowPlayingEl.textContent = `Paused: ${currentTitle}`;
                    playPauseBtn.textContent = '▶';
                    stopProgress();
                    break;
                case YT.PlayerState.ENDED:
                    nowPlayingEl.textContent = `Ended: ${currentTitle}`;
                    playPauseBtn.textContent = '▶';
                    stopProgress();
                    nextTrack();
                    break;
                case YT.PlayerState.BUFFERING:
                    nowPlayingEl.textContent = `Buffering: ${currentTitle}`;
                    break;
                case YT.PlayerState.CUED:
                    nowPlayingEl.textContent = `Ready to play: ${currentTitle}`;
                    break;
            }
        }

        function startProgress() {
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(updateProgress, 1000);
        }

        function stopProgress() {
            if (progressInterval) clearInterval(progressInterval);
        }

        function updateProgress() {
            if (ytPlayer && ytPlayer.getDuration()) {
                const ct = ytPlayer.getCurrentTime();
                const dur = ytPlayer.getDuration();
                document.getElementById('progress-bar').style.width = (ct / dur * 100) + '%';
            }
        }

        function seek(event) {
            if (!ytPlayer) return;
            const progressEl = event.currentTarget;
            const clickX = event.offsetX;
            const width = progressEl.offsetWidth;
            const seekTime = (clickX / width) * ytPlayer.getDuration();
            ytPlayer.seekTo(seekTime);
        }

        function togglePlay() {
            if (!ytPlayer) return;
            if (ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                ytPlayer.pauseVideo();
            } else {
                ytPlayer.playVideo();
            }
        }

        function nextTrack() {
            const lis = document.querySelectorAll('#results li');
            if (lis.length === 0 || currentIndex >= lis.length - 1) return;
            const nextLi = lis[currentIndex + 1];
            const videoId = nextLi.dataset.videoId;
            const title = nextLi.dataset.videoTitle;
            const thumb = nextLi.querySelector('img').src;
            play(videoId, title, nextLi.querySelector('button'), thumb);
        }

        function previousTrack() {
            const lis = document.querySelectorAll('#results li');
            if (lis.length === 0 || currentIndex <= 0) return;
            const prevLi = lis[currentIndex - 1];
            const videoId = prevLi.dataset.videoId;
            const title = prevLi.dataset.videoTitle;
            const thumb = prevLi.querySelector('img').src;
            play(videoId, title, prevLi.querySelector('button'), thumb);
        }

        async function search() {
            try {
                document.getElementById('loading').style.display = 'block';
                const query = document.getElementById('query').value;
                const res = await fetch(`https://${HOST}/search?query=${encodeURIComponent(query)}&type=video`, {
                    headers: { 'x-rapidapi-key': KEY, 'x-rapidapi-host': HOST }
                });
                const data = await res.json();
                console.log('API Search Response:', data);
                const ul = document.getElementById('results');
                ul.innerHTML = '';
                
                if (data.message) {
                    throw new Error(data.message);
                }

                if (!data || !data.contents || !Array.isArray(data.contents)) {
                    throw new Error('Invalid response from server. Check the browser console for details.');
                }

                if (data.contents.length === 0) {
                    ul.innerHTML = '<li>No results found</li>';
                    return;
                }

                data.contents.forEach((v, i) => {
                    if (!v.video) return;
                    const li = document.createElement('li');
                    li.dataset.videoId = v.video.videoId;
                    li.dataset.videoTitle = v.video.title;
                    li.dataset.index = i;
                    const videoTitle = v.video.title;
                    const videoId = v.video.videoId;
                    const thumbUrl = v.video.thumbnails && v.video.thumbnails[0] ? v.video.thumbnails[0].url : '';
                    li.innerHTML = `
                        <img src="${thumbUrl}" alt="Thumbnail" onerror="this.style.display='none'">
                        <span>${i+1}. ${videoTitle}</span>
                        <button onclick="play('${videoId}', '${videoTitle.replace(/'/g, "\\'")}', this, '${thumbUrl}')">Play</button>
                    `;
                    ul.appendChild(li);
                });
            } catch (error) {
                const ul = document.getElementById('results');
                ul.innerHTML = '<li>Error: ' + error.message + '</li>';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function play(id, title, buttonElement, thumbUrl) {
            document.getElementById('now-playing').textContent = `Loading: ${title}...`;
            document.getElementById('album-art').style.backgroundImage = thumbUrl ? `url(${thumbUrl})` : 'none';

            if (currentPlayingLi) {
                currentPlayingLi.classList.remove('playing-item');
            }

            currentPlayingLi = buttonElement.closest('li');
            if (currentPlayingLi) {
                currentPlayingLi.classList.add('playing-item');
                currentIndex = parseInt(currentPlayingLi.dataset.index);
            }

            if (!ytPlayer) {
                ytPlayer = new YT.Player('youtube-player', {
                    height: '0',
                    width: '100%',
                    videoId: id,
                    playerVars: {
                        'playsinline': 1,
                        'autoplay': 1,
                        'controls': 0,
                        'modestbranding': 1,
                        'rel': 0,
                        'showinfo': 0,
                        'fs': 0
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            } else {
                ytPlayer.loadVideoById(id);
            }
        }

        document.getElementById('query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') search();
        });
    </script>
</body>
</html>
