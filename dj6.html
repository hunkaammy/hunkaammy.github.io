<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube DJ Player with Played History</title>
<style>
body {
font-family: 'Helvetica Neue', Arial, sans-serif;
display: flex;
flex-direction: column;
align-items: center;
margin: 0;
background: linear-gradient(135deg, #1a1a1a, #333333);
color: #f0f0f0;
padding: 20px;
box-sizing: border-box;
}
h1 {
text-align: center;
margin-bottom: 15px;
color: #ff5500;
text-shadow: 0 0 10px rgba(255, 85, 0, 0.7);
font-size: 28px;
letter-spacing: 2px;
}
.track-control-container {
display: flex;
justify-content: space-around;
width: 100%;
max-width: 600px;
margin: 20px 0;
}
.track-selector {
margin-right: 10px;
flex: 1;
position: relative;
}
label, input, select, button {
display: block;
margin-top: 10px;
width: 100%;
padding: 10px;
font-size: 16px;
border-radius: 5px;
border: none;
background-color: #222222;
color: #f0f0f0;
}
button {
cursor: pointer;
background-color: #ff5500;
transition: background-color 0.3s;
font-weight: bold;
}
button:hover {
background-color: #ff7700;
}
.player-container {
display: flex;
flex-wrap: wrap;
justify-content: space-between;
width: 100%;
margin: 20px 0;
max-width: 900px;
}
.video-player {
flex: 1;
min-width: 300px;
margin: 0 10px;
border: 2px solid #444444;
border-radius: 10px;
overflow: hidden;
width: 45%;
background-color: #111111;
box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
margin-bottom: 20px;
}
.tempo-controls {
padding: 10px;
background: rgba(0, 0, 0, 0.7);
border-radius: 0 0 10px 10px;
}
.tempo-slider {
width: 100%;
margin: 10px 0;
height: 10px;
background: #333333;
border-radius: 5px;
}
.tempo-slider::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 20px;
height: 20px;
background: #ff5500;
border-radius: 50%;
cursor: pointer;
}
.balance-control {
display: flex;
align-items: center;
justify-content: center;
margin-top: 20px;
width: 100%;
max-width: 600px;
flex-direction: column;
position: sticky;
top: 0;
z-index: 10;
padding: 20px;
background: rgba(40, 40, 40, 0.8);
border-radius: 10px;
backdrop-filter: blur(5px);
}
.balance-slider {
-webkit-appearance: none;
width: 100%;
height: 25px;
background: #333333;
border-radius: 10px;
outline: none;
cursor: pointer;
transition: background 0.3s ease;
border: 1px solid #ff5500;
}
.balance-slider::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 30px;
height: 30px;
background: #ff5500;
border-radius: 50%;
cursor: pointer;
box-shadow: 0 0 10px rgba(255, 85, 0, 0.7);
}
.balance-slider::-moz-range-thumb {
width: 30px;
height: 30px;
background: #ff5500;
border-radius: 50%;
cursor: pointer;
box-shadow: 0 0 10px rgba(255, 85, 0, 0.7);
}
.volume-percentage {
font-size: 20px;
color: #fff;
margin-top: 10px;
}
.history-container {
width: 100%;
max-width: 900px;
background: rgba(0, 0, 0, 0.5);
padding: 15px;
border-radius: 8px;
margin-top: 20px;
overflow-x: auto;
border: 1px solid #444444;
}
table {
width: 100%;
border-collapse: collapse;
}
th, td {
padding: 10px;
text-align: left;
border-bottom: 1px solid #444444;
}
th {
background-color: #222222;
color: #ff5500;
}
td button {
padding: 5px 10px;
background-color: #222222;
color: white;
border: 1px solid #444444;
border-radius: 5px;
cursor: pointer;
transition: background-color 0.3s;
}
.beat-btn:hover {
background-color: #444444;
}
.beat-btn.active {
background-color: #ff5500;
box-shadow: 0 0 10px rgba(255, 85, 0, 0.7);
}
td button:hover {
background-color: #1abc9c;
}
.edit-btn {
background-color: #f39c12;
}
.edit-btn:hover {
background-color: #e67e22;
}
.delete-btn {
background-color: #e74c3c;
}
.delete-btn:hover {
background-color: #c0392b;
}
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.8);
}
.modal-content {
background-color: #34495e;
margin: 15% auto;
padding: 20px;
border-radius: 8px;
width: 80%;
max-width: 600px;
position: relative;
}
.close {
color: #aaa;
float: right;
font-size: 28px;
cursor: pointer;
}
#notes-textarea {
width: 100%;
height: 200px;
margin: 10px 0;
background: #2c3e50;
border: 1px solid #444;
color: white;
padding: 10px;
border-radius: 4px;
resize: vertical;
}
#notes-btn {
margin-left: 10px;
padding: 8px 15px;
background: #1abc9c;
border: none;
border-radius: 5px;
cursor: pointer;
transition: background 0.3s;
}
#notes-btn:hover {
background: #16a085;
}
.buttons-container {
display: flex;
justify-content: space-between;
gap: 10px;
}
#backup-btn, #restore-btn {
margin-top: 20px;
}
@media (max-width: 768px) {
.player-container {
flex-direction: column;
align-items: center;
}
.video-player {
width: 90%;
margin: 10px 0;
}
}
.current-track-info {
background-color: rgba(255, 255, 255, 0.1);
padding: 15px;
border-radius: 8px;
margin-top: 20px;
width: 100%;
max-width: 900px;
text-align: center;
}
table {
font-size: 14px;
}
.custom-dropdown {
position: absolute;
width: 100%;
max-width: 300px;
margin: 10px 0;
z-index: 10;
background: #34495e;
max-height: 200px;
overflow-y: auto;
border-radius: 5px;
display: none;
}
.custom-dropdown .dropdown-item {
display: flex;
align-items: center;
cursor: pointer;
padding: 5px;
margin-bottom: 5px;
color: white;
background-color: transparent;
transition: background-color 0.3s ease;
}
.custom-dropdown .dropdown-item:hover {
background-color: #2980b9;
}
.custom-dropdown img {
width: 50px;
height: 50px;
margin-right: 10px;
border-radius: 5px;
object-fit: cover;
}
.custom-dropdown .title {
flex: 1;
font-size: 10px;
}
.tempo-controls {
padding: 10px;
background: rgba(0, 0, 0, 0.2);
border-radius: 0 0 10px 10px;
}
.tempo-slider {
width: 100%;
margin: 10px 0;
}
.beat-loop {
display: flex;
align-items: center;
gap: 10px;
}
.beat-buttons {
display: flex;
gap: 5px;
}
.beat-btn {
flex: 1;
padding: 5px 10px;
background-color: #34495e;
color: white;
border: none;
border-radius: 5px;
cursor: pointer;
transition: background-color 0.3s;
}
.beat-btn:hover {
background-color: #2980b9;
}
.beat-btn.active {
background-color: #e74c3c;
}
.suggestions-container {
width: 100%;
max-width: 600px;
margin: 20px 0;
background: rgba(0, 0, 0, 0.5);
padding: 15px;
border-radius: 8px;
border: 1px solid #444444;
}
.suggestions-container h2 {
color: #ff5500;
margin-bottom: 10px;
}
#ai-suggestions {
max-height: 200px;
overflow-y: auto;
}
.ai-suggestion-item {
display: flex;
align-items: center;
padding: 10px;
background: #34495e;
margin-bottom: 5px;
border-radius: 5px;
cursor: pointer;
}
.ai-suggestion-item:hover {
background: #2980b9;
}
.ai-suggestion-item img {
width: 50px;
height: 50px;
margin-right: 10px;
border-radius: 5px;
object-fit: cover;
}
.ai-suggestion-item .title {
flex: 1;
font-size: 14px;
color: white;
}
</style>
</head>
<body>
<h1>SAMMY'S YT DJ PROJECT</h1>
<select id="api-key-select" onchange="switchApiKey(this.value)">
<option value="0">YT API Key 1</option>
<option value="1">YT API Key 2</option>
</select>
<button id="notes-btn" onclick="openNotesModal()">Notes</button>
<div id="notes-modal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeNotesModal()">Ã—</span>
<h3>DJ Notes</h3>
<textarea id="notes-textarea" placeholder="Add your notes here..."></textarea>
<button onclick="saveNotes()">Save Notes</button>
</div>
</div>
<div class="track-control-container">
<div class="track-selector">
<label for="search-deck1">Search DECK-1:</label>
<input type="text" id="search-deck1" placeholder="Search YouTube">
<button onclick="searchYouTubeForDeck('deck1')">Search</button>
<div id="custom-dropdown1" class="custom-dropdown"></div>
</div>
<div class="track-selector">
<label for="search-deck2">Search DECK-2:</label>
<input type="text" id="search-deck2" placeholder="Search YouTube">
<button onclick="searchYouTubeForDeck('deck2')">Search</button>
<div id="custom-dropdown2" class="custom-dropdown"></div>
</div>
</div>
<div class="suggestions-container">
<h2>AI Remix Suggestions</h2>
<button onclick="getSongSuggestions()">Get AI Suggestions</button>
<div id="ai-suggestions"></div>
</div>
<div class="player-container">
<div class="video-player" id="player1">
<div id="youtube-player1"></div>
<div class="tempo-controls">
<label>BPM: <span id="tempo1-value">120</span></label>
<input type="range" id="tempo1" min="60" max="180" step="1" value="120" class="tempo-slider">
<div class="beat-loop">
<label>Beat Loop:</label>
<div class="beat-buttons">
<button class="beat-btn" data-beats="1" onclick="toggleBeatLoop(1, 1)">1</button>
<button class="beat-btn" data-beats="2" onclick="toggleBeatLoop(1, 2)">2</button>
<button class="beat-btn" data-beats="3" onclick="toggleBeatLoop(1, 3)">3</button>
</div>
</div>
</div>
</div>
<div class="video-player" id="player2">
<div id="youtube-player2"></div>
<div class="tempo-controls">
<label>BPM: <span id="tempo2-value">120</span></label>
<input type="range" id="tempo2" min="60" max="180" step="1" value="120" class="tempo-slider">
<div class="beat-loop">
<label>Beat Loop:</label>
<div class="beat-buttons">
<button class="beat-btn" data-beats="1" onclick="toggleBeatLoop(2, 1)">1</button>
<button class="beat-btn" data-beats="2" onclick="toggleBeatLoop(2, 2)">2</button>
<button class="beat-btn" data-beats="3" onclick="toggleBeatLoop(2, 3)">3</button>
</div>
</div>
</div>
</div>
</div>
<div class="balance-control">
<input type="range" id="balance-slider" class="balance-slider" min="0" max="100" value="50">
<div class="volume-percentage" id="volume-percentage">L 50% / R 50%</div>
</div>
<div class="current-track-info">
<h2>Current Track</h2>
<p id="current-track-deck1">Deck 1: <span id="current-track-title1">None</span></p>
<p id="current-track-deck2">Deck 2: <span id="current-track-title2">None</span></p>
</div>
<div class="history-container">
<h2>Played History</h2>
<input type="text" id="history-search" placeholder="Search in history" onkeyup="filterHistory()">
<p>Total Tracks Played: <span id="track-count">0</span></p>
<table id="history-list">
<thead>
<tr>
<th>Title</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
<button id="backup-btn" onclick="backupHistory()">Backup History</button>
<input type="file" id="restore-input" style="display:none" onchange="restoreHistory(event)">
<button id="restore-btn" onclick="document.getElementById('restore-input').click()">Restore History</button>

<script>
// --- API KEYS ---
// IMPORTANT: Replace with your own valid Gemini API key.
const geminiApiKey = 'AIzaSyB_eDEcv0TA2gWEJ7dJ3hJ0ExWwrXgcOzw';
const youtubeApiKeys = [
    'AIzaSyDjTV_vmRsN6bWbW2gyusMHMW_gZtpLI1A',
    'AIzaSyDX2n08WCf5Ol1nffaqJU_aJp_BODlw1H4'
];
let currentApiKeyIndex = 0;
let youtubeApiKey = youtubeApiKeys[currentApiKeyIndex];

// --- YOUTUBE PLAYER SETUP ---
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
const firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

let player1, player2;

function onYouTubeIframeAPIReady() {
    player1 = new YT.Player('youtube-player1', {
        height: '315',
        width: '100%',
        playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0 },
        events: { 'onReady': onPlayer1Ready, 'onStateChange': onPlayer1StateChange }
    });
    player2 = new YT.Player('youtube-player2', {
        height: '315',
        width: '100%',
        playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0 },
        events: { 'onReady': onPlayer2Ready, 'onStateChange': onPlayer2StateChange }
    });
}

// --- CORE DJ FUNCTIONS ---

function switchApiKey(index) {
    currentApiKeyIndex = parseInt(index, 10);
    youtubeApiKey = youtubeApiKeys[currentApiKeyIndex];
    alert(`YouTube API Key switched to key #${currentApiKeyIndex + 1}`);
}

/**
 * Calls the Gemini AI to get song suggestions based on the current track and play history.
 * @param {string} baseSong - The title of the current song for context.
 * @param {Array<string>} playedHistoryTitles - An array of titles already played to avoid duplicates.
 * @returns {Promise<Array<string>>} A promise that resolves to an array of song titles.
 */
async function getAiGeneratedIdeas(baseSong, playedHistoryTitles) {
    console.log(`ðŸ§  Calling Gemini for suggestions based on: ${baseSong}`);
    const suggestionsContainer = document.getElementById('ai-suggestions');
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`;

    // Create a detailed prompt for the AI
    const historyString = playedHistoryTitles.length > 0 
        ? `The following songs have already been played, do NOT suggest them: ${playedHistoryTitles.join(', ')}.`
        : 'The playlist is empty.';

    const prompt = `
        You are a helpful DJ assistant for an Indian DJ playing Bollywood and Punjabi party music.
        The current song is "${baseSong}".
        ${historyString}

        Suggest 7 new tracks that would mix well with the current song. Prioritize high-energy remixes, mashups, and popular tracks with a similar vibe.

        Your response MUST be a valid JSON array of strings and nothing else. Do not include any explanation or markdown.
        Example: ["Dilbar Remix", "Morni Banke - Guru Randhawa", "Kar Gayi Chull (Remix)"]
    `;

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                // Safety settings can be adjusted if needed
                "safetySettings": [
                    { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                ]
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error("Gemini API Error:", errorData.error);
            throw new Error(`AI API request failed: ${errorData.error.message}`);
        }

        const data = await response.json();
        if (!data.candidates || data.candidates.length === 0) {
            throw new Error("AI returned no suggestions.");
        }
        
        const rawText = data.candidates[0].content.parts[0].text;
        console.log("Raw AI Response:", rawText);

        // Clean the response to ensure it's valid JSON
        const cleanedText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
        const ideas = JSON.parse(cleanedText);

        if (!Array.isArray(ideas)) {
            throw new Error("AI response was not a valid array.");
        }

        return ideas;

    } catch (error) {
        console.error('Error fetching or parsing AI suggestions:', error);
        suggestionsContainer.innerHTML = `<p>Error from AI Assistant: ${error.message}. Please check your API Key and try again.</p>`;
        return []; // Return an empty array on failure
    }
}


async function getSongSuggestions() {
    const suggestionsContainer = document.getElementById('ai-suggestions');
    suggestionsContainer.innerHTML = '<p>ðŸ¤– Asking AI for unique remix ideas...</p>';
    
    const trackTitle1 = document.getElementById('current-track-title1').textContent.trim();
    let baseQuery = (trackTitle1 !== 'None' && trackTitle1 !== '') ? trackTitle1 : document.getElementById('current-track-title2').textContent.trim();
    if (baseQuery === 'None' || baseQuery === '') {
        baseQuery = 'Latest Bollywood Hits';
    }

    const historyTitles = Array.from(document.querySelectorAll('#history-list .track-title')).map(td => td.textContent);

    try {
        const ideas = await getAiGeneratedIdeas(baseQuery, historyTitles);
        
        if (!ideas || ideas.length === 0) {
            if (!suggestionsContainer.innerHTML.includes('Error')) {
               suggestionsContainer.innerHTML = '<p>The AI could not find any new suggestions. Try a different track!</p>';
            }
            return;
        }
        
        suggestionsContainer.innerHTML = '<p>ðŸŽ§ Finding YouTube links for AI ideas...</p>';

        const searchPromises = ideas.map(title => {
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(title)}&maxResults=1&key=${youtubeApiKey}`;
            return fetch(url).then(res => res.json());
        });

        const searchResults = await Promise.all(searchPromises);
        
        suggestionsContainer.innerHTML = '';

        searchResults.forEach(result => {
            if (result.items && result.items.length > 0) {
                const video = result.items[0];
                const { videoId } = video.id;
                const { title, thumbnails } = video.snippet;

                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'ai-suggestion-item';
                suggestionItem.onclick = () => {
                    const deck = prompt('Play on Deck 1 or Deck 2? (Enter 1 or 2)');
                    if (deck === '1' || deck === '2') {
                        const player = (deck === '1') ? player1 : player2;
                        document.getElementById(`current-track-title${deck}`).textContent = title;
                        player.loadVideoById(videoId);
                        addToHistory(title, videoId);
                        saveHistoryToLocalStorage();
                        suggestionsContainer.innerHTML = '';
                    }
                };
                suggestionItem.innerHTML = `
                    <img src="${thumbnails.default.url}" alt="${title} thumbnail">
                    <span class="title">${title}</span>`;
                suggestionsContainer.appendChild(suggestionItem);
            }
        });

        if (suggestionsContainer.innerHTML === '') {
            suggestionsContainer.innerHTML = '<p>Could not find YouTube videos for the AI suggestions.</p>';
        }

    } catch (error) {
        console.error('Error in getSongSuggestions:', error);
        suggestionsContainer.innerHTML = `<p>Error: ${error.message}.</p>`;
    }
}

function searchYouTubeForDeck(deck) {
    const query = document.getElementById(`search-${deck}`).value;
    if (query.trim() === '') return;
    
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&maxResults=20&key=${youtubeApiKey}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.error && data.error.code === 403) {
                alert('Quota exceeded. Switching to the next API Key...');
                const newIndex = (currentApiKeyIndex + 1) % youtubeApiKeys.length;
                document.getElementById('api-key-select').value = newIndex;
                switchApiKey(newIndex);
                searchYouTubeForDeck(deck);
                return;
            }

            const dropdown = document.getElementById(`custom-dropdown${deck === 'deck1' ? 1 : 2}`);
            dropdown.innerHTML = '';
            dropdown.style.display = 'block';

            if (data.items && data.items.length > 0) {
                data.items.forEach(video => {
                    const dropdownItem = document.createElement('div');
                    dropdownItem.className = 'dropdown-item';
                    dropdownItem.onclick = () => {
                        const selectedVideoId = video.id.videoId;
                        const trackTitle = video.snippet.title;
                        const player = deck === 'deck1' ? player1 : player2;
                        player.loadVideoById(selectedVideoId);
                        document.getElementById(`current-track-title${deck === 'deck1' ? 1 : 2}`).textContent = trackTitle;
                        dropdown.style.display = 'none';
                        addToHistory(trackTitle, selectedVideoId);
                        saveHistoryToLocalStorage();
                    };
                    dropdownItem.innerHTML = `<img src="${video.snippet.thumbnails.default.url}" alt="thumbnail"><span class="title">${video.snippet.title}</span>`;
                    dropdown.appendChild(dropdownItem);
                });
            } else {
                dropdown.innerHTML = '<p>No results found.</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching YouTube data:', error);
            document.getElementById(`custom-dropdown${deck === 'deck1' ? 1 : 2}`).innerHTML = '<p>Error fetching results.</p>';
        });
}


// --- PLAYER AND UI CONTROLS ---

function onPlayer1Ready(event) {
    player1.setVolume(50);
    initTempoControl(1);
}

function onPlayer2Ready(event) {
    player2.setVolume(50);
    initTempoControl(2);
}

function onPlayer1StateChange(event) { handlePlayerStateChange(1, event); }
function onPlayer2StateChange(event) { handlePlayerStateChange(2, event); }

function handlePlayerStateChange(deckNumber, event) {
    if (event.data === YT.PlayerState.PLAYING) {
        const beats = window[`loopBeats${deckNumber}`];
        if (beats > 0) startLoop(deckNumber, beats);
    } else {
        if (window[`loopInterval${deckNumber}`]) {
            clearInterval(window[`loopInterval${deckNumber}`]);
            window[`loopInterval${deckNumber}`] = null;
        }
    }
}

function initTempoControl(deckNumber) {
    const tempoSlider = document.getElementById(`tempo${deckNumber}`);
    const tempoValue = document.getElementById(`tempo${deckNumber}-value`);
    const player = deckNumber === 1 ? player1 : player2;
    
    tempoSlider.addEventListener('input', () => {
        const playbackRate = tempoSlider.value / 120;
        tempoValue.textContent = tempoSlider.value;
        if (player && typeof player.setPlaybackRate === 'function') {
            player.setPlaybackRate(playbackRate);
        }
    });
}

function toggleBeatLoop(deckNumber, beats) {
    const button = document.querySelector(`#player${deckNumber} .beat-btn[data-beats="${beats}"]`);
    if (button.classList.contains('active')) {
        button.classList.remove('active');
        if (window[`loopInterval${deckNumber}`]) {
            clearInterval(window[`loopInterval${deckNumber}`]);
            window[`loopInterval${deckNumber}`] = null;
        }
        window[`loopBeats${deckNumber}`] = 0;
        return;
    }
    document.querySelectorAll(`#player${deckNumber} .beat-btn`).forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    window[`loopBeats${deckNumber}`] = beats;
    if ((deckNumber === 1 ? player1 : player2).getPlayerState() === YT.PlayerState.PLAYING) {
        startLoop(deckNumber, beats);
    }
}

function startLoop(deckNumber, beats) {
    const player = deckNumber === 1 ? player1 : player2;
    if (window[`loopInterval${deckNumber}`]) clearInterval(window[`loopInterval${deckNumber}`]);
    const loopStartTime = player.getCurrentTime();
    const loopDuration = beats * 0.5; // Assuming 120 BPM, where 1 beat = 0.5s
    window[`loopInterval${deckNumber}`] = setInterval(() => {
        if (player.getPlayerState() === YT.PlayerState.PLAYING && player.getCurrentTime() >= loopStartTime + loopDuration) {
            player.seekTo(loopStartTime, true);
        }
    }, 50);
}

// --- HISTORY AND DATA MANAGEMENT ---

function addToHistory(title, videoId) {
    const historyListBody = document.getElementById('history-list').getElementsByTagName('tbody')[0];
    const historyItem = document.createElement('tr');
    historyItem.setAttribute('data-video-id', videoId);
    historyItem.innerHTML = `<td contenteditable="false" class="track-title">${title}</td><td><div class="buttons-container"><button onclick="replayTrack('player1', '${videoId}')">Deck 1</button><button onclick="replayTrack('player2', '${videoId}')">Deck 2</button></div><button class="edit-btn" onclick="editTrackTitle(this)">Edit</button><button class="delete-btn" onclick="deleteTrack(this)">Del</button></td>`;
    historyListBody.insertBefore(historyItem, historyListBody.firstChild);
    updateTrackCount();
}

function replayTrack(playerId, videoId) {
    const player = playerId === 'player1' ? player1 : player2;
    const deckNum = playerId === 'player1' ? 1 : 2;
    if (player) {
        player.loadVideoById(videoId);
        let trackTitle = 'Unknown Track';
        document.querySelectorAll('#history-list tbody tr').forEach(item => {
            if (item.getAttribute('data-video-id') === videoId) {
                trackTitle = item.querySelector('.track-title').textContent;
            }
        });
        document.getElementById(`current-track-title${deckNum}`).textContent = trackTitle;
    }
}

function editTrackTitle(button) {
    const trackTitleCell = button.closest('tr').querySelector('.track-title');
    trackTitleCell.contentEditable = true;
    trackTitleCell.focus();
    button.textContent = "Save";
    button.onclick = () => saveTrackTitle(button);
}

function saveTrackTitle(button) {
    const trackTitleCell = button.closest('tr').querySelector('.track-title');
    trackTitleCell.contentEditable = false;
    button.textContent = "Edit";
    button.onclick = () => editTrackTitle(button);
    saveHistoryToLocalStorage();
}

function deleteTrack(button) {
    button.closest('tr').remove();
    saveHistoryToLocalStorage();
}

function updateTrackCount() {
    const count = document.getElementById('history-list').getElementsByTagName('tbody')[0].children.length;
    document.getElementById('track-count').textContent = count;
}

function saveHistoryToLocalStorage() {
    const historyItems = document.querySelectorAll('#history-list tbody tr');
    const historyData = Array.from(historyItems).map(item => ({
        title: item.querySelector('.track-title').textContent,
        videoId: item.getAttribute('data-video-id')
    })).reverse();
    localStorage.setItem('playedHistory', JSON.stringify(historyData));
    updateTrackCount();
}

function loadHistoryFromLocalStorage() {
    const savedHistory = JSON.parse(localStorage.getItem('playedHistory')) || [];
    savedHistory.reverse().forEach(track => addToHistory(track.title, track.videoId));
}

function backupHistory() {
    const historyData = localStorage.getItem('playedHistory') || '[]';
    const blob = new Blob([historyData], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `played-history-${new Date().toISOString().slice(0,10)}.json`;
    link.click();
    URL.revokeObjectURL(link.href);
}

function restoreHistory(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const historyData = JSON.parse(e.target.result);
            if (Array.isArray(historyData)) {
                localStorage.setItem('playedHistory', JSON.stringify(historyData));
                document.getElementById('history-list').getElementsByTagName('tbody')[0].innerHTML = '';
                loadHistoryFromLocalStorage();
                alert('History restored successfully!');
            }
        } catch (error) { alert('Failed to restore history. Invalid file.'); }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// --- UTILITY AND SETUP ---

function openNotesModal() { document.getElementById('notes-modal').style.display = 'block'; loadNotes(); }
function closeNotesModal() { document.getElementById('notes-modal').style.display = 'none'; }
function saveNotes() { localStorage.setItem('djNotes', document.getElementById('notes-textarea').value); closeNotesModal(); }
function loadNotes() { document.getElementById('notes-textarea').value = localStorage.getItem('djNotes') || ''; }

function initBalanceControl() {
    const balanceSlider = document.getElementById('balance-slider');
    const volumePercentage = document.getElementById('volume-percentage');
    balanceSlider.addEventListener('input', () => {
        const balance = parseInt(balanceSlider.value);
        if (player1 && player2) {
            player1.setVolume(100 - balance);
            player2.setVolume(balance);
        }
        volumePercentage.textContent = `L ${100 - balance}% / R ${balance}%`;
    });
}

function filterHistory() {
    const query = document.getElementById('history-search').value.toLowerCase();
    document.querySelectorAll('#history-list tbody tr').forEach(row => {
        row.style.display = row.querySelector('.track-title').textContent.toLowerCase().includes(query) ? '' : 'none';
    });
}

document.addEventListener('click', (event) => {
    if (!event.target.closest('.track-selector')) {
        document.getElementById('custom-dropdown1').style.display = 'none';
        document.getElementById('custom-dropdown2').style.display = 'none';
    }
});

window.onload = () => {
    initBalanceControl();
    loadHistoryFromLocalStorage();
    loadNotes();
};
</script>
</body>
</html>
