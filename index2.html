<!DOCTYPE html>
<html lang="en" ng-app="myApp" ng-cloak>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Hindustan Toys - Order Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    :root {
      --primary-color: #388e3c;
      --primary-dark: #2e7d32;
      --primary-light: #4caf50;
      --secondary-color: #2196f3;
      --danger-color: #f44336;
      --warning-color: #ff9800;
      --success-color: #4caf50;
      --light-bg: #f8f9fa;
      --dark-text: #1a1a1a;
      --medium-text: #666666;
      --light-text: #999999;
      --white: #ffffff;
      --border-color: #e0e0e0;
      --card-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      --card-shadow-hover: 0 6px 20px rgba(0, 0, 0, 0.12);
      --nav-height: 60px;
      --bottom-nav-height: 65px;
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    @media (max-width: 768px) {
      html {
        font-size: 15px;
      }
    }

    @media (max-width: 480px) {
      html {
        font-size: 14px;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 0.9rem;
      line-height: 1.5;
      color: var(--dark-text);
      background: var(--light-bg);
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
      overflow-x: hidden;
      min-height: 100vh;
    }

    [ng-cloak] {
      display: none !important;
    }

    /* Login Screen */
    #login-container {
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      position: relative;
      overflow: hidden;
    }

    #login-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('https://images.unsplash.com/photo-1542751371-adc38448a05e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') center/cover;
      opacity: 0.1;
    }

    #inside {
      background: rgba(255, 255, 255, 0.95);
      width: 100%;
      max-width: 400px;
      border-radius: 24px;
      padding: 2.5rem 2rem;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      text-align: center;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #inside h2 {
      color: var(--primary-dark);
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 2rem;
      letter-spacing: -0.5px;
    }

    #inside input {
      width: 100%;
      padding: 1rem 1.25rem;
      border: 2px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      font-size: 1rem;
      margin-bottom: 1.25rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }

    #inside input:focus {
      border-color: var(--primary-color);
      background: var(--white);
      box-shadow: 0 0 0 4px rgba(56, 142, 60, 0.15);
      outline: none;
      transform: translateY(-2px);
    }

    #inside button {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: var(--white);
      border: none;
      border-radius: 14px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 0.5rem;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    #inside button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(56, 142, 60, 0.4);
    }

    #inside button:active {
      transform: translateY(-1px);
    }

    /* Main App Container */
    #content {
      display: none;
      max-width: 100%;
      overflow-x: hidden;
      background: var(--light-bg);
    }

    /* Top Navigation - Modern Design */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .search-container {
      flex: 1;
      position: relative;
      max-width: 500px;
    }

    .search-container input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 3rem;
      border: 2px solid transparent;
      border-radius: 16px;
      font-size: 0.9rem;
      background: rgba(0, 0, 0, 0.03);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
    }

    .search-container input:focus {
      background: var(--white);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.1);
      padding-right: 3.5rem;
    }

    .search-container .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--medium-text);
      font-size: 1rem;
      transition: color 0.3s ease;
    }

    .search-container input:focus + .search-icon {
      color: var(--primary-color);
    }

    .menu-btn {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: none;
      background: rgba(0, 0, 0, 0.03);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--dark-text);
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .menu-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      transform: rotate(15deg);
    }

    .notification-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: linear-gradient(135deg, var(--danger-color), #d32f2f);
      color: var(--white);
      font-size: 0.7rem;
      font-weight: 800;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
      border: 2px solid var(--white);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    /* User Info Bar - Modern Design */
    .user-bar {
      background: rgba(255, 255, 255, 0.9);
      padding: 1rem;
      margin-top: var(--nav-height);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0;
    }

    .user-info .avatar {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: 700;
      font-size: 1rem;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(56, 142, 60, 0.3);
    }

    .user-info .name {
      font-weight: 700;
      font-size: 1rem;
      color: var(--dark-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .price-toggle {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      white-space: nowrap;
      background: rgba(0, 0, 0, 0.03);
      padding: 0.5rem 1rem;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .price-toggle:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .price-toggle span {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--medium-text);
    }

    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .form-check-input:focus {
      box-shadow: 0 0 0 0.25rem rgba(56, 142, 60, 0.25);
    }

    /* Main Content */
    .main-content {
      padding: 1.25rem;
      padding-bottom: calc(var(--bottom-nav-height) + 1.25rem + var(--safe-area-inset-bottom));
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Category Tabs - Modern Design */
    .category-tabs-container {
      position: relative;
      margin: 0 -1.25rem;
      padding: 0 1.25rem;
    }

    .category-tabs {
      display: flex;
      gap: 0.75rem;
      overflow-x: auto;
      padding: 1rem 0;
      margin: -1rem -1.25rem;
      padding-left: 1.25rem;
      padding-right: 1.25rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .category-tabs::-webkit-scrollbar {
      display: none;
    }

    .category-tab {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 0.75rem;
      border-radius: 18px;
      background: var(--white);
      border: 2px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 85px;
      max-width: 100px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .category-tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 0;
    }

    .category-tab:hover {
      transform: translateY(-4px);
      box-shadow: var(--card-shadow-hover);
      border-color: rgba(56, 142, 60, 0.2);
    }

    .category-tab.active {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      border-color: var(--primary-color);
      color: var(--white);
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 10px 25px rgba(56, 142, 60, 0.3);
    }

    .category-tab.active::before {
      opacity: 1;
    }

    .tab-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.02);
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .category-tab.active .tab-icon {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .tab-icon img {
      width: 28px;
      height: 28px;
      object-fit: contain;
      transition: transform 0.3s ease;
    }

    .category-tab:hover .tab-icon img {
      transform: scale(1.1);
    }

    .tab-text {
      font-size: 0.75rem;
      font-weight: 700;
      line-height: 1.2;
      color: var(--dark-text);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      max-height: 2.4em;
      position: relative;
      z-index: 1;
      transition: color 0.3s ease;
    }

    .category-tab.active .tab-text {
      color: var(--white);
    }

    .tab-count {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary-color);
      font-size: 0.65rem;
      font-weight: 800;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .category-tab.active .tab-count {
      background: rgba(255, 255, 255, 0.2);
      color: var(--white);
    }

    /* Sort and Filter Bar */
    .sort-filter-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin: 1.5rem 0 1rem;
      background: var(--white);
      padding: 0.75rem 1rem;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
    }

    .category-title {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--dark-text);
      margin: 0;
      flex: 1;
    }

    .sort-select {
      padding: 0.6rem 1rem;
      border: 2px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      background: var(--white);
      color: var(--dark-text);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 160px;
    }

    .sort-select:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.1);
    }

    /* Products Grid - RESPONSIVE GRID SYSTEM */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.25rem;
      margin-top: 1rem;
    }

    /* Tablet: 2 columns */
    @media (max-width: 1024px) {
      .products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
    }

    /* Small Tablet: 2 columns with smaller gap */
    @media (max-width: 768px) {
      .products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.875rem;
      }
    }

    /* Mobile: 1 column */
    @media (max-width: 480px) {
      .products-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }

    /* Extra Small Mobile: 1 column with smaller gap */
    @media (max-width: 360px) {
      .products-grid {
        grid-template-columns: 1fr;
        gap: 0.875rem;
      }
    }

    /* Product Card - Modern Design */
    .product-card {
      background: var(--white);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      border: 1px solid rgba(0, 0, 0, 0.05);
      animation: cardAppear 0.5s ease backwards;
    }

    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .product-card:nth-child(1) { animation-delay: 0.1s; }
    .product-card:nth-child(2) { animation-delay: 0.2s; }
    .product-card:nth-child(3) { animation-delay: 0.3s; }
    .product-card:nth-child(4) { animation-delay: 0.4s; }

    .product-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      border-color: rgba(56, 142, 60, 0.2);
    }

    .product-image-container {
      position: relative;
      width: 100%;
      padding-top: 100%;
      background: linear-gradient(135deg, #f5f7fa, #e4e8ed);
      overflow: hidden;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .product-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 1rem;
      cursor: pointer;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-card:hover .product-image {
      transform: scale(1.08);
    }

    .zoom-indicator {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: var(--white);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 2;
    }

    .product-image-container:hover .zoom-indicator {
      opacity: 1;
      transform: translateY(0);
    }

    .out-of-stock-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: linear-gradient(135deg, var(--danger-color), #d32f2f);
      color: var(--white);
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 800;
      z-index: 2;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
    }

    .product-info {
      padding: 1.25rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .product-name {
      font-weight: 700;
      font-size: 1rem;
      line-height: 1.4;
      color: var(--dark-text);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 2.8em;
      margin-bottom: 0.25rem;
    }

    .product-price-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 0.5rem 0;
    }

    .product-price {
      color: var(--primary-color);
      font-weight: 900;
      font-size: 1.3rem;
      letter-spacing: -0.5px;
    }

    .price-hidden {
      color: var(--medium-text);
      font-size: 0.8rem;
      font-style: italic;
      font-weight: 500;
      padding: 0.3rem 0.8rem;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 8px;
    }

    .product-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: auto;
    }

    .quantity-input-container {
      position: relative;
      width: 100%;
    }

    .quantity-input {
      width: 100%;
      padding: 0.85rem 1rem;
      border: 2px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      text-align: center;
      font-size: 1rem;
      font-weight: 700;
      background: rgba(0, 0, 0, 0.02);
      transition: all 0.3s ease;
      -moz-appearance: textfield;
    }

    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .quantity-input:focus {
      border-color: var(--primary-color);
      background: var(--white);
      outline: none;
      box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.1);
      padding-right: 3.5rem;
    }

    .quantity-input:focus + .qty-label {
      opacity: 1;
      transform: translateX(-10px);
    }

    .qty-label {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--medium-text);
      font-size: 0.8rem;
      font-weight: 600;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .video-btn {
      width: 100%;
      padding: 0.85rem;
      background: linear-gradient(135deg, var(--secondary-color), #1976d2);
      color: var(--white);
      border: none;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .video-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(33, 150, 243, 0.3);
    }

    .video-btn:active {
      transform: translateY(-1px);
    }

    .video-btn i {
      font-size: 0.9rem;
    }

    .admin-action {
      margin-top: 0.75rem;
    }

    .out-of-stock-btn {
      width: 100%;
      padding: 0.85rem;
      background: transparent;
      color: var(--danger-color);
      border: 2px solid rgba(244, 67, 54, 0.3);
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .out-of-stock-btn:hover {
      background: var(--danger-color);
      color: var(--white);
      border-color: var(--danger-color);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(244, 67, 54, 0.2);
    }

    /* Saved Feedback */
    .saved-feedback {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(135deg, var(--success-color), #43a047);
      color: var(--white);
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 800;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1), fadeOut 0.4s ease 1.6s forwards;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(30px) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(10px) scale(0.9);
      }
    }

    /* Bottom Navigation - Modern Design */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(var(--bottom-nav-height) + var(--safe-area-inset-bottom));
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      padding: 0.5rem 1rem var(--safe-area-inset-bottom);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 0.6rem;
      border-radius: 14px;
      color: var(--medium-text);
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      min-width: 0;
      position: relative;
      overflow: hidden;
    }

    .nav-item:hover,
    .nav-item.active {
      color: var(--primary-color);
      background: rgba(56, 142, 60, 0.08);
      transform: translateY(-2px);
    }

    .nav-item.active {
      color: var(--primary-color);
      background: rgba(56, 142, 60, 0.12);
      font-weight: 700;
    }

    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      background: var(--primary-color);
      border-radius: 50%;
    }

    .nav-icon {
      font-size: 1.3rem;
      transition: transform 0.3s ease;
    }

    .nav-item:hover .nav-icon {
      transform: scale(1.1);
    }

    .nav-text {
      font-size: 0.65rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: 0.3px;
    }

    .order-btn {
      flex: 1.5;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: var(--white);
      border: none;
      border-radius: 16px;
      padding: 0.85rem;
      font-size: 0.9rem;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 6px 20px rgba(56, 142, 60, 0.4);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.5px;
    }

    .order-btn:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 12px 30px rgba(56, 142, 60, 0.5);
    }

    .order-btn:active {
      transform: translateY(-2px) scale(1.02);
    }

    .order-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 800;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    /* Search Results */
    .search-results {
      padding: 1.25rem;
      padding-bottom: calc(var(--bottom-nav-height) + 1.25rem + var(--safe-area-inset-bottom));
      margin-top: var(--nav-height);
      animation: fadeIn 0.5s ease;
    }

    .search-header {
      margin-bottom: 1.5rem;
      background: var(--white);
      padding: 1.25rem;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
    }

    .search-title {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--dark-text);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .search-query {
      color: var(--primary-color);
      background: rgba(56, 142, 60, 0.1);
      padding: 0.2rem 0.8rem;
      border-radius: 10px;
      font-weight: 800;
    }

    .results-count {
      color: var(--medium-text);
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .results-count i {
      color: var(--primary-color);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 1.5rem;
      background: var(--white);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      margin: 2rem 0;
      animation: fadeIn 0.5s ease;
    }

    .empty-icon {
      font-size: 4rem;
      color: rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
      opacity: 0.8;
    }

    .empty-text {
      color: var(--dark-text);
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .empty-subtext {
      color: var(--medium-text);
      font-size: 0.95rem;
      max-width: 300px;
      margin: 0 auto;
      line-height: 1.5;
    }

    /* Loading States */
    .skeleton-loader {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.25rem;
      margin-top: 1rem;
    }

    @media (max-width: 1024px) {
      .skeleton-loader {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
    }

    @media (max-width: 480px) {
      .skeleton-loader {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }

    .skeleton-card {
      background: var(--white);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }

    @keyframes skeleton-pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .skeleton-image {
      width: 100%;
      padding-top: 100%;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    .skeleton-content {
      padding: 1.25rem;
    }

    .skeleton-line {
      height: 0.9rem;
      background: #f0f0f0;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      animation: shimmer 1.5s infinite;
    }

    .skeleton-line.short {
      width: 60%;
    }

    .skeleton-line.medium {
      width: 80%;
    }

    /* Modal Styles - Modern */
    .modal-content {
      border-radius: 24px;
      border: none;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      background: var(--white);
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      background: var(--white);
      border-radius: 24px 24px 0 0;
      position: sticky;
      top: 0;
      z-index: 1;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .modal-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--dark-text);
      margin: 0;
    }

    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      background: rgba(0, 0, 0, 0.02);
      border-radius: 0 0 24px 24px;
    }

    /* Order Items in Modal */
    .order-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .order-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 16px;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .order-item:hover {
      background: rgba(0, 0, 0, 0.03);
      border-color: rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    .order-item-image {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      object-fit: contain;
      background: var(--white);
      flex-shrink: 0;
      box-shadow: var(--card-shadow);
    }

    .order-item-details {
      flex: 1;
      min-width: 0;
    }

    .order-item-name {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--dark-text);
      margin-bottom: 0.3rem;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .order-item-price {
      color: var(--primary-color);
      font-weight: 800;
      font-size: 1rem;
    }

    .order-item-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .qty-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 2px solid rgba(0, 0, 0, 0.1);
      background: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--dark-text);
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
      font-weight: 700;
    }

    .qty-btn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
      transform: scale(1.1);
    }

    .qty-display {
      min-width: 36px;
      text-align: center;
      font-weight: 800;
      font-size: 1rem;
      color: var(--dark-text);
    }

    .delete-btn {
      color: var(--danger-color);
      border-color: rgba(244, 67, 54, 0.2);
    }

    .delete-btn:hover {
      background: var(--danger-color);
      color: var(--white);
      border-color: var(--danger-color);
    }

    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 800;
      font-size: 1.4rem;
      color: var(--primary-color);
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid rgba(0, 0, 0, 0.05);
    }

    /* Enlarged Image Overlay */
    .image-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.98);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1rem;
      animation: overlayFadeIn 0.3s ease;
    }

    @keyframes overlayFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .image-overlay img {
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
      border-radius: 12px;
      animation: imageZoomIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes imageZoomIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .close-overlay {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      color: var(--white);
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .close-overlay:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg) scale(1.1);
    }

    /* Video Modal */
    .video-modal video {
      width: 100%;
      border-radius: 16px;
      background: #000;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* Dropdown Menu */
    .dropdown-menu {
      border: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      border-radius: 16px;
      padding: 0.5rem;
      min-width: 220px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .dropdown-item {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      color: var(--dark-text);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
      margin: 0.1rem;
    }

    .dropdown-item:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--primary-color);
      transform: translateX(5px);
    }

    .dropdown-item.text-danger:hover {
      background: rgba(244, 67, 54, 0.05);
      color: var(--danger-color);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.02);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      transition: background 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .navbar {
        padding: 0.5rem 0.75rem;
      }
      
      .user-bar {
        padding: 0.75rem;
      }
      
      .main-content {
        padding: 1rem;
        padding-bottom: calc(var(--bottom-nav-height) + 1rem + var(--safe-area-inset-bottom));
      }
      
      .category-tabs {
        gap: 0.5rem;
      }
      
      .category-tab {
        min-width: 75px;
        padding: 0.75rem 0.5rem;
      }
      
      .tab-icon {
        width: 32px;
        height: 32px;
      }
      
      .tab-icon img {
        width: 22px;
        height: 22px;
      }
      
      .sort-filter-bar {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
      }
      
      .category-title {
        font-size: 1.1rem;
      }
      
      .sort-select {
        width: 100%;
      }
      
      .product-info {
        padding: 1rem;
      }
      
      .product-name {
        font-size: 0.95rem;
      }
      
      .product-price {
        font-size: 1.2rem;
      }
      
      .quantity-input {
        padding: 0.75rem;
      }
      
      .video-btn {
        padding: 0.75rem;
      }
      
      .order-btn {
        padding: 0.75rem;
      }
    }

    @media (max-width: 480px) {
      .navbar {
        padding: 0.5rem;
      }
      
      .menu-btn {
        width: 40px;
        height: 40px;
      }
      
      .search-container input {
        padding: 0.65rem 0.75rem 0.65rem 2.5rem;
        font-size: 0.85rem;
      }
      
      .search-container .search-icon {
        left: 0.85rem;
        font-size: 0.9rem;
      }
      
      .user-info .avatar {
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
      }
      
      .user-info .name {
        font-size: 0.9rem;
      }
      
      .price-toggle span {
        font-size: 0.8rem;
      }
      
      .category-tab {
        min-width: 65px;
        max-width: 70px;
        padding: 0.6rem 0.4rem;
        border-radius: 14px;
      }
      
      .tab-icon {
        width: 28px;
        height: 28px;
      }
      
      .tab-icon img {
        width: 18px;
        height: 18px;
      }
      
      .tab-text {
        font-size: 0.65rem;
      }
      
      .tab-count {
        width: 16px;
        height: 16px;
        font-size: 0.55rem;
      }
      
      .product-name {
        font-size: 0.9rem;
      }
      
      .product-price {
        font-size: 1.1rem;
      }
      
      .quantity-input {
        padding: 0.65rem;
        font-size: 0.95rem;
      }
      
      .video-btn {
        padding: 0.65rem;
        font-size: 0.85rem;
      }
      
      .order-btn {
        padding: 0.65rem;
        font-size: 0.85rem;
      }
      
      .nav-icon {
        font-size: 1.2rem;
      }
      
      .nav-text {
        font-size: 0.6rem;
      }
    }

    /* Safe Area Support */
    @supports (padding-top: env(safe-area-inset-top)) {
      .navbar {
        padding-top: calc(0.5rem + env(safe-area-inset-top));
        height: calc(var(--nav-height) + env(safe-area-inset-top));
      }
      
      .user-bar {
        margin-top: calc(var(--nav-height) + env(safe-area-inset-top));
      }
      
      .search-results {
        margin-top: calc(var(--nav-height) + env(safe-area-inset-top));
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body ng-controller="imagesController as vm">
  <!-- Login Screen -->
  <div id="login-container">
    <div id="inside">
      <h2>HINDUSTAN TOYS</h2>
      <input type="text" id="name" placeholder="Shop Name" class="form-control mb-3" autocomplete="off">
      <input type="tel" id="mobile" placeholder="Mobile Number" class="form-control mb-4" autocomplete="off">
      <button class="btn btn-success w-100" onclick="validateLogin()">
        <i class="fas fa-sign-in-alt me-2"></i>Login
      </button>
    </div>
  </div>

  <!-- Main App -->
  <div id="content" style="display: none;">
    <!-- Top Navigation -->
    <nav class="navbar">
      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" 
               ng-model="searchQuery" 
               ng-change="onSearchChange()" 
               ng-model-options="{ debounce: 400 }"
               placeholder="Search products...">
      </div>
      <button class="menu-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-bars"></i>
        <span class="notification-badge" ng-if="orderCount > 0">{{orderCount}}</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li>
          <a class="dropdown-item" href="#" ng-click="openOrderModal()">
            <i class="fas fa-shopping-cart"></i>
            Your Order
            <span class="badge bg-primary float-end" ng-if="orderCount > 0">{{orderCount}}</span>
          </a>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <a class="dropdown-item text-danger" href="#" ng-click="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </a>
        </li>
      </ul>
    </nav>

    <!-- User Info Bar -->
    <div class="user-bar">
      <div class="user-info">
        <div class="avatar">
          {{dynamicField2Value ? dynamicField2Value.charAt(0) : 'U'}}
        </div>
        <div class="name">{{dynamicField2Value || 'User'}}</div>
      </div>
      <div class="price-toggle">
        <span>Show Prices</span>
        <div class="form-check form-switch mb-0">
          <input class="form-check-input" type="checkbox" role="switch" id="priceToggle" 
                 ng-model="priceVisible" ng-change="togglePriceVisibility()">
        </div>
      </div>
    </div>

    <!-- Search Results View -->
    <div class="search-results" ng-if="isSearching">
      <div class="search-header">
        <h2 class="search-title">
          <i class="fas fa-search"></i>
          Search Results <span class="search-query">"{{searchQuery}}"</span>
        </h2>
        <div class="results-count">
          <i class="fas fa-box"></i>
          {{searchResults.length}} products found
        </div>
      </div>

      <!-- Loading State -->
      <div class="skeleton-loader" ng-if="isLoadingSearchResults">
        <div class="skeleton-card" ng-repeat="i in [1,2,3,4]">
          <div class="skeleton-image"></div>
          <div class="skeleton-content">
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line short"></div>
          </div>
        </div>
      </div>

      <!-- Results Grid - RESPONSIVE -->
      <div class="products-grid" ng-if="!isLoadingSearchResults">
        <div class="product-card" ng-repeat="product in searchResults">
          <div class="product-image-container">
            <img ng-src="{{product.url}}" alt="{{product.name}}" 
                 class="product-image" ng-click="showEnlargedImage(product.url)">
            <div class="zoom-indicator">
              <i class="fas fa-search-plus"></i>
            </div>
            <span class="saved-feedback" ng-if="product.justSaved">
              <i class="fas fa-check"></i> Saved
            </span>
          </div>
          <div class="product-info">
            <div class="product-name">{{product.name}}</div>
            <div class="product-price-container">
              <div class="product-price" ng-if="priceVisible">
                {{product.price | currency:"₹":0}}
              </div>
              <div class="price-hidden" ng-if="!priceVisible">
                Price hidden
              </div>
            </div>
            <div class="product-actions">
              <div class="quantity-input-container">
                <input type="number" class="quantity-input" placeholder="0"
                       ng-model="product.field3" ng-change="submitData(product)"
                       ng-model-options="{ debounce: 800 }" min="0">
                <span class="qty-label">Qty</span>
              </div>
              <button class="video-btn" ng-if="product.videourl" 
                      ng-click="showVideoModal($event, product.videourl, false)">
                <i class="fas fa-play-circle"></i> Watch Video
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" ng-if="!isLoadingSearchResults && searchResults.length === 0">
        <div class="empty-icon">
          <i class="fas fa-search"></i>
        </div>
        <div class="empty-text">No products found</div>
        <div class="empty-subtext">Try different keywords or browse categories</div>
      </div>
    </div>

    <!-- Main Products View -->
    <div class="main-content" ng-if="!isSearching">
      <!-- Category Tabs -->
      <div class="category-tabs-container">
        <div class="category-tabs">
          <!-- Loading State -->
          <div class="category-skeleton" ng-if="isLoadingCategories">
            <div class="skeleton-tab" ng-repeat="i in [1,2,3,4,5,6]">
              <div class="skeleton-icon"></div>
              <div class="skeleton-text"></div>
            </div>
          </div>

          <!-- Categories -->
          <div class="category-tab" 
               ng-class="{'active': activeTabId === category.id}"
               ng-click="selectCategory(category.filter, category.id)"
               ng-repeat="category in categories"
               ng-if="!isLoadingCategories">
            <div class="tab-icon">
              <img ng-src="{{category.imageUrl}}" alt="{{category.name}}">
            </div>
            <div class="tab-text">{{category.name}}</div>
            <div class="tab-count" ng-if="category.productCount > 0">
              {{category.productCount}}
            </div>
          </div>
        </div>
      </div>

      <!-- Sort and Filter Bar -->
      <div class="sort-filter-bar">
        <h3 class="category-title">{{activeCategoryName}}</h3>
        <select ng-model="sortOrder" ng-change="updateDisplayedProducts()" class="sort-select">
          <option value="default">Sort: Newest</option>
          <option value="price">Sort: Price Low to High</option>
          <option value="-price">Sort: Price High to Low</option>
        </select>
      </div>

      <!-- Products Grid - RESPONSIVE -->
      <div class="skeleton-loader" ng-if="isLoading">
        <div class="skeleton-card" ng-repeat="i in [1,2,3,4,5,6]">
          <div class="skeleton-image"></div>
          <div class="skeleton-content">
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line short"></div>
          </div>
        </div>
      </div>

      <div class="products-grid" ng-if="!isLoading">
        <div class="product-card" ng-repeat="product in displayedProducts" ng-hide="product.markedForRemoval">
          <div class="product-image-container">
            <img ng-src="{{product.url}}" alt="{{product.name}}" 
                 class="product-image" ng-click="showEnlargedImage(product.url, false)">
            <div class="zoom-indicator">
              <i class="fas fa-search-plus"></i>
            </div>
            <span class="saved-feedback" ng-if="product.justSaved">
              <i class="fas fa-check"></i> Saved
            </span>
            <div class="out-of-stock-badge" ng-if="product.outOfStock">
              Out of Stock
            </div>
          </div>
          <div class="product-info">
            <div class="product-name">{{product.name}}</div>
            <div class="product-price-container">
              <div class="product-price" ng-if="priceVisible">
                {{product.price | currency:"₹":0}}
              </div>
              <div class="price-hidden" ng-if="!priceVisible">
                Price hidden
              </div>
            </div>
            <div class="product-actions">
              <div class="quantity-input-container">
                <input type="number" class="quantity-input" placeholder="0"
                       ng-model="product.field3" ng-change="submitData(product)"
                       ng-model-options="{ debounce: 800 }" min="0">
                <span class="qty-label">Qty</span>
              </div>
              <button class="video-btn" ng-if="product.videourl" 
                      ng-click="showVideoModal($event, product.videourl, false)">
                <i class="fas fa-play-circle"></i> Watch Video
              </button>
              <div class="admin-action" ng-if="dynamicField2Value === 'sammyadmin'">
                <button class="out-of-stock-btn" ng-click="markOutOfStock(product)">
                  <i class="fas fa-ban"></i> Mark Out of Stock
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" ng-if="!isLoading && displayedProducts.length === 0">
        <div class="empty-icon">
          <i class="fas fa-box-open"></i>
        </div>
        <div class="empty-text">No products in this category</div>
        <div class="empty-subtext">Try selecting a different category or check back later</div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <a href="#" class="nav-item" ng-click="selectCategory('', 0)" ng-class="{'active': activeTabId === 0}">
        <i class="fas fa-home nav-icon"></i>
        <span class="nav-text">Home</span>
      </a>
      <a href="#" class="nav-item" data-bs-toggle="modal" data-bs-target="#productModal">
        <i class="fas fa-th-large nav-icon"></i>
        <span class="nav-text">All</span>
      </a>
      <button class="order-btn" ng-click="openOrderModal()">
        <i class="fas fa-shopping-cart"></i>
        Order
        <span class="order-count" ng-if="orderCount > 0">{{orderCount}}</span>
      </button>
      <a href="#" class="nav-item">
        <i class="fas fa-filter nav-icon"></i>
        <span class="nav-text">Filter</span>
      </a>
      <a href="#" class="nav-item" ng-click="logout()">
        <i class="fas fa-sign-out-alt nav-icon"></i>
        <span class="nav-text">Logout</span>
      </a>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ activeCategoryName }}</h5>
          <select ng-model="sortOrder" ng-change="updateDisplayedProducts()" class="form-select form-select-sm">
            <option value="default">Sort: Newest</option>
            <option value="price">Sort: Price Low to High</option>
            <option value="-price">Sort: Price High to Low</option>
          </select>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="products-grid">
            <div class="product-card" ng-repeat="image in displayedProducts" ng-hide="image.markedForRemoval">
              <div class="product-image-container">
                <img ng-src="{{image.url}}" alt="{{image.name}}" 
                     class="product-image" ng-click="showEnlargedImage(image.url, true)">
                <div class="zoom-indicator">
                  <i class="fas fa-search-plus"></i>
                </div>
              </div>
              <div class="product-info">
                <div class="product-name">{{image.name}}</div>
                <div class="product-price-container">
                  <div class="product-price" ng-if="priceVisible">
                    {{image.price | currency:"₹":0}}
                  </div>
                  <div class="price-hidden" ng-if="!priceVisible">
                    Price hidden
                  </div>
                </div>
                <div class="product-actions">
                  <div class="quantity-input-container">
                    <input type="number" class="quantity-input" placeholder="0"
                           ng-model="image.field3" ng-change="submitData(image)"
                           ng-model-options="{ debounce: 800 }" min="0">
                    <span class="qty-label">Qty</span>
                  </div>
                  <button class="video-btn" ng-if="image.videourl" 
                          ng-click="showVideoModal($event, image.videourl, true)">
                    <i class="fas fa-play-circle"></i> Watch Video
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Product Video</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" ng-click="closeVideoModal()"></button>
        </div>
        <div class="modal-body">
          <video controls autoplay id="videoPlayer" class="w-100" style="max-height: 60vh;">
            <source ng-src="{{currentVideoUrl}}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <div class="alert alert-danger mt-2 mb-0" ng-if="videoError">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{videoError}}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Modal -->
  <div class="modal fade" id="myModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-shopping-cart me-2"></i>
            {{dynamicField2Value}}'s Order
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="order-list">
            <div class="order-item" 
                 ng-repeat="item in allOrders | filter:{field2: dynamicField2Value}:true | orderBy:'-serverTimestamp'">
              <img ng-src="{{item.field1}}" class="order-item-image">
              <div class="order-item-details">
                <div class="order-item-name">{{item.productName}}</div>
                <div class="order-item-price" ng-if="priceVisible">
                  {{item.productPrice | currency:"₹":0}}
                </div>
              </div>
              <div class="order-item-actions">
                <button class="qty-btn" ng-click="decrementOrderItem(item)">
                  <i class="fas fa-minus"></i>
                </button>
                <span class="qty-display">{{item.field3}}</span>
                <button class="qty-btn" ng-click="incrementOrderItem(item)">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="qty-btn delete-btn" ng-click="deleteOrderItem(item)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="empty-state" ng-if="(allOrders | filter:{field2: dynamicField2Value}:true).length === 0">
            <div class="empty-icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="empty-text">Your order is empty</div>
            <div class="empty-subtext">Add some products to your order</div>
          </div>
          <div class="order-total" ng-if="orderCount > 0">
            <span>Total</span>
            <span ng-if="priceVisible">{{ calculateOrderTotal() | currency:"₹":0}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enlarged Image Overlay -->
  <div id="enlarged-image-overlay" class="image-overlay">
    <img id="enlarged-image" src="">
    <button class="close-overlay" onclick="angular.element(document.body).scope().closeEnlargedImage()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.firebase.com/libs/angularfire/2.3.0/angularfire.min.js"></script>

  <script>
    // Global flag to track if enlarged image is open
    var isEnlargedImageOpen = false;

    // Error handling for script loading
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Script Error:', {
        message: message,
        source: source,
        line: lineno,
        column: colno,
        error: error
      });
      return true;
    };

    // Back Button Control
    history.pushState({ state: 'home' }, null, location.href);
    window.addEventListener('popstate', function (event) {
      try {
        var productModalEl = document.getElementById('productModal');
        var orderModalEl = document.getElementById('myModal');
        var videoModalEl = document.getElementById('videoModal');
        var enlargedOverlayEl = document.getElementById('enlarged-image-overlay');
        
        var productModal = bootstrap.Modal.getInstance(productModalEl);
        var orderModal = bootstrap.Modal.getInstance(orderModalEl);
        var videoModal = bootstrap.Modal.getInstance(videoModalEl);
        var scope = angular.element(document.body).scope();

        if (!scope) {
          console.error('Angular scope not found');
          return;
        }

        scope.$applyAsync(function() {
          if (isEnlargedImageOpen && enlargedOverlayEl && enlargedOverlayEl.style.display === 'flex') {
            scope.closeEnlargedImage();
            isEnlargedImageOpen = false;
            if (productModal && productModalEl.classList.contains('show')) {
              history.pushState({ state: 'productModal' }, null, location.href);
            } else {
              history.pushState({ state: 'home' }, null, location.href);
            }
            return;
          }

          if (productModal && productModalEl.classList.contains('show')) {
            productModal.hide();
            scope.isProductModalOpen = false;
            history.pushState({ state: 'home' }, null, location.href);
            return;
          }

          if (videoModal && videoModalEl.classList.contains('show')) {
            scope.closeVideoModal();
            if (event.state && event.state.fromProductModal && productModal && productModalEl.classList.contains('show')) {
              history.pushState({ state: 'productModal' }, null, location.href);
            } else {
              history.pushState({ state: 'home' }, null, location.href);
            }
            return;
          }

          if (orderModal && orderModalEl.classList.contains('show')) {
            orderModal.hide();
            history.pushState({ state: 'home' }, null, location.href);
            return;
          }

          if (scope.isSearching || (scope.searchQuery && scope.searchQuery.length > 0)) {
            scope.searchQuery = '';
            scope.isSearching = false;
            scope.onSearchChange();
            history.pushState({ state: 'home' }, null, location.href);
            return;
          }

          history.pushState({ state: 'home' }, null, location.href);
        });
      } catch (e) {
        console.error('Popstate error:', e);
      }
    });

    // Update enlarged image flag
    document.getElementById('enlarged-image-overlay').addEventListener('transitionend', function() {
      isEnlargedImageOpen = this.style.display === 'flex';
    });

    // Login Logic
    (function() {
      var loginConfig = {
        apiKey: "AIzaSyAr8dYBz_D1DVnGfT_fQhTwD1YmtTvuzMk",
        authDomain: "shop-reminder-3ce10.firebaseapp.com",
        databaseURL: "https://shop-reminder-3ce10-default-rtdb.firebaseio.com",
      };
      var blockedNumbers = ['7000913701', '9846434664' , '8269731362', '9876543210', '9123456789', '8987854256', '9039199794', '9166220046', '8269731352', '6263821242', '6616495946', '6266242180', '9109390639', '9658695825', '8576911011'];
      var blockedPageUrl = 'https://www.hindustantoys.in/mywebsite/NEWWEBSITE/blocked.html';

      try {
        var loginApp = firebase.apps.find(app => app.name === 'loginApp') || firebase.initializeApp(loginConfig, 'loginApp');
        var loginDb = loginApp.database();

        window.validateLogin = function() {
          try {
            var nameInput = document.getElementById('name');
            var mobileInput = document.getElementById('mobile');
            var name = nameInput.value.trim();
            var mobile = mobileInput.value.trim();

            if (blockedNumbers.includes(mobile)) {
              window.location.href = blockedPageUrl;
              return;
            }

            if (name.length < 4 || !/^[6-9]\d{9}$/.test(mobile)) {
              alert('Please enter valid details.');
              return;
            }

            loginDb.ref('users').push({ 
              name: name, 
              mobile: mobile, 
              timestamp: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => {
              localStorage.setItem('name', name);
              localStorage.setItem('mobile', mobile);
              showContent(name);
            }).catch(e => {
              console.error("Login Firebase Error:", e);
              alert('Login failed. Please try again.');
            });
          } catch (e) {
            console.error("Validate Login Error:", e);
            alert('An error occurred during login.');
          }
        };

        function showContent(name) {
          try {
            var scope = angular.element(document.body).scope();
            if (scope) {
              scope.$applyAsync(function() { 
                scope.dynamicField2Value = name; 
              });
            }
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            history.pushState({ state: 'home' }, null, location.href);
          } catch (e) {
            console.error("Show Content Error:", e);
          }
        }

        function checkAuthentication() {
          try {
            var name = localStorage.getItem('name');
            var mobile = localStorage.getItem('mobile');

            if (mobile && blockedNumbers.includes(mobile)) {
              window.location.href = blockedPageUrl;
              return;
            }

            if (name && mobile) {
              document.getElementById('name').value = name;
              document.getElementById('mobile').value = mobile;

              loginDb.ref('users').push({ 
                name: name, 
                mobile: mobile, 
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                loginType: 'auto'
              }).catch(e => {
                console.error("Auto-login Firebase Error:", e);
              });

              showContent(name);
            }
          } catch (e) {
            console.error("Check Authentication Error:", e);
          }
        }

        checkAuthentication();
      } catch (e) {
        console.error("Firebase Initialization Error:", e);
        alert('Failed to initialize application. Please check your network and try again.');
      }
    })();
    
    var app = angular.module('myApp', ['firebase']);
    app.controller('imagesController', ['$scope', '$firebaseArray', '$filter', '$window', '$timeout', '$sce', function($scope, $firebaseArray, $filter, $window, $timeout, $sce) {
      try {
        var vm = this;
        vm.images = [];
        $scope.displayedProducts = []; 
        $scope.sortOrder = 'default';
        $scope.dynamicField2Value = localStorage.getItem('name') || '';
        $scope.priceVisible = localStorage.getItem('priceVisible') !== 'false';
        $scope.isOrderModalOpen = false;
        $scope.isEnlargedImageOpen = false;
        $scope.orderCount = 0;
        
        $scope.isLoading = true;
        $scope.isLoadingCategories = true;
        
        $scope.isSearching = false;
        $scope.searchResults = [];
        $scope.isLoadingSearchResults = false;
        $scope.currentVideoUrl = '';
        $scope.videoError = '';
        $scope.isProductModalOpen = false;

        var fetchConfig = { databaseURL: "https://htshop-e9c51-default-rtdb.firebaseio.com" };
        var submitConfig = { databaseURL: "https://notes-12519-default-rtdb.firebaseio.com" };
        
        var fetchApp = firebase.apps.find(app => app.name === 'fetchApp') || firebase.initializeApp(fetchConfig, 'fetchApp');
        var fetchDb = fetchApp.database().ref();

        var submitApp = firebase.apps.find(app => app.name === 'submitApp') || firebase.initializeApp(submitConfig, 'submitApp');
        var submitDb = submitApp.database().ref();

        // Real-time listener for products
        var productsListener = fetchDb.on('value', function(snapshot) {
          const allData = [];
          snapshot.forEach(function(childSnapshot) {
            var item = childSnapshot.val();
            item.$id = childSnapshot.key;
            item.name = item.name || 'Unknown Product';
            item.price = item.price || 0;
            item.url = item.url || '';
            item.videourl = item.videourl || '';
            item.field3 = 0;
            allData.push(item);
          });

          vm.images = allData.filter(item => !item.outOfStock);

          $scope.$applyAsync(function() {
            angular.forEach($scope.categories, function(category) {
              if (category.filter === '') {
                category.productCount = vm.images.length;
              } else {
                category.productCount = $filter('filter')(vm.images, { name: category.filter }).length;
              }
            });
            $scope.isLoading = false;
            $scope.isLoadingCategories = false;
            if (!$scope.activeTabId && $scope.activeTabId !== 0) {
              $scope.activeTabId = 0;
            }
            $scope.selectCategory($scope.categories.find(c => c.id === $scope.activeTabId)?.filter || '', $scope.activeTabId);
          });
        }, function(error) {
          console.error("Error loading products:", error);
          $scope.$applyAsync(function() {
            $scope.isLoading = false;
            $scope.isLoadingCategories = false;
          });
          alert('Failed to load products. Please check your network and try again.');
        });
        
        $scope.allOrders = $firebaseArray(submitDb);
        $scope.activeTabId = 0;
        $scope.activeCategoryName = 'ALL PRODUCTS';
        
        $scope.categories = [
          { id: 0, name: 'ALL PRODUCTS', filter: '', imageUrl: 'https://www.hindustantoys.in/images/all.jpeg' },
          { id: 6, name: 'RACKET', filter: 'RACKET', imageUrl: 'https://www.hindustantoys.in/images/racket.jpeg' },
          { id: 9, name: 'MIX TOYS', filter: 'MIX', imageUrl: 'https://www.hindustantoys.in/images/mix.jpeg' },
          { id: 39, name: 'EDUCATIONAL TOYS', filter: 'EDUCATIONAL', imageUrl: 'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2025-08-23T08%3A21%3A08.778Z_KIDS%20EDUCATIONAL%20CALENDER%20(MIX)_cfb4fb41-e790-4b0a-8cbd-d0f33f1d392b.jpg?alt=media&token=97e8c36a-6efe-4812-a40a-f99ab08b7b09' },
          { id: 41, name: 'BATTERY CAR/JEEP', filter: 'BATTERY CAR', imageUrl: 'https://www.hindustantoys.in/images/Jeep.jpg' },
          { id: 40, name: 'BATTERY BIKES', filter: 'BATTERY BIKE', imageUrl: 'https://www.hindustantoys.in/images/bike.jpg' },
          { id: 38, name: 'UMBRELLA', filter: 'UMBRELLA', imageUrl: 'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2024-06-24T16%3A35%3A31.407Z_RAINBOW%20UMBRELLA_IMG-20240529-WA0047.jpg?alt=media&token=64ee5147-65c7-4de8-897d-55df6cb84857' },
          { id: 10, name: 'LUMO & OTHER', filter: 'LUMO', imageUrl: 'https://www.hindustantoys.in/images/lumo.jpeg' },
          { id: 36, name: 'BAT BALL & SET', filter: 'BAT BALL', imageUrl: 'https://www.hindustantoys.in/images/bat.jpeg' },
          { id: 35, name: 'CARROM BOARD', filter: 'CARROM', imageUrl: 'https://www.hindustantoys.in/images/carrom.jpeg' },
          { id: 37, name: 'SWINGS', filter: 'SWING', imageUrl: 'https://www.hindustantoys.in/images/swing.jpeg' },
          { id: 3, name: 'INDIAN TOYS', filter: 'INDIAN TOYS', imageUrl: 'https://www.hindustantoys.in/images/JCB.jpeg' },
          { id: 13, name: 'BATTERY OPERATED', filter: 'BATTERY', imageUrl: 'https://www.hindustantoys.in/images/battery.jpeg' },
          { id: 34, name: 'VALENTINES/TEDDY', filter: 'TEDDY', imageUrl: 'https://www.hindustantoys.in/images/TEDDY.jpg' },
          { id: 31, name: 'KITCHEN SETS', filter: 'KITCHEN', imageUrl: 'https://www.hindustantoys.in/images/KITCHEN.jpg' },
          { id: 7, name: 'REMOTE CAR', filter: 'REMOTE', imageUrl: 'https://www.hindustantoys.in/images/remote.jpeg' },
          { id: 11, name: 'MAGIC RIDDER', filter: 'RIDDER', imageUrl: 'https://www.hindustantoys.in/images/ridder.jpeg' },
          { id: 25, name: 'HIGH QUALITY', filter: 'HIGH QUALITY', imageUrl: 'https://www.hindustantoys.in/images/high.jpeg' },
          { id: 30, name: 'HT PRODUCTS', filter: 'OWN', imageUrl: 'https://www.hindustantoys.in/images/htquality.jpg' },
          { id: 29, name: 'PALNA', filter: 'PALNA', imageUrl: 'https://www.hindustantoys.in/images/palna.png' },
          { id: 5, name: 'WALKER', filter: 'WALKER', imageUrl: 'https://www.hindustantoys.in/images/walker.jpeg' },
          { id: 28, name: 'LUNCH BOX', filter: 'LUNCH BOX', imageUrl: 'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2025-07-01T08%3A45%3A26.021Z_LUNCH%20BOX_667798d8-2789-471f-985a-8605b19313b1.jpg?alt=media&token=bb3a00ab-a86c-43c5-9e10-d18f4a427451' },
          { id: 27, name: 'PENCIL BOX', filter: 'PENCIL BOX', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=PX' },
          { id: 23, name: 'WATER BOTTLE', filter: 'BOTTLE', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=WB' },
          { id: 26, name: 'BOARD GAME', filter: 'BOARD GAME', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=BG' },
          { id: 22, name: 'EDUCATIONAL', filter: 'EDUCATIONAL', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=ED' },
          { id: 21, name: 'BIG ITEMS', filter: 'BIG', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=BI' },
          { id: 19, name: 'TRICYCLES', filter: 'TRICYCLE', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=TC' },
          { id: 18, name: 'SPORTS ITEM', filter: 'SPORTS', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=SP' },
          { id: 17, name: 'PATTA ITEMS', filter: 'PATTA', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=PT' },
          { id: 15, name: 'GUNS VARIETY', filter: 'GUN', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=GV' },
          { id: 1, name: 'STATIONERY', filter: 'STATIONERY', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=ST' },
          { id: 8, name: 'DOLL', filter: 'DOLL', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=DL' },
          { id: 12, name: 'FANCY ITEMS', filter: 'FANCY', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=FI' },
          { id: 14, name: 'DOZEN PACKING', filter: 'DOZEN', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=DP' },
          { id: 32, name: 'GODOWN-1', filter: 'G1', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=G1' },
          { id: 33, name: 'GODOWN-2', filter: 'G2', imageUrl: 'https://via.placeholder.com/28x28/e1e5e9/6c757d?text=G2' }
        ];
        
        var productModal = null;
        var videoModal = null;
        var orderModal = null;
        
        $timeout(function() {
          try {
            productModal = new bootstrap.Modal(document.getElementById('productModal'));
            videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
            orderModal = new bootstrap.Modal(document.getElementById('myModal'));
          } catch (e) {
            console.error("Modal Initialization Error:", e);
          }
        }, 100);

        // Calculate order count
        $scope.calculateOrderCount = function() {
          try {
            if (!$scope.allOrders || !$scope.dynamicField2Value) return 0;
            var userOrders = $scope.allOrders.filter(item => item.field2 === $scope.dynamicField2Value);
            return userOrders.reduce((sum, item) => sum + (parseInt(item.field3) || 0), 0);
          } catch (e) {
            console.error("Calculate Order Count Error:", e);
            return 0;
          }
        };

        // Watch for order changes
        $scope.$watchCollection('allOrders', function(newVal, oldVal) {
          $scope.orderCount = $scope.calculateOrderCount();
        });

        // Open order modal
        $scope.openOrderModal = function() {
          try {
            $scope.isOrderModalOpen = true;
            history.pushState({ state: 'orderModal' }, null, location.href);
            if (orderModal) orderModal.show();
          } catch (e) {
            console.error("Open Order Modal Error:", e);
          }
        };

        // Search functionality
        $scope.onSearchChange = function() {
          try {
            if ($scope.searchQuery && $scope.searchQuery.length > 0) {
              $scope.isSearching = true;
              $scope.isLoadingSearchResults = true;
              history.pushState({ state: 'search' }, null, location.href);

              $timeout(function() {
                var searchTerm = $scope.searchQuery.toLowerCase();
                $scope.searchResults = vm.images.filter(function(product) {
                  return product.name.toLowerCase().includes(searchTerm) ||
                         (product.price && product.price.toString().includes(searchTerm));
                }) || [];
                
                $scope.isLoadingSearchResults = false;
                $scope.$applyAsync();
              }, 300);
            } else {
              $scope.isSearching = false;
              $scope.searchResults = [];
              history.pushState({ state: 'home' }, null, location.href);
            }
          } catch (e) {
            console.error("Search Change Error:", e);
            $scope.isSearching = false;
            $scope.isLoadingSearchResults = false;
          }
        };
        
        // Select category
        $scope.selectCategory = function(filter, tabId) {
          try {
            $scope.searchQuery = '';
            $scope.isSearching = false;
            $scope.productNameFilter = filter;
            $scope.activeCategoryName = $scope.categories.find(c => c.id === tabId)?.name || 'Products';
            $scope.activeTabId = tabId;
            $scope.updateDisplayedProducts();
            
            if (window.innerWidth <= 768) {
              $timeout(function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
              }, 100);
            }
          } catch (e) {
            console.error("Select Category Error:", e);
          }
        };

        // Set tab for modal view
        $scope.setTab = function(filter, tabId) {
          try {
            $scope.searchQuery = '';
            $scope.isSearching = false;
            $scope.productNameFilter = filter;
            $scope.activeCategoryName = $scope.categories.find(c => c.id === tabId)?.name || 'Products';
            $scope.updateDisplayedProducts();
            $scope.isProductModalOpen = true;
            history.pushState({ state: 'productModal' }, null, location.href);
            if (productModal) productModal.show();
          } catch (e) {
            console.error("Set Tab Error:", e);
          }
        };
        
        // Toggle price visibility
        $scope.togglePriceVisibility = function() {
          try {
            localStorage.setItem('priceVisible', $scope.priceVisible);
          } catch (e) {
            console.error("Toggle Price Visibility Error:", e);
          }
        };

        // Increment order item
        $scope.incrementOrderItem = function(item) {
          try {
            if (item) {
              item.field3 = parseInt(item.field3 || 0) + 1;
              $scope.allOrders.$save(item).catch(e => {
                console.error("Increment Order Item Error:", e);
              });
            }
          } catch (e) {
            console.error("Increment Order Item Error:", e);
          }
        };

        // Decrement order item
        $scope.decrementOrderItem = function(item) {
          try {
            if (item) {
              var newQty = parseInt(item.field3 || 0) - 1;
              if (newQty < 1) {
                $scope.allOrders.$remove(item).catch(e => {
                  console.error("Remove Order Item Error:", e);
                });
              } else {
                item.field3 = newQty;
                $scope.allOrders.$save(item).catch(e => {
                  console.error("Decrement Order Item Error:", e);
                });
              }
            }
          } catch (e) {
            console.error("Decrement Order Item Error:", e);
          }
        };

        // Delete order item
        $scope.deleteOrderItem = function(item) {
          try {
            if (item && confirm('Are you sure you want to remove this item from your order?')) {
              $scope.allOrders.$remove(item).catch(e => {
                console.error("Delete Order Item Error:", e);
              });
            }
          } catch (e) {
            console.error("Delete Order Item Error:", e);
          }
        };
        
        // Calculate order total
        $scope.calculateOrderTotal = function() {
          try {
            var total = 0;
            if (!$scope.allOrders || !$scope.dynamicField2Value) return 0;
            
            var userOrders = $scope.allOrders.filter(item => item.field2 === $scope.dynamicField2Value);
            userOrders.forEach(function(item) {
              total += (parseFloat(item.productPrice) || 0) * (parseInt(item.field3) || 0);
            });
            return total;
          } catch (e) {
            console.error("Calculate Order Total Error:", e);
            return 0;
          }
        };

        // Mark out of stock
        $scope.markOutOfStock = function(image) {
          try {
            if (!image || !image.$id || image.markedForRemoval) return;

            if (!confirm('Are you sure you want to mark this item as out of stock?')) {
              return;
            }

            image.markedForRemoval = true;
            var itemRef = fetchDb.child(image.$id);
            itemRef.update({ 
              outOfStock: true,
              lastModified: firebase.database.ServerValue.TIMESTAMP,
              markedBy: $scope.dynamicField2Value,
              markedAt: new Date().toISOString()
            }).then(function() {
              $timeout(function() {
                const masterIndex = vm.images.findIndex(i => i.$id === image.$id);
                if (masterIndex > -1) vm.images.splice(masterIndex, 1);

                const displayIndex = $scope.displayedProducts.findIndex(p => p.$id === image.$id);
                if (displayIndex > -1) $scope.displayedProducts.splice(displayIndex, 1);
                
                const searchIndex = $scope.searchResults.findIndex(p => p.$id === image.$id);
                if (searchIndex > -1) $scope.searchResults.splice(searchIndex, 1);
                
                alert('Item marked as out of stock successfully.');
              }, 200);
            }).catch(function(error) {
              console.error("Error marking out of stock:", error);
              alert("An error occurred: " + error.message);
              image.markedForRemoval = false;
            });
          } catch (e) {
            console.error("Mark Out of Stock Error:", e);
          }
        };

        // Submit order data
        $scope.submitData = function(image) {
          try {
            if (!image) return;
            
            var baseId = image.$id || image.name.replace(/[^a-zA-Z0-9]/g, '');
            var uniqueId = $scope.dynamicField2Value.replace(/[^a-zA-Z0-9]/g, '') + '-' + baseId;
            
            var recordRef = submitDb.child(uniqueId);

            if (!image.field3 || image.field3 <= 0) {
              recordRef.remove().catch(e => {
                console.error("Remove Order Error:", e);
              });
              return;
            }

            const now = new Date();
            const date = now.toLocaleDateString('en-IN', {day: '2-digit', month: '2-digit', year: 'numeric'});
            const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true }).toUpperCase();

            var dataToSubmit = {
              field1: image.url,
              field2: $scope.dynamicField2Value,
              field3: image.field3,
              productName: image.name,
              productPrice: image.price,
              productId: image.$id,
              serverTimestamp: firebase.database.ServerValue.TIMESTAMP,
              submitDate: date,
              submitTime: time,
              lastUpdated: new Date().toISOString()
            };
            
            recordRef.set(dataToSubmit).then(() => {
              image.justSaved = true;
              $timeout(() => { 
                image.justSaved = false; 
              }, 2000);
            }).catch(error => {
              console.error("Error submitting data:", error);
              alert("Could not save order. Please try again.");
            });
          } catch (e) {
            console.error("Submit Data Error:", e);
          }
        };
        
        // Show enlarged image
        $scope.showEnlargedImage = function(src, fromProductModal) {
          try {
            const overlay = document.getElementById('enlarged-image-overlay');
            const img = document.getElementById('enlarged-image');
            if (overlay && img) {
              img.src = src || '';
              overlay.style.display = 'flex';
              document.body.style.overflow = 'hidden';
              isEnlargedImageOpen = true;
              $scope.isEnlargedImageOpen = true;
              history.pushState({ 
                state: 'enlargedImage', 
                fromProductModal: !!fromProductModal 
              }, null, location.href);
            }
          } catch (e) {
            console.error("Show Enlarged Image Error:", e);
          }
        };

        // Close enlarged image
        $scope.closeEnlargedImage = function() {
          try {
            const overlay = document.getElementById('enlarged-image-overlay');
            if (overlay) {
              overlay.style.display = 'none';
              document.body.style.overflow = 'auto';
              isEnlargedImageOpen = false;
              $scope.isEnlargedImageOpen = false;
              
              var productModalEl = document.getElementById('productModal');
              var productModalInstance = bootstrap.Modal.getInstance(productModalEl);
              if (productModalInstance && productModalEl.classList.contains('show')) {
                history.pushState({ state: 'productModal' }, null, location.href);
              } else {
                history.pushState({ state: 'home' }, null, location.href);
              }
            }
          } catch (e) {
            console.error("Close Enlarged Image Error:", e);
          }
        };
        
        // Show video modal
        $scope.showVideoModal = function(event, videourl, fromProductModal) {
          try {
            if (event) {
              event.preventDefault();
              event.stopPropagation();
            }
            $scope.videoError = '';
            if (videourl) {
              $scope.currentVideoUrl = $sce.trustAsResourceUrl(videourl);
              history.pushState({ 
                state: 'videoModal', 
                fromProductModal: fromProductModal 
              }, null, location.href);
              if (videoModal) videoModal.show();
              
              $timeout(function() {
                var videoElement = document.getElementById('videoPlayer');
                if (videoElement) {
                  videoElement.load();
                  videoElement.onerror = function() {
                    $scope.$applyAsync(function() {
                      $scope.videoError = 'Unable to load video. Please check the URL or try again later.';
                      console.error('Video playback error:', videourl);
                    });
                  };
                  videoElement.onloadeddata = function() {
                    console.log('Video loaded successfully:', videourl);
                  };
                }
              }, 0);
            } else {
              $scope.videoError = 'Video URL not available.';
              console.error('No video URL provided');
            }
          } catch (e) {
            console.error("Show Video Modal Error:", e);
          }
        };

        // Close video modal
        $scope.closeVideoModal = function() {
          try {
            var videoElement = document.getElementById('videoPlayer');
            if (videoElement) {
              videoElement.pause();
              videoElement.currentTime = 0;
            }
            if (videoModal) videoModal.hide();
            $scope.currentVideoUrl = '';
            $scope.videoError = '';
            
            var productModalEl = document.getElementById('productModal');
            var productModalInstance = bootstrap.Modal.getInstance(productModalEl);
            if (productModalInstance && productModalEl.classList.contains('show')) {
              history.pushState({ state: 'productModal' }, null, location.href);
            } else {
              history.pushState({ state: 'home' }, null, location.href);
            }
          } catch (e) {
            console.error("Close Video Modal Error:", e);
          }
        };

        // Update displayed products
        $scope.updateDisplayedProducts = function() {
          try {
            if ($scope.isLoading || !$scope.dynamicField2Value) return;

            let filteredImages = vm.images;
            
            if ($scope.productNameFilter) {
              filteredImages = $filter('filter')(vm.images, { name: $scope.productNameFilter }) || [];
            }
            
            if ($scope.searchQuery && !$scope.productNameFilter && !$scope.isSearching) {
              filteredImages = $filter('filter')(filteredImages, { name: $scope.searchQuery }) || [];
            }

            if ($scope.sortOrder === 'price') {
              filteredImages = $filter('orderBy')(filteredImages, 'price');
            } else if ($scope.sortOrder === '-price') {
              filteredImages = $filter('orderBy')(filteredImages, '-price');
            } else {
              filteredImages = $filter('orderBy')(filteredImages, '-date');
            }
            
            $scope.displayedProducts = filteredImages;
          } catch (e) {
            console.error("Update Displayed Products Error:", e);
          }
        };

        // Logout
        $scope.logout = function() {
          try {
            if (confirm('Are you sure you want to logout?')) {
              fetchDb.off('value', productsListener);
              localStorage.clear();
              $window.location.reload();
            }
          } catch (e) {
            console.error("Logout Error:", e);
          }
        };

        // Modal event listeners
        $timeout(function() {
          try {
            var productModalEl = document.getElementById('productModal');
            if (productModalEl) {
              productModalEl.addEventListener('show.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isProductModalOpen = true;
                });
              });
              productModalEl.addEventListener('hide.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isProductModalOpen = false;
                  history.pushState({ state: 'home' }, null, location.href);
                });
              });
            }

            var videoModalEl = document.getElementById('videoModal');
            if (videoModalEl) {
              videoModalEl.addEventListener('show.bs.modal', function() {
                var productModalEl = document.getElementById('productModal');
                if ($scope.isProductModalOpen && productModalEl.classList.contains('show')) {
                  document.body.classList.add('modal-open');
                  var backdrop = document.querySelector('.modal-backdrop');
                  if (backdrop) {
                    backdrop.style.display = 'block';
                  }
                }
              });
              videoModalEl.addEventListener('hide.bs.modal', function() {
                var productModalEl = document.getElementById('productModal');
                if ($scope.isProductModalOpen && productModalEl.classList.contains('show')) {
                  productModalEl.style.display = 'block';
                  document.body.classList.add('modal-open');
                  if (!document.querySelector('.modal-backdrop')) {
                    var backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                  }
                }
              });
            }

            var orderModalEl = document.getElementById('myModal');
            if (orderModalEl) {
              orderModalEl.addEventListener('show.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isOrderModalOpen = true;
                });
              });
              orderModalEl.addEventListener('hide.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isOrderModalOpen = false;
                });
              });
            }
          } catch (e) {
            console.error("Modal Event Listener Error:", e);
          }
        }, 500);

      } catch (e) {
        console.error("Controller Initialization Error:", e);
        alert('Application initialization failed. Please refresh the page.');
      }
    }]);
  </script>
</body>
</html>
