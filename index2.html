<!DOCTYPE html>
<html lang="en" ng-app="myApp" ng-cloak>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hindustan Toys - Order Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    :root {
      --primary-color: #388e3c;
      --secondary-color: #0d6efd;
      --danger-color: #dc3545;
      --light-gray: #f8f9fa;
      --dark-gray: #333;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    html, body {
      overscroll-behavior: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: var(--dark-gray);
      background-color: var(--light-gray);
      margin: 0;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    [ng-cloak] {
        display: none !important;
    }

    /* Constrain content width to tablet-like size on all devices */
    #content, #login-container {
      max-width: 768px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    #login-container {
      background-size: cover;
      background-position: center;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #inside {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      text-align: center;
      width: 100%;
      max-width: 360px;
    }

    .navbar {
      background-color: #fff;
      padding: 8px 15px;
      position: fixed;
      width: 100%;
      max-width: 768px;
      top: 0;
      z-index: 1030;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      left: 50%;
      transform: translateX(-50%);
    }

    .page-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .section-container {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      padding: 2px;
    }

    .category-grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
    }

    .category-card {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 110px;
    }

    .category-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .category-card img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      margin-bottom: 8px;
      border-radius: 8px;
    }

    .category-card span {
      font-size: 11px;
      font-weight: 500;
      color: #555;
    }

    .modal-body {
      background-color: var(--light-gray);
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .card {
      box-shadow: var(--card-shadow);
      width: 100%;
      border-radius: 8px;
      text-align: center;
      background: #fff;
      overflow: hidden;
      padding-bottom: 8px;
    }

    .card img {
      width: 100%;
      object-fit: contain;
      cursor: pointer;
    }
    
    .containers {
      padding: 8px;
      position: relative;
    }
    .containers h4 {
      margin: 0 0 4px;
      font-size: 13px;
      font-weight: bold;
    }
    .containers p {
      margin: 0 0 4px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      font-size: 11px;
    }
    .containers a.watch-video {
      font-size: 11px;
      color: var(--secondary-color);
      cursor: pointer;
    }

    .qtyclass {
      height: 32px;
      width: 50px;
      margin-right: 5px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      text-align: center;
    }

    .saved-feedback {
      color: var(--primary-color);
      font-size: 10px;
      font-weight: bold;
      position: absolute;
      top: 8px;
      right: 8px;
      animation: fadeOut 2s forwards;
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    .enlarged-image-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1060;
      cursor: pointer;
    }
    .enlarged-image-content {
      max-width: 95%;
      max-height: 95%;
      border-radius: 8px;
      object-fit: contain;
    }

    @keyframes skeleton-pulse {
      0% { background-color: #e0e0e0; }
      50% { background-color: #f0f0f0; }
      100% { background-color: #e0e0e0; }
    }
    .skeleton-card {
      background-color: #fff;
      padding: 0;
    }
    .skeleton-image {
      width: 100%;
      height: 140px;
      animation: skeleton-pulse 1.5s infinite ease-in-out;
    }
    .skeleton-line {
      height: 12px;
      width: 90%;
      margin: 8px auto;
      border-radius: 4px;
      animation: skeleton-pulse 1.5s infinite ease-in-out;
    }
    .skeleton-line.short {
      width: 60%;
    }

    .skeleton-category-card {
      background-color: #e0e0e0;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      padding: 12px;
      text-align: center;
      height: 110px;
      animation: skeleton-pulse 1.5s infinite ease-in-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .skeleton-category-card .icon {
      width: 48px;
      height: 48px;
      background-color: #c0c0c0;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .skeleton-category-card .text {
      height: 11px;
      width: 70%;
      background-color: #c0c0c0;
      border-radius: 4px;
    }

    .order-item-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 15px;
    }
    .qty-control {
      display: flex;
      align-items: center;
    }
    .qty-display {
      width: 40px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }

    .manual-slideshow-container {
      position: relative;
    }

    .manual-slideshow-scroll-wrapper {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto !important;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 10px;
      gap: 12px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .manual-slideshow-scroll-wrapper::-webkit-scrollbar {
      display: none;
    }

    .manual-slideshow-scroll-wrapper .card {
      flex-shrink: 0;
      width: 150px;
      scroll-snap-align: start;
    }

    .manual-slideshow-scroll-wrapper .card img {
      object-fit: cover;
    }
    .manual-slideshow-scroll-wrapper .card .containers {
      padding: 6px;
    }
    .manual-slideshow-scroll-wrapper .card .containers h4 {
      font-size: 12px;
    }
    .manual-slideshow-scroll-wrapper .card .containers p {
      font-size: 10px;
      line-height: 1.2;
    }
    .manual-slideshow-scroll-wrapper .card .containers a.watch-video {
      font-size: 10px;
    }
    .manual-slideshow-scroll-wrapper .card .qtyclass {
      height: 28px;
      width: 45px;
      font-size: 11px;
    }

    .manual-slideshow-controls {
      display: none;
    }

    .view-all-container {
      text-align: right;
      padding: 0 12px 12px;
    }

    .view-all-button {
      display: inline-block;
      color: BLACK;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .video-modal-content {
      max-width: 90%;
      max-height: 90vh;
      margin: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .video-modal-content video {
      width: 100%;
      max-height: 70vh;
      border-radius: 8px;
    }

    .video-modal-content .download-btn {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .video-modal-content .download-btn:hover {
      background-color: #2e7d32;
    }

    .video-error {
      color: var(--danger-color);
      font-size: 12px;
      margin-top: 10px;
      text-align: center;
    }

    #videoModal {
      z-index: 1060;
    }

    .search-results-container {
      max-width: 768px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .modal-dialog {
      max-width: 768px;
      margin: 1.75rem auto;
    }

    /* Updated styles for fixed modal header */
    #productModal .modal-header {
      position: sticky;
      top: 0;
      background-color: #fff;
      z-index: 1050;
      padding: 10px 15px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: nowrap;
    }

    #productModal .modal-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #productModal .sort-container {
      flex-shrink: 0;
      margin-left: 10px;
    }

    #productModal .form-select-sm {
      width: auto;
      min-width: 120px;
      font-size: 12px;
      padding: 4px 8px;
    }
    
    /* Price Filter Inputs */
    .price-filter-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .price-input {
      width: 70px;
      font-size: 12px;
      padding: 4px 6px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    
    .price-clear-btn {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0 4px;
        font-size: 14px;
    }

    #productModal .btn-close {
      flex-shrink: 0;
      margin-left: 10px;
    }

    #productModal .modal-body {
      padding-top: 10px;
    }

    @media (min-width: 768px) {
      #productModal .modal-dialog,
      #myModal .modal-dialog {
        max-width: 768px;
        margin: 1.75rem auto;
      }
      #productModal .modal-content,
      #myModal .modal-content {
        width: 100%;
      }
    }

    @media (max-width: 767.98px) {
      .modal-dialog {
        max-width: none;
        margin: 0;
        width: 100%;
        height: 100%;
      }
      .modal-content {
        height: 100%;
        border-radius: 0;
      }
      #productModal .modal-header {
        flex-wrap: wrap;
        padding: 8px 10px;
      }
      #productModal .modal-title {
        font-size: 16px;
      }
      #productModal .sort-container {
        margin-left: 0;
        margin-top: 5px;
      }
      #productModal .form-select-sm {
        width: 100%;
      }
    }

    /* Fixed Your Order Button */
    .fixed-order-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1070;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 500;
      box-shadow: var(--card-shadow);
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .fixed-order-button:hover {
      background-color: #2e7d32;
      transform: scale(1.05);
    }

    @media (max-width: 767.98px) {
      .fixed-order-button {
        bottom: 10px;
        right: 10px;
        padding: 6px 10px;
        font-size: 11px;
      }
    }

    /* New Layout Styles */
    .main-content-layout {
      display: flex;
      gap: 20px;
      
      max-width: 768px;
      margin: 0 auto;
      min-height: calc(100vh - 70px);
    }

    .sidebar-container {
      flex-shrink: 0;
      width: 180px;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      padding: 20px 12px;
      position: sticky;
      top: 80px;
      align-self: flex-start;
      max-height: calc(100vh - 110px);
      overflow-y: auto;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 20px;
      padding: 0 10px;
      color: var(--dark-gray);
    }

    .vertical-tabs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 14px 10px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      gap: 8px;
      border: 2px solid transparent;
      text-align: center;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    .tab-item:hover {
      background: linear-gradient(135deg, #f0f4f8 0%, #e8eff5 100%);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 12px rgba(56, 142, 60, 0.15);
      border-color: rgba(56, 142, 60, 0.2);
    }

    .tab-item.active {
      background: linear-gradient(135deg, var(--primary-color) 0%, #2e7d32 100%);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 6px 16px rgba(56, 142, 60, 0.3);
      transform: scale(1.03);
    }

    .tab-item.active .tab-text {
      color: white;
      font-weight: 600;
    }

    .tab-item.active .tab-count {
      color: rgba(255, 255, 255, 0.95);
      font-weight: 500;
    }

    .tab-icon-img {
      width: 32px;
      height: 32px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .tab-item:hover .tab-icon-img {
      transform: scale(1.1);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .tab-item.active .tab-icon-img {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .tab-text {
      font-size: 11px;
      font-weight: 500;
      color: var(--dark-gray);
      word-break: break-word;
      text-align: center;
      line-height: 1.3;
      width: 100%;
      transition: color 0.3s ease;
    }

    .tab-count {
      font-size: 9px;
      color: var(--dark-gray);
      opacity: 0.8;
      font-weight: 500;
      margin-top: -2px;
    }

    .tab-loading {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .skeleton-tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 10px;
    }

    .skeleton-tab .tab-icon {
      width: 24px;
      height: 24px;
      background-color: #e0e0e0;
      border-radius: 4px;
      animation: skeleton-pulse 1.5s infinite ease-in-out;
    }

    .skeleton-tab .tab-text {
      height: 12px;
      width: 60%;
      background-color: #e0e0e0;
      border-radius: 4px;
      animation: skeleton-pulse 1.5s infinite ease-in-out;
    }

    .products-container {
      flex: 1;
      min-width: 0;
    }

    .products-header {
      background-color: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .products-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--dark-gray);
    }

    .products-content {
      background-color: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    @media (max-width: 767.98px) {
      .main-content-layout {
        flex-direction: row;
        gap: 10px;
        padding: 0px 5px 20px;
      }

      .sidebar-container {
        width: 95px;
        flex-shrink: 0;
        padding: 12px 8px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        position: sticky;
        top: 0px;
        align-self: flex-start;
        max-height: calc(100vh - 70px);
        overflow-y: auto;
      }

      .sidebar-title {
        font-size: 13px;
        margin-bottom: 12px;
      }

      .vertical-tabs {
        gap: 8px;
      }

      .tab-item {
        padding: 10px 6px;
        gap: 6px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
      }

      .tab-icon-img {
        width: 30px;
        height: 30px;
        margin-bottom: 0;
        border-radius: 6px;
      }

      .tab-text {
        font-size: 9px;
        line-height: 1.2;
        text-align: center;
        word-break: break-word;
        display: block;
        font-weight: 500;
      }

      .tab-count {
        display: none;
      }

      .tab-item:hover {
        box-shadow: 0 4px 10px rgba(56, 142, 60, 0.12);
      }

      .tab-item.active {
        box-shadow: 0 6px 16px rgba(56, 142, 60, 0.3);
      }

      .products-container {
        flex: 1;
        min-width: 0;
      }

      .products-header {
        padding: 10px;
        margin-bottom: 10px;
      }

      .products-title {
        font-size: 16px;
      }

      .products-content {
        padding: 10px;
      }

      .product-grid {
        gap: 8px;
      }
    }

    @media (max-width: 480px) {
      .sidebar-container {
        width: 65px;
        padding: 10px 5px;
      }

      .sidebar-title {
        font-size: 10px;
        writing-mode: vertical-rl;
        text-orientation: upright;
        margin: 0;
        padding: 0;
      }

      .tab-item {
        padding: 8px 4px;
        border-radius: 8px;
      }

      .tab-icon-img {
        width: 26px;
        height: 26px;
        border-radius: 6px;
      }

      .tab-text {
        font-size: 8px;
        line-height: 1.1;
        font-weight: 500;
      }

      .vertical-tabs {
        gap: 6px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body ng-controller="imagesController as vm">
  <div id="login-container" style="background-image: ur[](https://hunkaammy.github.io/mywebsite/NEWWEBSITE/loginpg.jpeg);">
    <div id="inside">
      <h2 class="mb-4">HINDUSTAN TOYS</h2>
      <input type="text" id="name" placeholder="Enter your shop name" class="form-control mb-2" autocomplete="off">
      <input type="tel" id="mobile" placeholder="Enter your mobile number" class="form-control mb-3" autocomplete="off">
      <button class="btn btn-success w-100" onclick="validateLogin()">Login</button>
    </div>
  </div>

  <div id="content" style="display: none;">
    <div class="navbar">
      <div class="d-flex w-100 align-items-center">
        <div class="input-group input-group-sm me-2">
            <input type="text" 
                   ng-model="searchQuery" 
                   ng-change="onSearchChange()" 
                   ng-model-options="{ debounce: 400 }"
                   placeholder="Search all products..." 
                   class="form-control">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
        </div>
        <div class="dropdown">
            <button class="btn btn-light btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#myModal">Your Order</a></li>
                <li><a class="dropdown-item" href="#" ng-click="logout()">Logout</a></li>
            </ul>
        </div>
      </div>
      <div class="d-flex w-100 justify-content-center align-items-center mt-1">
        <small class="text-muted me-3">Welcome, {{dynamicField2Value}}</small>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="priceToggle" ng-model="priceVisible" ng-change="togglePriceVisibility()">
        </div>
      </div>
    </div>

    <button class="fixed-order-button" ng-if="dynamicField2Value && !isOrderModalOpen && !isEnlargedImageOpen" ng-click="openOrderModal()">
      <i class="fas fa-shopping-cart me-1"></i>Your Order
    </button>

    <div class="search-results-container p-3" ng-if="isSearching">
        <h2 class="page-title">Search Results for "{{ searchQuery }}"</h2>
        
        <div ng-if="isLoadingSearchResults" class="product-grid">
            <div class="card skeleton-card" ng-repeat="i in [1,2,3,4]">
                <div class="skeleton-image"></div>
                <div class="containers">
                    <div class="skeleton-line short"></div>
                    <div class="skeleton-line"></div>
                </div>
            </div>
        </div>

        <div ng-if="!isLoadingSearchResults">
            <div class="product-grid">
                 <div class="card" ng-repeat="product in searchResults">
                    <img ng-src="{{product.url}}" alt="{{product.name}}" ng-click="showEnlargedImage(product.url)" loading="lazy">
                    <div class="containers">
                      <span class="saved-feedback" ng-if="product.justSaved">Saved!</span>
                      <h4 ng-if="priceVisible"><b>{{product.price | currency:"₹":0 }}</b></h4>
                      <p>{{product.name}}</p>
                      <p ng-if="product.videourl"><a href="#" class="watch-video" ng-click="showVideoModal($event, product.videourl, false)">Watch Video</a></p>
                      <input type="number" class="qtyclass" placeholder="Qty" ng-model="product.field3" ng-change="submitData(product)" ng-model-options="{ debounce: 800 }">
                    </div>
                </div>
            </div>
            <div ng-if="searchResults.length === 0" class="text-center p-5">
                <p class="text-muted">No products found matching your search.</p>
            </div>
        </div>
    </div>
    
    <div ng-if="!isSearching" class="main-content-layout">
        <div class="sidebar-container">
      
            <div class="vertical-tabs">
                <div class="tab-loading" ng-if="isLoadingCategories">
                    <div class="skeleton-tab" ng-repeat="i in [1,2,3,4,5,6,7,8]">
                        <div class="tab-icon"></div>
                        <div class="tab-text"></div>
                    </div>
                </div>
                <div class="tab-item" 
                     ng-if="!isLoadingCategories"
                     ng-class="{'active': activeTabId === category.id}"
                     ng-click="selectCategory(category.filter, category.id)"
                     ng-repeat="category in categories">
                    <img ng-src="{{category.imageUrl}}" alt="{{category.name}}" class="tab-icon-img">
                    <span class="tab-text">{{category.name}}</span>
                    <small class="tab-count" ng-if="category.productCount > 0">({{category.productCount}})</small>
                </div>
            </div>
        </div>
        
        <div class="products-container">
            <div class="products-header">
                <div class="price-filter-container">
                    <input type="number" class="price-input" placeholder="Min ₹" ng-model="priceFilter.min" ng-change="updateDisplayedProducts()">
                    <span class="text-muted">-</span>
                    <input type="number" class="price-input" placeholder="Max ₹" ng-model="priceFilter.max" ng-change="updateDisplayedProducts()">
                    <button class="price-clear-btn" ng-click="clearPriceFilter()" ng-if="priceFilter.min || priceFilter.max">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            </div>
            
            <div class="products-content">
                <div ng-if="isLoading" class="product-grid">
                    <div class="card skeleton-card" ng-repeat="i in [1,2,3,4,5,6]">
                        <div class="skeleton-image"></div>
                        <div class="containers">
                            <div class="skeleton-line short"></div>
                            <div class="skeleton-line"></div>
                        </div>
                    </div>
                </div>
                
                <div ng-if="!isLoading">
                    <div class="product-grid">
                        <div class="card" ng-repeat="product in displayedProducts" ng-hide="product.markedForRemoval">
                            <img ng-src="{{product.url}}" alt="{{product.name}}" ng-click="showEnlargedImage(product.url, false)" loading="lazy">
                            <button ng-if="dynamicField2Value === 'sammyadmin'" class="btn btn-danger btn-sm mt-2 mx-2" ng-click="markOutOfStock(product)">
                                Mark Out of Stock
                            </button>
                            <div class="containers">
                                <span class="saved-feedback" ng-if="product.justSaved">Saved!</span>
                                <h4 ng-if="priceVisible"><b>{{product.price | currency:"₹":0 }}</b></h4>
                                <p>{{product.name}}</p>
                                <p ng-if="product.videourl"><a href="#" class="watch-video" ng-click="showVideoModal($event, product.videourl, false)">Watch Video</a></p>
                                <input type="number" class="qtyclass" placeholder="Qty" ng-model="product.field3" ng-change="submitData(product)" ng-model-options="{ debounce: 800 }">
                            </div>
                        </div>
                    </div>
                    <div ng-if="displayedProducts.length === 0" class="text-center p-5">
                        <p class="text-muted">No products found in this range.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

  </div>

  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-uppercase">{{ activeCategoryName }}</h5>
          <div class="sort-container">
            <div class="price-filter-container">
                <input type="number" class="price-input" placeholder="Min ₹" ng-model="priceFilter.min" ng-change="updateDisplayedProducts()">
                <span class="text-muted">-</span>
                <input type="number" class="price-input" placeholder="Max ₹" ng-model="priceFilter.max" ng-change="updateDisplayedProducts()">
                <button class="price-clear-btn" ng-click="clearPriceFilter()" ng-if="priceFilter.min || priceFilter.max">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div ng-if="isLoading" class="product-grid">
            </div>
          <div ng-if="!isLoading">
            <div class="product-grid">
              <div class="card" ng-repeat="image in displayedProducts" ng-hide="image.markedForRemoval">
                <img ng-src="{{image.url}}" alt="{{image.name}}" ng-click="showEnlargedImage(image.url, true)" loading="lazy">
                <button ng-if="dynamicField2Value === 'sammyadmin'" class="btn btn-danger btn-sm mt-2 mx-2" ng-click="markOutOfStock(image)">
                  Mark Out of Stock
                </button>
                <div class="containers">
                  <span class="saved-feedback" ng-if="image.justSaved">Saved!</span>
                  <h4 ng-if="priceVisible"><b>{{image.price | currency:"₹":0 }}</b></h4>
                  <p>{{image.name}}</p>
                  <p ng-if="image.videourl"><a href="#" class="watch-video" ng-click="showVideoModal($event, image.videourl, true)">Watch Video</a></p>
                  <input type="number" class="qtyclass" placeholder="Qty" ng-model="image.field3" ng-change="submitData(image)" ng-model-options="{ debounce: 800 }">
                </div>
              </div>
            </div>
            <div ng-if="!isLoading && displayedProducts.length === 0" class="text-center p-5">
              <p class="text-muted">No products found in this range.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content video-modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Product Video</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" ng-click="closeVideoModal()"></button>
        </div>
        <div class="modal-body">
          <video controls autoplay id="videoPlayer">
            <source ng-src="{{currentVideoUrl}}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <p class="video-error" ng-if="videoError">{{videoError}}</p>
        </div>
      </div>
    </div>
  </div>
  
  <div id="enlarged-image-overlay" class="enlarged-image-overlay" ng-click="closeEnlargedImage()"> 
    <img class="enlarged-image-content" id="enlarged-image" src=""> 
  </div>
  
  <div class="modal fade" id="myModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{dynamicField2Value}}'s Order List</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center" ng-repeat="item in allOrders | filter:isPendingOrder | orderBy:'-serverTimestamp'">
              <div class="d-flex align-items-center">
                <img ng-src="{{item.field1}}" class="order-item-img">
                <div>
                  <div class="fw-bold">{{item.productName}}</div>
                  <small class="text-muted" ng-if="priceVisible">{{item.productPrice | currency:"₹":0 }}</small>
                </div>
              </div>
              <div class="d-flex align-items-center">
                  <div class="qty-control">
                      <button class="btn btn-secondary btn-sm" ng-click="decrementOrderItem(item)">-</button>
                      <span class="qty-display">{{item.field3}}</span>
                      <button class="btn btn-secondary btn-sm" ng-click="incrementOrderItem(item)">+</button>
                  </div>
                <button class="btn btn-outline-danger btn-sm ms-3" ng-click="deleteOrderItem(item)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </li>
          </ul>
          <div ng-if="(allOrders | filter:isPendingOrder).length === 0" class="text-center p-5">
            <p class="text-muted">You have no pending items.</p>
          </div>
        </div>
        <div class="modal-footer">
            <strong class="me-auto" ng-if="priceVisible">Total: {{ calculateOrderTotal() | currency:"₹":0 }}</strong>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.firebase.com/libs/angularfire/2.3.0/angularfire.min.js"></script>

  <script>
    // Global flag to track if enlarged image is open
    var isEnlargedImageOpen = false;

    // Error handling for script loading
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Script Error:', {
        message: message,
        source: source,
        line: lineno,
        column: colno,
        error: error
      });
      alert('An error occurred. Please try refreshing the page.');
      return true;
    };

    // Back Button Control
    history.pushState({ state: 'home' }, null, location.href);
    window.addEventListener('popstate', function (event) {
      try {
        var productModalEl = document.getElementById('productModal');
        var orderModalEl = document.getElementById('myModal');
        var videoModalEl = document.getElementById('videoModal');
        var enlargedOverlayEl = document.getElementById('enlarged-image-overlay');
        
        var productModal = bootstrap.Modal.getInstance(productModalEl);
        var orderModal = bootstrap.Modal.getInstance(orderModalEl);
        var videoModal = bootstrap.Modal.getInstance(videoModalEl);
        var scope = angular.element(document.body).scope();

        if (!scope) {
          console.error('Angular scope not found');
          return;
        }

        scope.$applyAsync(function() {
          if (isEnlargedImageOpen && enlargedOverlayEl && enlargedOverlayEl.style.display === 'flex') {
            scope.closeEnlargedImage();
            isEnlargedImageOpen = false;
            if (productModal && productModalEl.classList.contains('show')) {
              history.pushState({ state: 'productModal' }, null, location.href);
            } else {
              history.pushState({ state: 'home' }, null, location.href);
            }
            return;
          }

          if (productModal && productModalEl.classList.contains('show')) {
            productModal.hide();
            scope.isProductModalOpen = false;
            history.pushState({ state: 'home' }, null, location.href);
            return;
          }

          if (videoModal && videoModalEl.classList.contains('show')) {
            scope.closeVideoModal();
            if (event.state && event.state.fromProductModal && productModal && productModalEl.classList.contains('show')) {
              history.pushState({ state: 'productModal' }, null, location.href);
            } else {
              history.pushState({ state: 'home' }, null, location.href);
            }
            return;
          }

          if (orderModal && orderModalEl.classList.contains('show')) {
            orderModal.hide();
            history.pushState({ state: 'home' }, null, location.href);
            return;
          }

          if (scope.isSearching || (scope.searchQuery && scope.searchQuery.length > 0)) {
            scope.searchQuery = '';
            scope.isSearching = false;
            scope.onSearchChange();
            history.pushState({ state: 'home' }, null, location.href);
            return;
          }

          history.pushState({ state: 'home' }, null, location.href);
        });
      } catch (e) {
        console.error('Popstate error:', e);
      }
    });

    // Update enlarged image flag
    document.getElementById('enlarged-image-overlay').addEventListener('transitionend', function() {
      isEnlargedImageOpen = this.style.display === 'flex';
    });

    // Login Logic
    (function() {
      var loginConfig = {
        apiKey: "AIzaSyAr8dYBz_D1DVnGfT_fQhTwD1YmtTvuzMk",
        authDomain: "shop-reminder-3ce10.firebaseapp.com",
        databaseURL: "https://shop-reminder-3ce10-default-rtdb.firebaseio.com",
      };
      
      var blockedNumbers = ['7000913701', '9846434664' , '8269731362', '9876543210', '9123456789', '8987854256', '9039199794', '9166220046', '8269731352', '6263821242', '6616495946', '6266242180', '9109390639', '7000619513', '8576911011' , '9999999999'];
      var blockedNames = ['Spammer', 'Mhgghj hyhh', 'TestUser']; 
      var blockedPageUrl = 'https://www.hindustantoys.in/mywebsite/NEWWEBSITE/blocked.html';

      try {
        var loginApp = firebase.apps.find(app => app.name === 'loginApp') || firebase.initializeApp(loginConfig, 'loginApp');
        var loginDb = loginApp.database();

        window.validateLogin = function() {
          try {
            var nameInput = document.getElementById('name');
            var mobileInput = document.getElementById('mobile');
            var name = nameInput.value.trim();
            var mobile = mobileInput.value.trim();

            var isNameBlocked = blockedNames.some(blockedName => blockedName.toLowerCase() === name.toLowerCase());

            if (blockedNumbers.includes(mobile) || isNameBlocked) {
              window.location.href = blockedPageUrl;
              return;
            }

            if (name.length < 4 || !/^[6-9]\d{9}$/.test(mobile)) {
              alert('Please enter valid details.');
              return;
            }

            loginDb.ref('users').push({ 
              name: name, 
              mobile: mobile, 
              timestamp: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => {
              localStorage.setItem('name', name);
              localStorage.setItem('mobile', mobile);
              showContent(name);
            }).catch(e => {
              console.error("Login Firebase Error:", e);
              alert('Login failed. Please try again.');
            });
          } catch (e) {
            console.error("Validate Login Error:", e);
            alert('An error occurred during login.');
          }
        };
        
        function showContent(name) {
          try {
            var scope = angular.element(document.body).scope();
            if (scope) {
              scope.$applyAsync(function() { 
                scope.dynamicField2Value = name; 
                // Force update now that we have the name
                if(scope.updateDisplayedProducts) {
                    setTimeout(function() {
                        scope.$apply(function() {
                            scope.updateDisplayedProducts();
                        });
                    }, 100);
                }
              });
            }
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            history.pushState({ state: 'home' }, null, location.href);
          } catch (e) {
            console.error("Show Content Error:", e);
          }
        }

        function checkAuthentication() {
          try {
            var name = localStorage.getItem('name');
            var mobile = localStorage.getItem('mobile');

            if (name && mobile) {
                var isNameBlocked = blockedNames.some(blockedName => blockedName.toLowerCase() === name.toLowerCase());
                if (blockedNumbers.includes(mobile) || isNameBlocked) {
                  window.location.href = blockedPageUrl;
                  return;
                }
            
                document.getElementById('name').value = name;
                document.getElementById('mobile').value = mobile;

                loginDb.ref('users').push({ 
                  name: name, 
                  mobile: mobile, 
                  timestamp: firebase.database.ServerValue.TIMESTAMP,
                  loginType: 'auto'
                }).catch(e => {
                  console.error("Auto-login Firebase Error:", e);
                });

                showContent(name);
            }
          } catch (e) {
            console.error("Check Authentication Error:", e);
          }
        }

        checkAuthentication();
      } catch (e) {
        console.error("Firebase Initialization Error:", e);
        alert('Failed to initialize application. Please check your network and try again.');
      }
    })();
    
    var app = angular.module('myApp', ['firebase']);
    app.controller('imagesController', ['$scope', '$firebaseArray', '$filter', '$window', '$timeout', '$sce', function($scope, $firebaseArray, $filter, $window, $timeout, $sce) {
      try {
        var vm = this;
        vm.images = [];
        $scope.displayedProducts = []; 
        
        $scope.priceFilter = {
            min: null,
            max: null
        };

        $scope.dynamicField2Value = localStorage.getItem('name') || '';
        $scope.priceVisible = localStorage.getItem('priceVisible') !== 'false';
        $scope.isOrderModalOpen = false;
        $scope.isEnlargedImageOpen = false;
        
        $scope.isLoading = true;
        $scope.isLoadingCategories = true;
        
        $scope.isSearching = false;
        $scope.searchResults = [];
        $scope.isLoadingSearchResults = false;
        $scope.currentVideoUrl = '';
        $scope.videoError = '';
        $scope.isProductModalOpen = false;

        var fetchConfig = { databaseURL: "https://pagdi-6f8ce-default-rtdb.firebaseio.com" };
        var submitConfig = { databaseURL: "https://notes-12519-default-rtdb.firebaseio.com" };
        
        var fetchApp = firebase.apps.find(app => app.name === 'fetchApp') || firebase.initializeApp(fetchConfig, 'fetchApp');
        var fetchDb = fetchApp.database().ref();

        var submitApp = firebase.apps.find(app => app.name === 'submitApp') || firebase.initializeApp(submitConfig, 'submitApp');
        var submitDb = submitApp.database().ref();

        // Real-time listener for products
        var productsListener = fetchDb.on('value', function(snapshot) {
          const allData = [];
          snapshot.forEach(function(childSnapshot) {
            var item = childSnapshot.val();
            item.$id = childSnapshot.key;
            
            if (item.price !== undefined && item.price !== null) {
                var cleanPrice = String(item.price).replace(/[^0-9.]/g, '');
                item.price = Number(cleanPrice) || 0;
            } else {
                item.price = 0;
            }
            
            allData.push(item);
          });

          vm.images = allData.filter(item => !item.outOfStock);

          $scope.$applyAsync(function() {
            angular.forEach($scope.categories, function(category) {
              if (category.filter === '') {
                category.productCount = vm.images.length;
              } else {
                category.productCount = $filter('filter')(vm.images, { name: category.filter }).length;
              }
            });
            $scope.isLoading = false;
            $scope.isLoadingCategories = false;
            // Select first category by default
            if (!$scope.activeTabId && $scope.activeTabId !== 0) {
              $scope.activeTabId = 0;
            }
            $scope.selectCategory($scope.categories.find(c => c.id === $scope.activeTabId)?.filter || '', $scope.activeTabId);
          });
        }, function(error) {
          console.error("Error loading products:", error);
          $scope.$applyAsync(function() {
            $scope.isLoading = false;
            $scope.isLoadingCategories = false;
          });
          alert('Failed to load products. Please check your network and try again.');
        });
        
        $scope.allOrders = $firebaseArray(submitDb);
        $scope.activeTabId = 0;
        $scope.activeCategoryName = 'ALL PRODUCTS';
        
        $scope.categories = [
          { id: 0, name: 'DULHA PAGDI', filter: 'DULHA PAGDI', imageUrl: 'https://firebasestorage.googleapis.com/v0/b/pagdi-6f8ce.appspot.com/o/2026-02-02T11%3A20%3A30.763Z_DEMO_811db638-75f1-4860-8360-5f03ed23045a.jpg?alt=media&token=c111842b-3e49-454f-8fbf-19a8d7a87eaf' },
          { id: 42, name: 'VAR VADHU MALA', filter: 'VAR VADHU MALA', imageUrl: 'https://www.hindustantoys.in/images/DUMMY.jpeg' },
         { id: 6, name: 'PAN MOTI MALA', filter: 'PAN MOTI MALA', imageUrl: 'https://www.hindustantoys.in/images/DUMMY.jpeg' },
          { id: 9, name: 'SAMDHI MALA', filter: 'SAMDHI MALA', imageUrl: 'https://www.hindustantoys.in/images/DUMMY.jpeg' }
          //{ id: 39, name: 'EDUCATIONAL TOYS', filter: 'EDUCATIONAL', imageUrl: 'https://www.hindustantoys.in/images/DUMMY.jpeg' },
           
        ];
        
        var productModal = null;
        var videoModal = null;
        $timeout(function() {
          try {
            productModal = new bootstrap.Modal(document.getElementById('productModal'));
            videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
          } catch (e) {
            console.error("Modal Initialization Error:", e);
          }
        }, 0);

        $scope.openOrderModal = function() {
          try {
            var orderModalEl = document.getElementById('myModal');
            var orderModal = bootstrap.Modal.getInstance(orderModalEl) || new bootstrap.Modal(orderModalEl);
            orderModal.show();
          } catch (e) {
            console.error("Open Order Modal Error:", e);
          }
        };

        $scope.onSearchChange = function() {
          try {
            if ($scope.searchQuery && $scope.searchQuery.length > 0) {
              $scope.isSearching = true;
              $scope.isLoadingSearchResults = true;
              history.pushState({ state: 'search' }, null, location.href);

              $timeout(function() {
                // Keep search results broad
                $scope.searchResults = $filter('filter')(vm.images, { name: $scope.searchQuery }) || [];
                $scope.isLoadingSearchResults = false;
              }, 100);
            } else {
              $scope.isSearching = false;
              $scope.searchResults = [];
              history.pushState({ state: 'home' }, null, location.href);
            }
          } catch (e) {
            console.error("Search Change Error:", e);
            $scope.isSearching = false;
            $scope.isLoadingSearchResults = false;
          }
        };
        
        $scope.selectCategory = function(filter, tabId) {
          try {
            $scope.searchQuery = '';
            $scope.isSearching = false;
            $scope.productNameFilter = filter;
            $scope.activeCategoryName = $scope.categories.find(c => c.id === tabId)?.name || 'Products';
            $scope.activeTabId = tabId;
            // Clear price filter when changing category
            $scope.priceFilter.min = null;
            $scope.priceFilter.max = null;
            $scope.updateDisplayedProducts();
            $timeout(function() {
              window.scrollTo(0, 0);
            }, 0);
          } catch (e) {
            console.error("Select Category Error:", e);
          }
        };
        
        $scope.clearPriceFilter = function() {
            $scope.priceFilter.min = null;
            $scope.priceFilter.max = null;
            $scope.updateDisplayedProducts();
        };

        $scope.setTab = function(filter, tabId) {
          try {
            $scope.searchQuery = '';
            $scope.isSearching = false;
            $scope.productNameFilter = filter;
            $scope.activeCategoryName = $scope.categories.find(c => c.id === tabId)?.name || 'Products';
            // Clear price filter when opening new tab
            $scope.priceFilter.min = null;
            $scope.priceFilter.max = null;
            $scope.updateDisplayedProducts();
            $scope.isProductModalOpen = true;
            history.pushState({ state: 'productModal' }, null, location.href);
            if (productModal) productModal.show();
          } catch (e) {
            console.error("Set Tab Error:", e);
          }
        };
        
        $scope.togglePriceVisibility = function() {
          try {
            localStorage.setItem('priceVisible', $scope.priceVisible);
          } catch (e) {
            console.error("Toggle Price Visibility Error:", e);
          }
        };

        $scope.incrementOrderItem = function(item) {
          try {
            if (item) {
              item.field3 = parseInt(item.field3 || 0) + 1;
              $scope.allOrders.$save(item).catch(e => {
                console.error("Increment Order Item Error:", e);
              });
            }
          } catch (e) {
            console.error("Increment Order Item Error:", e);
          }
        };

        $scope.decrementOrderItem = function(item) {
          try {
            if (item) {
              var newQty = parseInt(item.field3 || 0) - 1;
              if (newQty < 1) newQty = 1;
              item.field3 = newQty;
              $scope.allOrders.$save(item).catch(e => {
                console.error("Decrement Order Item Error:", e);
              });
            }
          } catch (e) {
            console.error("Decrement Order Item Error:", e);
          }
        };

        $scope.deleteOrderItem = function(item) {
          try {
            if (item) {
              $scope.allOrders.$remove(item).catch(e => {
                console.error("Delete Order Item Error:", e);
              });
            }
          } catch (e) {
            console.error("Delete Order Item Error:", e);
          }
        };
        
        // NEW FILTER: Checks if name matches AND item is not 'completed'
        $scope.isPendingOrder = function(item) {
            return item.field2 === $scope.dynamicField2Value && item.status !== 'completed';
        };

        // UPDATED: Calculates total only for PENDING items
        $scope.calculateOrderTotal = function() {
          try {
            var total = 0;
            if (!$scope.allOrders) return 0;
            for (var i = 0; i < $scope.allOrders.length; i++) {
              var item = $scope.allOrders[i];
              // Use the same logic as the filter: match Name AND NOT completed
              if (item.field2 === $scope.dynamicField2Value && item.status !== 'completed') {
                total += (parseFloat(item.productPrice) || 0) * (parseInt(item.field3) || 0);
              }
            }
            return total;
          } catch (e) {
            console.error("Calculate Order Total Error:", e);
            return 0;
          }
        };

        $scope.markOutOfStock = function(image) {
          try {
            if (!image || !image.$id || image.markedForRemoval) return;

            image.markedForRemoval = true;
            var itemRef = fetchDb.child(image.$id);
            itemRef.update({ 
              outOfStock: true,
              lastModified: firebase.database.ServerValue.TIMESTAMP 
            }).then(function() {
              $timeout(function() {
                const masterIndex = vm.images.findIndex(i => i.$id === image.$id);
                if (masterIndex > -1) vm.images.splice(masterIndex, 1);

                const displayIndex = $scope.displayedProducts.findIndex(p => p.$id === image.$id);
                if (displayIndex > -1) $scope.displayedProducts.splice(displayIndex, 1);
              }, 200);
            }).catch(function(error) {
              console.error("Error marking out of stock:", error);
              alert("An error occurred: " + error.message);
              image.markedForRemoval = false;
            });
          } catch (e) {
            console.error("Mark Out of Stock Error:", e);
          }
        };

        $scope.submitData = function(image) {
          try {
            if (!image) return;
            var baseId = image.$id || image.name.replace(/[^a-zA-Z0-9]/g, '');
            var uniqueId = $scope.dynamicField2Value.replace(/[^a-zA-Z0-9]/g, '') + '-' + baseId;
            
            var recordRef = submitDb.child(uniqueId);

            if (!image.field3 || image.field3 <= 0) {
              recordRef.remove().catch(e => {
                console.error("Remove Order Error:", e);
              });
              return;
            }

            const now = new Date();
            const date = now.toLocaleDateString('en-IN', {day: '2-digit', month: '2-digit', year: 'numeric'});
            const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true }).toUpperCase();

            var dataToSubmit = {
              field1: image.url,
              field2: $scope.dynamicField2Value,
              field3: image.field3,
              productName: image.name,
              productPrice: image.price,
              serverTimestamp: firebase.database.ServerValue.TIMESTAMP,
              submitDate: date,
              submitTime: time
            };
            
            recordRef.set(dataToSubmit).then(() => {
              image.justSaved = true;
              $timeout(() => { image.justSaved = false; }, 2000);
            }).catch(error => {
              console.error("Error submitting data:", error);
              alert("Could not save order: " + error.message);
            });
          } catch (e) {
            console.error("Submit Data Error:", e);
          }
        };
        
        $scope.showEnlargedImage = function(src, fromProductModal) {
          try {
            const overlay = document.getElementById('enlarged-image-overlay');
            if (overlay) {
              overlay.style.display = 'flex';
              overlay.querySelector('img').src = src || '';
              isEnlargedImageOpen = true;
              $scope.isEnlargedImageOpen = true;
              $scope.$applyAsync();
              history.pushState({ state: 'enlargedImage', fromProductModal: !!fromProductModal }, null, location.href);
            }
          } catch (e) {
            console.error("Show Enlarged Image Error:", e);
          }
        };

        $scope.closeEnlargedImage = function() {
          try {
            const overlay = document.getElementById('enlarged-image-overlay');
            if (overlay) {
              overlay.style.display = 'none';
              isEnlargedImageOpen = false;
              $scope.isEnlargedImageOpen = false;
              $scope.$applyAsync();
              var productModalEl = document.getElementById('productModal');
              var productModal = bootstrap.Modal.getInstance(productModalEl);
              if (productModal && productModalEl.classList.contains('show')) {
                history.pushState({ state: 'productModal' }, null, location.href);
              } else {
                history.pushState({ state: 'home' }, null, location.href);
              }
            }
          } catch (e) {
            console.error("Close Enlarged Image Error:", e);
          }
        };
        
        $scope.showVideoModal = function(event, videourl, fromProductModal) {
          try {
            if (event) {
              event.preventDefault();
              event.stopPropagation();
            }
            $scope.videoError = '';
            if (videourl) {
              $scope.currentVideoUrl = $sce.trustAsResourceUrl(videourl);
              history.pushState({ state: 'videoModal', fromProductModal: fromProductModal }, null, location.href);
              if (videoModal) videoModal.show();
              
              $timeout(function() {
                var videoElement = document.getElementById('videoPlayer');
                if (videoElement) {
                  videoElement.load();
                  videoElement.onerror = function() {
                    $scope.$applyAsync(function() {
                      $scope.videoError = 'Error loading video. Please check the URL or try again later.';
                      console.error('Video playback error:', videourl);
                    });
                  };
                  videoElement.onloadeddata = function() {
                    console.log('Video loaded successfully:', videourl);
                  };
                }
              }, 0);
            } else {
              $scope.videoError = 'No video URL provided.';
              console.error('No video URL provided');
            }
          } catch (e) {
            console.error("Show Video Modal Error:", e);
          }
        };

        $scope.closeVideoModal = function() {
          try {
            var videoElement = document.getElementById('videoPlayer');
            if (videoElement) {
              videoElement.pause();
              videoElement.currentTime = 0;
            }
            if (videoModal) videoModal.hide();
            $scope.currentVideoUrl = '';
            $scope.videoError = '';
            var productModalEl = document.getElementById('productModal');
            var productModal = bootstrap.Modal.getInstance(productModalEl);
            if (productModal && productModalEl.classList.contains('show')) {
              history.pushState({ state: 'productModal' }, null, location.href);
            } else {
              history.pushState({ state: 'home' }, null, location.href);
            }
          } catch (e) {
            console.error("Close Video Modal Error:", e);
          }
        };

        $scope.updateDisplayedProducts = function() {
          try {
            if ($scope.isLoading || !$scope.dynamicField2Value) return;

            let filteredImages = vm.images.slice(); // Copy the array

            // 1. Filter by Category
            if ($scope.productNameFilter) {
              filteredImages = $filter('filter')(filteredImages, { name: $scope.productNameFilter }) || [];
            }
            
            // 2. Filter by Search
            if ($scope.searchQuery) {
              filteredImages = $filter('filter')(filteredImages, { name: $scope.searchQuery }) || [];
            }

            // 3. Filter by Price Range (Min / Max)
            var min = $scope.priceFilter.min;
            var max = $scope.priceFilter.max;
            
            // Debugging
            console.log("Filtering Prices:", min, max);

            filteredImages = filteredImages.filter(function(item) {
                var price = item.price; // Already a number
                
                // If min is set, price must be >= min
                if (min !== null && min !== undefined && price < min) {
                    return false;
                }
                // If max is set, price must be <= max
                if (max !== null && max !== undefined && price > max) {
                    return false;
                }
                return true;
            });

            // 4. Default Sort: Newest first (reverse chronological)
            filteredImages = $filter('orderBy')(filteredImages, '-date');
            
            $scope.displayedProducts = filteredImages;
          } catch (e) {
            console.error("Update Displayed Products Error:", e);
          }
        };

        $scope.logout = function() {
          try {
            // Unsubscribe from real-time listener on logout
            fetchDb.off('value', productsListener);
            localStorage.clear();
            $window.location.reload();
          } catch (e) {
            console.error("Logout Error:", e);
          }
        };

        // Modal event listeners
        $timeout(function() {
          try {
            var productModalEl = document.getElementById('productModal');
            if (productModalEl) {
              productModalEl.addEventListener('show.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isProductModalOpen = true;
                });
              });
              productModalEl.addEventListener('hide.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isProductModalOpen = false;
                  history.pushState({ state: 'home' }, null, location.href);
                });
              });
            }

            var videoModalEl = document.getElementById('videoModal');
            if (videoModalEl) {
              videoModalEl.addEventListener('show.bs.modal', function() {
                var productModalEl = document.getElementById('productModal');
                if ($scope.isProductModalOpen && productModalEl.classList.contains('show')) {
                  document.body.classList.add('modal-open');
                  var backdrop = document.querySelector('.modal-backdrop');
                  if (backdrop) {
                    backdrop.style.display = 'block';
                  }
                }
              });
              videoModalEl.addEventListener('hide.bs.modal', function() {
                var productModalEl = document.getElementById('productModal');
                if ($scope.isProductModalOpen && productModalEl.classList.contains('show')) {
                  productModalEl.style.display = 'block';
                  document.body.classList.add('modal-open');
                  if (!document.querySelector('.modal-backdrop')) {
                    var backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                  }
                }
              });
            }

            var orderModalEl = document.getElementById('myModal');
            if (orderModalEl) {
              orderModalEl.addEventListener('show.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isOrderModalOpen = true;
                });
              });
              orderModalEl.addEventListener('hide.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isOrderModalOpen = false;
                });
              });
            }
          } catch (e) {
            console.error("Modal Event Listener Error:", e);
          }
        }, 0);
      } catch (e) {
        console.error("Controller Initialization Error:", e);
        alert('Application initialization failed. Please refresh the page.');
      }
    }]);
  </script>
</body>
</html>








