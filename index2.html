<!DOCTYPE html>
<html lang="en" ng-app="myApp" ng-cloak>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hindustan Toys - Order Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    :root {
      --primary-color: #388e3c;
      --secondary-color: #0d6efd;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --light-gray: #f8f9fa;
      --dark-gray: #333;
      --medium-gray: #6c757d;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --card-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    html, body {
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: var(--dark-gray);
      background-color: #f5f7fa;
      margin: 0;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    
    [ng-cloak] {
      display: none !important;
    }

    /* Login Container */
    #login-container {
      background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://hunkaammy.github.io/mywebsite/NEWWEBSITE/loginpg.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #inside {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      text-align: center;
      width: 100%;
      max-width: 400px;
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #inside h2 {
      color: var(--primary-color);
      font-weight: 700;
      margin-bottom: 30px;
      font-size: 24px;
    }

    #inside input {
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      transition: all 0.3s ease;
      font-size: 15px;
    }

    #inside input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.1);
      outline: none;
    }

    #inside button {
      padding: 12px;
      font-weight: 600;
      font-size: 16px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--primary-color), #2e7d32);
      border: none;
      transition: all 0.3s ease;
    }

    #inside button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(56, 142, 60, 0.3);
    }

    /* Main Content Container */
    #content, .search-results-container {
      max-width: 768px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    /* Navbar */
    .navbar {
      background: rgba(255, 255, 255, 0.98);
      padding: 12px 15px;
      position: fixed;
      width: 100%;
      max-width: 768px;
      top: 0;
      z-index: 1030;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      left: 50%;
      transform: translateX(-50%);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .search-box {
      flex: 1;
      position: relative;
    }

    .search-box input {
      padding: 10px 15px 10px 40px;
      border-radius: 25px;
      border: 2px solid #e1e5e9;
      background: #f8f9fa;
      font-size: 14px;
      transition: all 0.3s ease;
      width: 100%;
    }

    .search-box input:focus {
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.1);
      outline: none;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--medium-gray);
      font-size: 14px;
    }

    /* Menu Dropdown */
    .menu-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      background: #f8f9fa;
      border: none;
    }

    .menu-btn:hover {
      background: #e9ecef;
      transform: rotate(90deg);
    }

    .dropdown-menu {
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      border: none;
      padding: 8px;
      margin-top: 10px;
    }

    .dropdown-item {
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dropdown-item:hover {
      background: #f8f9fa;
      transform: translateX(5px);
    }

    /* Price Toggle */
    .price-toggle-container {
      background: #f8f9fa;
      padding: 6px 12px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--medium-gray);
      font-weight: 500;
    }

    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .form-check-input:focus {
      box-shadow: 0 0 0 0.25rem rgba(56, 142, 60, 0.25);
    }

    /* Product Grid - IMPROVED FOR MOBILE */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      padding: 5px;
    }

    @media (max-width: 767.98px) {
      .product-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 8px;
      }
    }

    @media (max-width: 480px) {
      .product-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }

    /* Product Card */
    .card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: var(--card-shadow-hover);
    }

    /* Image Container - FIXED FOR MOBILE */
    .card-image-container {
      position: relative;
      width: 100%;
      padding-top: 100%; /* Creates square aspect ratio */
      overflow: hidden;
      background: linear-gradient(135deg, #f5f7fa, #e4e8ed);
    }

    .card img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain; /* Ensures full image fits within container */
      padding: 15px;
      cursor: pointer;
      transition: transform 0.5s ease;
      transform-origin: center;
    }

    .card img:hover {
      transform: scale(1.05);
    }

    /* Zoom Icon on Image */
    .zoom-indicator {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .card-image-container:hover .zoom-indicator {
      opacity: 1;
    }

    /* Card Content */
    .card-content {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 8px;
      color: var(--dark-gray);
      min-height: 36px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-price {
      color: var(--primary-color);
      font-weight: 700;
      font-size: 16px;
      margin: 8px 0;
    }

    .card-actions {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Quantity Input */
    .qtyclass {
      width: 100%;
      height: 38px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      background: #f8f9fa;
      transition: all 0.3s ease;
    }

    .qtyclass:focus {
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.1);
      outline: none;
    }

    /* Watch Video Button */
    .watch-video-btn {
      width: 100%;
      height: 36px;
      background: linear-gradient(135deg, var(--secondary-color), #0b5ed7);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .watch-video-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(13, 110, 253, 0.25);
    }

    .watch-video-btn i {
      font-size: 12px;
    }

    /* Fixed Your Order Button */
    .fixed-order-button {
      position: fixed;
      bottom: 25px;
      right: 25px;
      z-index: 1070;
      background: linear-gradient(135deg, var(--primary-color), #2e7d32);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 14px 22px;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 10px 30px rgba(56, 142, 60, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }

    .fixed-order-button:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 15px 35px rgba(56, 142, 60, 0.5);
    }

    .fixed-order-button .badge {
      background: rgba(255, 255, 255, 0.25);
      border-radius: 12px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      backdrop-filter: blur(5px);
    }

    @media (max-width: 767.98px) {
      .fixed-order-button {
        bottom: 20px;
        right: 20px;
        padding: 12px 18px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .fixed-order-button {
        bottom: 15px;
        right: 15px;
        padding: 10px 16px;
        font-size: 12px;
      }
    }

    /* Main Layout */
    .main-content-layout {
      display: flex;
      gap: 20px;
      max-width: 768px;
      margin: 0 auto;
      min-height: calc(100vh - 70px);
      padding-top: 80px;
      padding-bottom: 100px;
    }

    /* Sidebar - IMPROVED FOR MOBILE */
    .sidebar-container {
      flex-shrink: 0;
      width: 180px;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      padding: 20px 12px;
      position: sticky;
      top: 90px;
      align-self: flex-start;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #c1c1c1 transparent;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .sidebar-container::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }

    @media (max-width: 767.98px) {
      .main-content-layout {
        flex-direction: row;
        gap: 10px;
        padding: 80px 10px 100px;
      }

      .sidebar-container {
        width: 85px;
        padding: 15px 8px;
        position: fixed;
        left: 10px;
        top: 80px;
        bottom: 20px;
        z-index: 1010;
        border-radius: 16px;
        max-height: calc(100vh - 100px);
      }
    }

    @media (max-width: 480px) {
      .sidebar-container {
        width: 70px;
        padding: 12px 6px;
      }
    }

    /* Category Tabs */
    .vertical-tabs {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      gap: 8px;
      border: 2px solid transparent;
      background: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      position: relative;
      text-align: center;
    }

    .tab-item:hover {
      background: linear-gradient(135deg, #f8f9fa, #f0f4f8);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(56, 142, 60, 0.1);
      border-color: rgba(56, 142, 60, 0.1);
    }

    .tab-item.active {
      background: linear-gradient(135deg, var(--primary-color), #2e7d32);
      color: white;
      box-shadow: 0 8px 20px rgba(56, 142, 60, 0.3);
      transform: scale(1.02);
      border-color: var(--primary-color);
    }

    .tab-icon-img {
      width: 36px;
      height: 36px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .tab-item:hover .tab-icon-img {
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .tab-item.active .tab-icon-img {
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .tab-text {
      font-size: 11px;
      font-weight: 600;
      color: var(--dark-gray);
      line-height: 1.3;
      width: 100%;
      word-break: break-word;
    }

    .tab-item.active .tab-text {
      color: white;
    }

    .tab-count {
      font-size: 10px;
      color: var(--medium-gray);
      font-weight: 500;
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 2px 6px;
    }

    .tab-item.active .tab-count {
      background: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }

    /* Products Container */
    .products-container {
      flex: 1;
      min-width: 0;
    }

    @media (max-width: 767.98px) {
      .products-container {
        margin-left: 95px;
        width: calc(100% - 95px);
      }
    }

    @media (max-width: 480px) {
      .products-container {
        margin-left: 80px;
        width: calc(100% - 80px);
      }
    }

    .products-header {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .products-title {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--dark-gray);
      flex: 1;
    }

    .sort-select {
      min-width: 160px;
      padding: 8px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      background: #f8f9fa;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .sort-select:focus {
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 3px rgba(56, 142, 60, 0.1);
      outline: none;
    }

    .products-content {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Loading Skeletons */
    .skeleton-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      animation: skeleton-pulse 1.5s infinite ease-in-out;
    }

    .skeleton-image {
      width: 100%;
      padding-top: 100%;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .skeleton-text {
      height: 14px;
      background: #f0f0f0;
      border-radius: 7px;
      margin: 10px 15px;
      animation: skeleton-pulse 1.5s infinite ease-in-out;
    }

    .skeleton-text.short {
      width: 60%;
    }

    /* Search Results */
    .search-results-container {
      padding: 90px 20px 100px;
      min-height: 100vh;
    }

    .search-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 25px;
      color: var(--dark-gray);
      padding: 0 10px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--medium-gray);
    }

    .empty-state-icon {
      font-size: 60px;
      color: #e1e5e9;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 16px;
      line-height: 1.6;
      max-width: 300px;
      margin: 0 auto;
    }

    /* Enlarged Image Overlay - IMPROVED */
    .enlarged-image-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1080;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .enlarged-image-content {
      max-width: 95vw;
      max-height: 95vh;
      object-fit: contain;
      animation: zoomIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .close-enlarged {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .close-enlarged:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    /* Order Item Styles */
    .order-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      background: #f8f9fa;
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .order-item:hover {
      background: #f0f4f8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .order-item-img {
      width: 70px;
      height: 70px;
      object-fit: contain;
      border-radius: 10px;
      margin-right: 15px;
      flex-shrink: 0;
      background: white;
      padding: 5px;
      border: 1px solid #e1e5e9;
    }

    .order-item-details {
      flex: 1;
      min-width: 0;
    }

    .order-item-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 5px;
      line-height: 1.4;
      color: var(--dark-gray);
    }

    .order-item-price {
      color: var(--primary-color);
      font-weight: 700;
      font-size: 14px;
    }

    .order-item-qty {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .qty-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 2px solid #e1e5e9;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      color: var(--dark-gray);
    }

    .qty-btn:hover {
      border-color: var(--primary-color);
      background: #f8f9fa;
      transform: scale(1.1);
    }

    .qty-display {
      min-width: 40px;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--dark-gray);
    }

    .delete-btn {
      color: var(--danger-color);
      border-color: rgba(220, 53, 69, 0.2);
    }

    .delete-btn:hover {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }

    /* Notification Badge */
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, var(--danger-color), #c82333);
      color: white;
      font-size: 11px;
      font-weight: 700;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    /* Saved Feedback */
    .saved-feedback {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(56, 142, 60, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 1.7s forwards;
      z-index: 1;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
      }
    }

    /* Modal Improvements */
    .modal-content {
      border-radius: 20px;
      border: none;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .modal-header {
      background: linear-gradient(135deg, #f8f9fa, #ffffff);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 20px;
    }

    .modal-title {
      font-weight: 700;
      color: var(--dark-gray);
    }

    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-footer {
      background: #f8f9fa;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      padding: 20px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
      transition: background 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Responsive Utilities */
    .mobile-only {
      display: none;
    }

    .desktop-only {
      display: block;
    }

    @media (max-width: 767.98px) {
      .mobile-only {
        display: block;
      }
      .desktop-only {
        display: none;
      }
    }

    /* Loading Animation */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Out of Stock Badge */
    .out-of-stock-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      z-index: 1;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    /* Price Hidden State */
    .price-hidden {
      color: var(--medium-gray);
      font-style: italic;
      font-size: 13px;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body ng-controller="imagesController as vm">
  <!-- Login Container -->
  <div id="login-container">
    <div id="inside">
      <h2>HINDUSTAN TOYS</h2>
      <input type="text" id="name" placeholder="Enter your shop name" class="form-control mb-3" autocomplete="off">
      <input type="tel" id="mobile" placeholder="Enter your mobile number" class="form-control mb-4" autocomplete="off">
      <button class="btn btn-success w-100" onclick="validateLogin()">
        <i class="fas fa-sign-in-alt me-2"></i>Login
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="content" style="display: none;">
    <!-- Navbar -->
    <div class="navbar">
      <div class="d-flex w-100 align-items-center justify-content-between">
        <!-- Search Box -->
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" 
                 ng-model="searchQuery" 
                 ng-change="onSearchChange()" 
                 ng-model-options="{ debounce: 400 }"
                 placeholder="Search products...">
        </div>
        
        <!-- Menu Button -->
        <div class="dropdown">
          <button class="menu-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-bars"></i>
            <span class="notification-badge" ng-if="orderCount > 0">{{orderCount}}</span>
          </button>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="#" ng-click="openOrderModal()">
                <i class="fas fa-shopping-cart"></i>
                Your Order
                <span class="badge bg-primary float-end" ng-if="orderCount > 0">{{orderCount}}</span>
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-danger" href="#" ng-click="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
      
      <!-- Welcome and Price Toggle -->
      <div class="d-flex w-100 justify-content-between align-items-center mt-3">
        <small class="text-muted">
          <i class="fas fa-store me-2"></i>
          Welcome, <strong>{{dynamicField2Value}}</strong>
        </small>
        <div class="price-toggle-container">
          <i class="fas fa-tag"></i>
          <span>Show Prices</span>
          <div class="form-check form-switch mb-0 ms-2">
            <input class="form-check-input" type="checkbox" role="switch" id="priceToggle" 
                   ng-model="priceVisible" ng-change="togglePriceVisibility()">
          </div>
        </div>
      </div>
    </div>

    <!-- Fixed Your Order Button -->
    <button class="fixed-order-button" 
            ng-if="dynamicField2Value && !isOrderModalOpen && !isEnlargedImageOpen" 
            ng-click="openOrderModal()">
      <i class="fas fa-shopping-cart"></i>
      Your Order
      <span class="badge" ng-if="orderCount > 0">{{orderCount}}</span>
    </button>

    <!-- Search Results -->
    <div class="search-results-container" ng-if="isSearching">
      <h2 class="search-title">Search Results for "{{ searchQuery }}"</h2>
      
      <!-- Loading State -->
      <div ng-if="isLoadingSearchResults">
        <div class="product-grid">
          <div class="skeleton-card" ng-repeat="i in [1,2,3,4,5,6]">
            <div class="skeleton-image"></div>
            <div class="skeleton-text short"></div>
            <div class="skeleton-text"></div>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div ng-if="!isLoadingSearchResults">
        <div class="product-grid">
          <div class="card" ng-repeat="product in searchResults">
            <div class="card-image-container">
              <img ng-src="{{product.url}}" alt="{{product.name}}" 
                   ng-click="showEnlargedImage(product.url)" loading="lazy">
              <div class="zoom-indicator">
                <i class="fas fa-search-plus"></i>
              </div>
              <span class="saved-feedback" ng-if="product.justSaved">
                <i class="fas fa-check"></i> Saved!
              </span>
            </div>
            <div class="card-content">
              <div class="card-title">{{product.name}}</div>
              <div class="card-price" ng-if="priceVisible">
                {{product.price | currency:"₹":0 }}
              </div>
              <div class="price-hidden" ng-if="!priceVisible">
                Price hidden
              </div>
              <div class="card-actions">
                <input type="number" class="qtyclass" placeholder="Quantity" 
                       ng-model="product.field3" ng-change="submitData(product)" 
                       ng-model-options="{ debounce: 800 }" min="0">
                <button class="watch-video-btn" ng-if="product.videourl" 
                        ng-click="showVideoModal($event, product.videourl, false)">
                  <i class="fas fa-play-circle"></i> Watch Video
                </button>
              </div>
            </div>
          </div>
        </div>
        <div ng-if="searchResults.length === 0" class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-search"></i>
          </div>
          <p class="empty-state-text">No products found matching your search.</p>
        </div>
      </div>
    </div>
    
    <!-- Main Content Layout -->
    <div ng-if="!isSearching" class="main-content-layout">
      <!-- Sidebar Categories -->
      <div class="sidebar-container">
        <div class="vertical-tabs">
          <!-- Loading State -->
          <div class="tab-loading" ng-if="isLoadingCategories">
            <div class="skeleton-tab" ng-repeat="i in [1,2,3,4,5,6]">
              <div class="skeleton-text" style="width: 40px; height: 40px; border-radius: 10px;"></div>
              <div class="skeleton-text short" style="width: 60%; margin: 5px auto;"></div>
            </div>
          </div>
          
          <!-- Categories -->
          <div class="tab-item" 
               ng-if="!isLoadingCategories"
               ng-class="{'active': activeTabId === category.id}"
               ng-click="selectCategory(category.filter, category.id)"
               ng-repeat="category in categories">
            <img ng-src="{{category.imageUrl}}" alt="{{category.name}}" class="tab-icon-img">
            <span class="tab-text">{{category.name}}</span>
            <small class="tab-count" ng-if="category.productCount > 0">
              {{category.productCount}}
            </small>
          </div>
        </div>
      </div>
      
      <!-- Products Container -->
      <div class="products-container">
        <div class="products-header">
          <h3 class="products-title">{{activeCategoryName}}</h3>
          <select ng-model="sortOrder" ng-change="updateDisplayedProducts()" class="sort-select">
            <option value="default">Sort: Newest</option>
            <option value="price">Sort: Price Low</option>
            <option value="-price">Sort: Price High</option>
          </select>
        </div>
        
        <div class="products-content">
          <!-- Loading State -->
          <div ng-if="isLoading">
            <div class="product-grid">
              <div class="skeleton-card" ng-repeat="i in [1,2,3,4,5,6]">
                <div class="skeleton-image"></div>
                <div class="skeleton-text short"></div>
                <div class="skeleton-text"></div>
              </div>
            </div>
          </div>
          
          <!-- Products Grid -->
          <div ng-if="!isLoading">
            <div class="product-grid">
              <div class="card" ng-repeat="product in displayedProducts" ng-hide="product.markedForRemoval">
                <div class="card-image-container">
                  <img ng-src="{{product.url}}" alt="{{product.name}}" 
                       ng-click="showEnlargedImage(product.url, false)" loading="lazy">
                  <div class="zoom-indicator">
                    <i class="fas fa-search-plus"></i>
                  </div>
                  <span class="saved-feedback" ng-if="product.justSaved">
                    <i class="fas fa-check"></i> Saved!
                  </span>
                  <div class="out-of-stock-badge" ng-if="product.outOfStock">
                    Out of Stock
                  </div>
                </div>
                <div class="card-content">
                  <div class="card-title">{{product.name}}</div>
                  <div class="card-price" ng-if="priceVisible">
                    {{product.price | currency:"₹":0 }}
                  </div>
                  <div class="price-hidden" ng-if="!priceVisible">
                    Price hidden
                  </div>
                  <div class="card-actions">
                    <input type="number" class="qtyclass" placeholder="Quantity" 
                           ng-model="product.field3" ng-change="submitData(product)" 
                           ng-model-options="{ debounce: 800 }" min="0">
                    <button class="watch-video-btn" ng-if="product.videourl" 
                            ng-click="showVideoModal($event, product.videourl, false)">
                      <i class="fas fa-play-circle"></i> Watch Video
                    </button>
                    <button ng-if="dynamicField2Value === 'sammyadmin'" 
                            class="btn btn-outline-danger btn-sm mt-2 w-100"
                            ng-click="markOutOfStock(product)">
                      <i class="fas fa-ban me-2"></i> Mark Out of Stock
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div ng-if="displayedProducts.length === 0" class="empty-state">
              <div class="empty-state-icon">
                <i class="fas fa-box-open"></i>
              </div>
              <p class="empty-state-text">No products found in this category.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ activeCategoryName }}</h5>
          <select ng-model="sortOrder" ng-change="updateDisplayedProducts()" class="sort-select">
            <option value="default">Sort: Newest</option>
            <option value="price">Sort: Price Low</option>
            <option value="-price">Sort: Price High</option>
          </select>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="product-grid">
            <div class="card" ng-repeat="image in displayedProducts" ng-hide="image.markedForRemoval">
              <div class="card-image-container">
                <img ng-src="{{image.url}}" alt="{{image.name}}" 
                     ng-click="showEnlargedImage(image.url, true)" loading="lazy">
                <div class="zoom-indicator">
                  <i class="fas fa-search-plus"></i>
                </div>
              </div>
              <div class="card-content">
                <div class="card-title">{{image.name}}</div>
                <div class="card-price" ng-if="priceVisible">
                  {{image.price | currency:"₹":0 }}
                </div>
                <div class="price-hidden" ng-if="!priceVisible">
                  Price hidden
                </div>
                <div class="card-actions">
                  <input type="number" class="qtyclass" placeholder="Quantity" 
                         ng-model="image.field3" ng-change="submitData(image)" 
                         ng-model-options="{ debounce: 800 }" min="0">
                  <button class="watch-video-btn" ng-if="image.videourl" 
                          ng-click="showVideoModal($event, image.videourl, true)">
                    <i class="fas fa-play-circle"></i> Watch Video
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Product Video</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" ng-click="closeVideoModal()"></button>
        </div>
        <div class="modal-body text-center p-0">
          <video controls autoplay id="videoPlayer" class="w-100" style="max-height: 70vh; border-radius: 0;">
            <source ng-src="{{currentVideoUrl}}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <div class="p-3" ng-if="videoError">
            <div class="alert alert-danger mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              {{videoError}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enlarged Image Overlay -->
  <div id="enlarged-image-overlay" class="enlarged-image-overlay" ng-click="closeEnlargedImage()">
    <img class="enlarged-image-content" id="enlarged-image" src="">
    <button class="close-enlarged" ng-click="closeEnlargedImage()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Order Modal -->
  <div class="modal fade" id="myModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-shopping-cart me-2"></i>
            {{dynamicField2Value}}'s Order
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="order-item" 
               ng-repeat="item in allOrders | filter:{field2: dynamicField2Value}:true | orderBy:'-serverTimestamp'">
            <img ng-src="{{item.field1}}" class="order-item-img">
            <div class="order-item-details">
              <div class="order-item-name">{{item.productName}}</div>
              <div class="order-item-price" ng-if="priceVisible">
                {{item.productPrice | currency:"₹":0 }}
              </div>
              <small class="text-muted" ng-if="item.submitDate && item.submitTime">
                {{item.submitDate}} at {{item.submitTime}}
              </small>
            </div>
            <div class="order-item-qty">
              <button class="qty-btn" ng-click="decrementOrderItem(item)">
                <i class="fas fa-minus"></i>
              </button>
              <span class="qty-display">{{item.field3}}</span>
              <button class="qty-btn" ng-click="incrementOrderItem(item)">
                <i class="fas fa-plus"></i>
              </button>
              <button class="qty-btn delete-btn" ng-click="deleteOrderItem(item)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div ng-if="(allOrders | filter:{field2: dynamicField2Value}:true).length === 0" class="empty-state">
            <div class="empty-state-icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <p class="empty-state-text">Your order list is empty.</p>
          </div>
        </div>
        <div class="modal-footer">
          <div class="w-100 d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0 text-primary" ng-if="priceVisible">
                Total: {{ calculateOrderTotal() | currency:"₹":0 }}
              </h5>
              <small class="text-muted" ng-if="orderCount > 0">
                {{orderCount}} item<span ng-if="orderCount > 1">s</span>
              </small>
            </div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.firebase.com/libs/angularfire/2.3.0/angularfire.min.js"></script>

  <script>
    // Global flag for enlarged image
    var isEnlargedImageOpen = false;

    // Enhanced error handling
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Script Error:', { message, source, line: lineno, column: colno, error });
      return true;
    };

    // Back Button Control with improved handling
    history.pushState({ state: 'home' }, null, location.href);
    window.addEventListener('popstate', function (event) {
      try {
        var productModalEl = document.getElementById('productModal');
        var orderModalEl = document.getElementById('myModal');
        var videoModalEl = document.getElementById('videoModal');
        var enlargedOverlayEl = document.getElementById('enlarged-image-overlay');
        
        var productModal = bootstrap.Modal.getInstance(productModalEl);
        var orderModal = bootstrap.Modal.getInstance(orderModalEl);
        var videoModal = bootstrap.Modal.getInstance(videoModalEl);
        var scope = angular.element(document.body).scope();

        if (!scope) return;

        scope.$applyAsync(function() {
          // Close enlarged image if open
          if (isEnlargedImageOpen && enlargedOverlayEl && enlargedOverlayEl.style.display === 'flex') {
            scope.closeEnlargedImage();
            isEnlargedImageOpen = false;
            return;
          }

          // Close product modal if open
          if (productModal && productModalEl.classList.contains('show')) {
            productModal.hide();
            history.pushState({ state: 'home' }, null, location.href);
            return;
          }

          // Close video modal if open
          if (videoModal && videoModalEl.classList.contains('show')) {
            scope.closeVideoModal();
            return;
          }

          // Close order modal if open
          if (orderModal && orderModalEl.classList.contains('show')) {
            orderModal.hide();
            return;
          }

          // Exit search if searching
          if (scope.isSearching || (scope.searchQuery && scope.searchQuery.length > 0)) {
            scope.searchQuery = '';
            scope.isSearching = false;
            scope.onSearchChange();
            history.pushState({ state: 'home' }, null, location.href);
            return;
          }

          // Default: push home state
          history.pushState({ state: 'home' }, null, location.href);
        });
      } catch (e) {
        console.error('Popstate error:', e);
      }
    });

    // Update enlarged image flag
    document.getElementById('enlarged-image-overlay').addEventListener('transitionend', function() {
      isEnlargedImageOpen = this.style.display === 'flex';
    });

    // Enhanced Login Logic
    (function() {
      var loginConfig = {
        apiKey: "AIzaSyAr8dYBz_D1DVnGfT_fQhTwD1YmtTvuzMk",
        authDomain: "shop-reminder-3ce10.firebaseapp.com",
        databaseURL: "https://shop-reminder-3ce10-default-rtdb.firebaseio.com",
      };
      
      var blockedNumbers = ['7000913701', '9846434664', '8269731362', '9876543210', '9123456789', 
                           '8987854256', '9039199794', '9166220046', '8269731352', '6263821242', 
                           '6616495946', '6266242180', '9109390639', '9658695825', '8576911011'];
      var blockedPageUrl = 'https://www.hindustantoys.in/mywebsite/NEWWEBSITE/blocked.html';

      try {
        var loginApp = firebase.apps.find(app => app.name === 'loginApp') || 
                      firebase.initializeApp(loginConfig, 'loginApp');
        var loginDb = loginApp.database();

        window.validateLogin = function() {
          try {
            var nameInput = document.getElementById('name');
            var mobileInput = document.getElementById('mobile');
            var name = nameInput.value.trim();
            var mobile = mobileInput.value.trim();

            // Check if blocked
            if (blockedNumbers.includes(mobile)) {
              window.location.href = blockedPageUrl;
              return;
            }

            // Validation
            if (name.length < 4) {
              alert('Please enter a valid shop name (at least 4 characters).');
              nameInput.focus();
              return;
            }

            if (!/^[6-9]\d{9}$/.test(mobile)) {
              alert('Please enter a valid 10-digit mobile number starting with 6-9.');
              mobileInput.focus();
              return;
            }

            // Show loading
            var btn = document.querySelector('#inside button');
            var originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Logging in...';
            btn.disabled = true;

            // Save to Firebase
            loginDb.ref('users').push({ 
              name: name, 
              mobile: mobile, 
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              userAgent: navigator.userAgent,
              screenResolution: window.screen.width + 'x' + window.screen.height
            }).then(() => {
              // Save to localStorage
              localStorage.setItem('name', name);
              localStorage.setItem('mobile', mobile);
              localStorage.setItem('lastLogin', new Date().toISOString());
              
              // Show content
              showContent(name);
            }).catch(e => {
              console.error("Login Firebase Error:", e);
              alert('Login failed. Please check your internet connection and try again.');
            }).finally(() => {
              // Reset button
              btn.innerHTML = originalText;
              btn.disabled = false;
            });
          } catch (e) {
            console.error("Validate Login Error:", e);
            alert('An error occurred during login. Please try again.');
          }
        };

        function showContent(name) {
          try {
            var scope = angular.element(document.body).scope();
            if (scope) {
              scope.$applyAsync(function() { 
                scope.dynamicField2Value = name; 
              });
            }
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            history.pushState({ state: 'home' }, null, location.href);
            
            // Add welcome animation
            setTimeout(() => {
              var welcomeMsg = document.querySelector('.navbar .text-muted strong');
              if (welcomeMsg) {
                welcomeMsg.style.animation = 'pulse 2s';
              }
            }, 500);
          } catch (e) {
            console.error("Show Content Error:", e);
          }
        }

        function checkAuthentication() {
          try {
            var name = localStorage.getItem('name');
            var mobile = localStorage.getItem('mobile');
            var lastLogin = localStorage.getItem('lastLogin');

            // Check if blocked
            if (mobile && blockedNumbers.includes(mobile)) {
              window.location.href = blockedPageUrl;
              return;
            }

            // Auto-login if within 7 days
            if (name && mobile && lastLogin) {
              var lastLoginDate = new Date(lastLogin);
              var currentDate = new Date();
              var daysSinceLogin = (currentDate - lastLoginDate) / (1000 * 60 * 60 * 24);
              
              if (daysSinceLogin <= 7) {
                document.getElementById('name').value = name;
                document.getElementById('mobile').value = mobile;

                // Log auto-login
                loginDb.ref('users').push({ 
                  name: name, 
                  mobile: mobile, 
                  timestamp: firebase.database.ServerValue.TIMESTAMP,
                  loginType: 'auto',
                  daysSinceLastLogin: Math.floor(daysSinceLogin)
                }).catch(e => {
                  console.error("Auto-login Firebase Error:", e);
                });

                showContent(name);
              } else {
                // Clear old login data
                localStorage.clear();
              }
            }
          } catch (e) {
            console.error("Check Authentication Error:", e);
          }
        }

        checkAuthentication();
      } catch (e) {
        console.error("Firebase Initialization Error:", e);
        alert('Failed to initialize application. Please check your network and try again.');
      }
    })();
    
    // Angular App
    var app = angular.module('myApp', ['firebase']);
    app.controller('imagesController', ['$scope', '$firebaseArray', '$filter', '$window', '$timeout', '$sce', 
    function($scope, $firebaseArray, $filter, $window, $timeout, $sce) {
      try {
        var vm = this;
        vm.images = [];
        $scope.displayedProducts = []; 
        $scope.sortOrder = 'default';
        $scope.dynamicField2Value = localStorage.getItem('name') || '';
        $scope.priceVisible = localStorage.getItem('priceVisible') !== 'false';
        $scope.isOrderModalOpen = false;
        $scope.isEnlargedImageOpen = false;
        $scope.orderCount = 0;
        
        $scope.isLoading = true;
        $scope.isLoadingCategories = true;
        
        $scope.isSearching = false;
        $scope.searchResults = [];
        $scope.isLoadingSearchResults = false;
        $scope.currentVideoUrl = '';
        $scope.videoError = '';
        $scope.isProductModalOpen = false;

        var fetchConfig = { databaseURL: "https://htshop-e9c51-default-rtdb.firebaseio.com" };
        var submitConfig = { databaseURL: "https://notes-12519-default-rtdb.firebaseio.com" };
        
        var fetchApp = firebase.apps.find(app => app.name === 'fetchApp') || 
                      firebase.initializeApp(fetchConfig, 'fetchApp');
        var fetchDb = fetchApp.database().ref();

        var submitApp = firebase.apps.find(app => app.name === 'submitApp') || 
                      firebase.initializeApp(submitConfig, 'submitApp');
        var submitDb = submitApp.database().ref();

        // Real-time listener for products
        var productsListener = fetchDb.on('value', function(snapshot) {
          const allData = [];
          snapshot.forEach(function(childSnapshot) {
            var item = childSnapshot.val();
            item.$id = childSnapshot.key;
            // Ensure all required fields exist
            item.name = item.name || 'Unknown Product';
            item.price = item.price || 0;
            item.url = item.url || '';
            item.videourl = item.videourl || '';
            item.field3 = 0; // Initialize quantity
            allData.push(item);
          });

          // Filter out out of stock items
          vm.images = allData.filter(item => !item.outOfStock);

          $scope.$applyAsync(function() {
            // Update category counts
            angular.forEach($scope.categories, function(category) {
              if (category.filter === '') {
                category.productCount = vm.images.length;
              } else {
                category.productCount = $filter('filter')(vm.images, { name: category.filter }).length;
              }
            });
            
            $scope.isLoading = false;
            $scope.isLoadingCategories = false;
            
            // Select first category by default
            if (!$scope.activeTabId && $scope.activeTabId !== 0) {
              $scope.activeTabId = 0;
              $scope.selectCategory($scope.categories[0].filter || '', $scope.activeTabId);
            } else {
              $scope.updateDisplayedProducts();
            }
          });
        }, function(error) {
          console.error("Error loading products:", error);
          $scope.$applyAsync(function() {
            $scope.isLoading = false;
            $scope.isLoadingCategories = false;
          });
          alert('Failed to load products. Please check your network and try again.');
        });
        
        // Orders from Firebase
        $scope.allOrders = $firebaseArray(submitDb);
        $scope.activeTabId = 0;
        $scope.activeCategoryName = 'ALL PRODUCTS';
        
        // Categories with images
        $scope.categories = [
          { id: 0, name: 'ALL PRODUCTS', filter: '', imageUrl: 'https://www.hindustantoys.in/images/all.jpeg' },
          { id: 6, name: 'RACKET', filter: 'RACKET', imageUrl: 'https://www.hindustantoys.in/images/racket.jpeg' },
          { id: 9, name: 'MIX TOYS', filter: 'MIX', imageUrl: 'https://www.hindustantoys.in/images/mix.jpeg' },
          { id: 39, name: 'EDUCATIONAL TOYS', filter: 'EDUCATIONAL', imageUrl: 'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2025-08-23T08%3A21%3A08.778Z_KIDS%20EDUCATIONAL%20CALENDER%20(MIX)_cfb4fb41-e790-4b0a-8cbd-d0f33f1d392b.jpg?alt=media&token=97e8c36a-6efe-4812-a40a-f99ab08b7b09' },
          { id: 41, name: 'BATTERY CAR/JEEP', filter: 'BATTERY CAR', imageUrl: 'https://www.hindustantoys.in/images/Jeep.jpg' },
          { id: 40, name: 'BATTERY BIKES', filter: 'BATTERY BIKE', imageUrl: 'https://www.hindustantoys.in/images/bike.jpg' },
          { id: 38, name: 'UMBRELLA', filter: 'UMBRELLA', imageUrl: 'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2024-06-24T16%3A35%3A31.407Z_RAINBOW%20UMBRELLA_IMG-20240529-WA0047.jpg?alt=media&token=64ee5147-65c7-4de8-897d-55df6cb84857' },
          { id: 10, name: 'LUMO & OTHER', filter: 'LUMO', imageUrl: 'https://www.hindustantoys.in/images/lumo.jpeg' },
          { id: 36, name: 'BAT BALL & SET', filter: 'BAT BALL', imageUrl: 'https://www.hindustantoys.in/images/bat.jpeg' },
          { id: 35, name: 'CARROM BOARD', filter: 'CARROM', imageUrl: 'https://www.hindustantoys.in/images/carrom.jpeg' },
          { id: 37, name: 'SWINGS', filter: 'SWING', imageUrl: 'https://www.hindustantoys.in/images/swing.jpeg' },
          { id: 3, name: 'INDIAN TOYS', filter: 'INDIAN TOYS', imageUrl: 'https://www.hindustantoys.in/images/JCB.jpeg' },
          { id: 13, name: 'BATTERY OPERATED', filter: 'BATTERY', imageUrl: 'https://www.hindustantoys.in/images/battery.jpeg' },
          { id: 34, name: 'VALENTINES/TEDDY', filter: 'TEDDY', imageUrl: 'https://www.hindustantoys.in/images/TEDDY.jpg' },
          { id: 31, name: 'KITCHEN SETS', filter: 'KITCHEN', imageUrl: 'https://www.hindustantoys.in/images/KITCHEN.jpg' },
          { id: 7, name: 'REMOTE CAR', filter: 'REMOTE', imageUrl: 'https://www.hindustantoys.in/images/remote.jpeg' },
          { id: 11, name: 'MAGIC RIDDER', filter: 'RIDDER', imageUrl: 'https://www.hindustantoys.in/images/ridder.jpeg' },
          { id: 25, name: 'HIGH QUALITY', filter: 'HIGH QUALITY', imageUrl: 'https://www.hindustantoys.in/images/high.jpeg' },
          { id: 30, name: 'HT PRODUCTS', filter: 'OWN', imageUrl: 'https://www.hindustantoys.in/images/htquality.jpg' },
          { id: 29, name: 'PALNA', filter: 'PALNA', imageUrl: 'https://www.hindustantoys.in/images/palna.png' },
          { id: 5, name: 'WALKER', filter: 'WALKER', imageUrl: 'https://www.hindustantoys.in/images/walker.jpeg' },
          { id: 28, name: 'LUNCH BOX', filter: 'LUNCH BOX', imageUrl: 'https://firebasestorage.googleapis.com/v0/b/htshop-e9c51.appspot.com/o/2025-07-01T08%3A45%3A26.021Z_LUNCH%20BOX_667798d8-2789-471f-985a-8605b19313b1.jpg?alt=media&token=bb3a00ab-a86c-43c5-9e10-d18f4a427451' },
          { id: 27, name: 'PENCIL BOX', filter: 'PENCIL BOX', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=PX' },
          { id: 23, name: 'WATER BOTTLE', filter: 'BOTTLE', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=WB' },
          { id: 26, name: 'BOARD GAME', filter: 'BOARD GAME', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=BG' },
          { id: 22, name: 'EDUCATIONAL', filter: 'EDUCATIONAL', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=ED' },
          { id: 21, name: 'BIG ITEMS', filter: 'BIG', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=BI' },
          { id: 19, name: 'TRICYCLES', filter: 'TRICYCLE', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=TC' },
          { id: 18, name: 'SPORTS ITEM', filter: 'SPORTS', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=SP' },
          { id: 17, name: 'PATTA ITEMS', filter: 'PATTA', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=PT' },
          { id: 15, name: 'GUNS VARIETY', filter: 'GUN', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=GV' },
          { id: 1, name: 'STATIONERY', filter: 'STATIONERY', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=ST' },
          { id: 8, name: 'DOLL', filter: 'DOLL', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=DL' },
          { id: 12, name: 'FANCY ITEMS', filter: 'FANCY', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=FI' },
          { id: 14, name: 'DOZEN PACKING', filter: 'DOZEN', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=DP' },
          { id: 32, name: 'GODOWN-1', filter: 'G1', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=G1' },
          { id: 33, name: 'GODOWN-2', filter: 'G2', imageUrl: 'https://via.placeholder.com/36x36/e1e5e9/6c757d?text=G2' }
        ];
        
        // Initialize modals
        var productModal = null;
        var videoModal = null;
        var orderModal = null;
        
        $timeout(function() {
          try {
            productModal = new bootstrap.Modal(document.getElementById('productModal'));
            videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
            orderModal = new bootstrap.Modal(document.getElementById('myModal'));
          } catch (e) {
            console.error("Modal Initialization Error:", e);
          }
        }, 100);

        // Calculate order count
        $scope.calculateOrderCount = function() {
          try {
            if (!$scope.allOrders || !$scope.dynamicField2Value) return 0;
            var userOrders = $scope.allOrders.filter(item => item.field2 === $scope.dynamicField2Value);
            return userOrders.reduce((sum, item) => sum + (parseInt(item.field3) || 0), 0);
          } catch (e) {
            console.error("Calculate Order Count Error:", e);
            return 0;
          }
        };

        // Watch for order changes
        $scope.$watchCollection('allOrders', function(newVal, oldVal) {
          $scope.orderCount = $scope.calculateOrderCount();
        });

        // Open order modal
        $scope.openOrderModal = function() {
          try {
            $scope.isOrderModalOpen = true;
            history.pushState({ state: 'orderModal' }, null, location.href);
            if (orderModal) orderModal.show();
          } catch (e) {
            console.error("Open Order Modal Error:", e);
          }
        };

        // Search functionality
        $scope.onSearchChange = function() {
          try {
            if ($scope.searchQuery && $scope.searchQuery.length > 0) {
              $scope.isSearching = true;
              $scope.isLoadingSearchResults = true;
              history.pushState({ state: 'search' }, null, location.href);

              $timeout(function() {
                // Perform search
                var searchTerm = $scope.searchQuery.toLowerCase();
                $scope.searchResults = vm.images.filter(function(product) {
                  return product.name.toLowerCase().includes(searchTerm) ||
                         (product.price && product.price.toString().includes(searchTerm));
                }) || [];
                
                $scope.isLoadingSearchResults = false;
                $scope.$applyAsync();
              }, 300);
            } else {
              $scope.isSearching = false;
              $scope.searchResults = [];
              history.pushState({ state: 'home' }, null, location.href);
            }
          } catch (e) {
            console.error("Search Change Error:", e);
            $scope.isSearching = false;
            $scope.isLoadingSearchResults = false;
          }
        };
        
        // Select category
        $scope.selectCategory = function(filter, tabId) {
          try {
            $scope.searchQuery = '';
            $scope.isSearching = false;
            $scope.productNameFilter = filter;
            $scope.activeCategoryName = $scope.categories.find(c => c.id === tabId)?.name || 'Products';
            $scope.activeTabId = tabId;
            $scope.updateDisplayedProducts();
            
            // Scroll to top on mobile
            if (window.innerWidth <= 768) {
              $timeout(function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
              }, 100);
            }
          } catch (e) {
            console.error("Select Category Error:", e);
          }
        };

        // Set tab for modal view
        $scope.setTab = function(filter, tabId) {
          try {
            $scope.searchQuery = '';
            $scope.isSearching = false;
            $scope.productNameFilter = filter;
            $scope.activeCategoryName = $scope.categories.find(c => c.id === tabId)?.name || 'Products';
            $scope.updateDisplayedProducts();
            $scope.isProductModalOpen = true;
            history.pushState({ state: 'productModal' }, null, location.href);
            if (productModal) productModal.show();
          } catch (e) {
            console.error("Set Tab Error:", e);
          }
        };
        
        // Toggle price visibility
        $scope.togglePriceVisibility = function() {
          try {
            localStorage.setItem('priceVisible', $scope.priceVisible);
          } catch (e) {
            console.error("Toggle Price Visibility Error:", e);
          }
        };

        // Increment order item
        $scope.incrementOrderItem = function(item) {
          try {
            if (item) {
              item.field3 = parseInt(item.field3 || 0) + 1;
              $scope.allOrders.$save(item).catch(e => {
                console.error("Increment Order Item Error:", e);
              });
            }
          } catch (e) {
            console.error("Increment Order Item Error:", e);
          }
        };

        // Decrement order item
        $scope.decrementOrderItem = function(item) {
          try {
            if (item) {
              var newQty = parseInt(item.field3 || 0) - 1;
              if (newQty < 1) {
                // Remove item if quantity reaches 0
                $scope.allOrders.$remove(item).catch(e => {
                  console.error("Remove Order Item Error:", e);
                });
              } else {
                item.field3 = newQty;
                $scope.allOrders.$save(item).catch(e => {
                  console.error("Decrement Order Item Error:", e);
                });
              }
            }
          } catch (e) {
            console.error("Decrement Order Item Error:", e);
          }
        };

        // Delete order item
        $scope.deleteOrderItem = function(item) {
          try {
            if (item && confirm('Are you sure you want to remove this item from your order?')) {
              $scope.allOrders.$remove(item).catch(e => {
                console.error("Delete Order Item Error:", e);
              });
            }
          } catch (e) {
            console.error("Delete Order Item Error:", e);
          }
        };
        
        // Calculate order total
        $scope.calculateOrderTotal = function() {
          try {
            var total = 0;
            if (!$scope.allOrders || !$scope.dynamicField2Value) return 0;
            
            var userOrders = $scope.allOrders.filter(item => item.field2 === $scope.dynamicField2Value);
            userOrders.forEach(function(item) {
              total += (parseFloat(item.productPrice) || 0) * (parseInt(item.field3) || 0);
            });
            return total;
          } catch (e) {
            console.error("Calculate Order Total Error:", e);
            return 0;
          }
        };

        // Mark out of stock
        $scope.markOutOfStock = function(image) {
          try {
            if (!image || !image.$id || image.markedForRemoval) return;

            if (!confirm('Are you sure you want to mark this item as out of stock?')) {
              return;
            }

            image.markedForRemoval = true;
            var itemRef = fetchDb.child(image.$id);
            itemRef.update({ 
              outOfStock: true,
              lastModified: firebase.database.ServerValue.TIMESTAMP,
              markedBy: $scope.dynamicField2Value,
              markedAt: new Date().toISOString()
            }).then(function() {
              $timeout(function() {
                // Remove from arrays
                const masterIndex = vm.images.findIndex(i => i.$id === image.$id);
                if (masterIndex > -1) vm.images.splice(masterIndex, 1);

                const displayIndex = $scope.displayedProducts.findIndex(p => p.$id === image.$id);
                if (displayIndex > -1) $scope.displayedProducts.splice(displayIndex, 1);
                
                const searchIndex = $scope.searchResults.findIndex(p => p.$id === image.$id);
                if (searchIndex > -1) $scope.searchResults.splice(searchIndex, 1);
                
                alert('Item marked as out of stock successfully.');
              }, 200);
            }).catch(function(error) {
              console.error("Error marking out of stock:", error);
              alert("An error occurred: " + error.message);
              image.markedForRemoval = false;
            });
          } catch (e) {
            console.error("Mark Out of Stock Error:", e);
          }
        };

        // Submit order data
        $scope.submitData = function(image) {
          try {
            if (!image) return;
            
            var baseId = image.$id || image.name.replace(/[^a-zA-Z0-9]/g, '');
            var uniqueId = $scope.dynamicField2Value.replace(/[^a-zA-Z0-9]/g, '') + '-' + baseId;
            
            var recordRef = submitDb.child(uniqueId);

            // Remove if quantity is 0 or less
            if (!image.field3 || image.field3 <= 0) {
              recordRef.remove().catch(e => {
                console.error("Remove Order Error:", e);
              });
              return;
            }

            const now = new Date();
            const date = now.toLocaleDateString('en-IN', {day: '2-digit', month: '2-digit', year: 'numeric'});
            const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true }).toUpperCase();

            var dataToSubmit = {
              field1: image.url,
              field2: $scope.dynamicField2Value,
              field3: image.field3,
              productName: image.name,
              productPrice: image.price,
              productId: image.$id,
              serverTimestamp: firebase.database.ServerValue.TIMESTAMP,
              submitDate: date,
              submitTime: time,
              lastUpdated: new Date().toISOString()
            };
            
            recordRef.set(dataToSubmit).then(() => {
              image.justSaved = true;
              $timeout(() => { 
                image.justSaved = false; 
              }, 2000);
            }).catch(error => {
              console.error("Error submitting data:", error);
              alert("Could not save order. Please try again.");
            });
          } catch (e) {
            console.error("Submit Data Error:", e);
          }
        };
        
        // Show enlarged image
        $scope.showEnlargedImage = function(src, fromProductModal) {
          try {
            const overlay = document.getElementById('enlarged-image-overlay');
            const img = document.getElementById('enlarged-image');
            if (overlay && img) {
              img.src = src || '';
              overlay.style.display = 'flex';
              isEnlargedImageOpen = true;
              $scope.isEnlargedImageOpen = true;
              history.pushState({ 
                state: 'enlargedImage', 
                fromProductModal: !!fromProductModal 
              }, null, location.href);
            }
          } catch (e) {
            console.error("Show Enlarged Image Error:", e);
          }
        };

        // Close enlarged image
        $scope.closeEnlargedImage = function() {
          try {
            const overlay = document.getElementById('enlarged-image-overlay');
            if (overlay) {
              overlay.style.display = 'none';
              isEnlargedImageOpen = false;
              $scope.isEnlargedImageOpen = false;
              
              var productModalEl = document.getElementById('productModal');
              var productModalInstance = bootstrap.Modal.getInstance(productModalEl);
              if (productModalInstance && productModalEl.classList.contains('show')) {
                history.pushState({ state: 'productModal' }, null, location.href);
              } else {
                history.pushState({ state: 'home' }, null, location.href);
              }
            }
          } catch (e) {
            console.error("Close Enlarged Image Error:", e);
          }
        };
        
        // Show video modal
        $scope.showVideoModal = function(event, videourl, fromProductModal) {
          try {
            if (event) {
              event.preventDefault();
              event.stopPropagation();
            }
            $scope.videoError = '';
            if (videourl) {
              $scope.currentVideoUrl = $sce.trustAsResourceUrl(videourl);
              history.pushState({ 
                state: 'videoModal', 
                fromProductModal: fromProductModal 
              }, null, location.href);
              if (videoModal) videoModal.show();
              
              $timeout(function() {
                var videoElement = document.getElementById('videoPlayer');
                if (videoElement) {
                  videoElement.load();
                  videoElement.onerror = function() {
                    $scope.$applyAsync(function() {
                      $scope.videoError = 'Unable to load video. Please check the URL or try again later.';
                      console.error('Video playback error:', videourl);
                    });
                  };
                  videoElement.onloadeddata = function() {
                    console.log('Video loaded successfully:', videourl);
                  };
                }
              }, 0);
            } else {
              $scope.videoError = 'Video URL not available.';
              console.error('No video URL provided');
            }
          } catch (e) {
            console.error("Show Video Modal Error:", e);
          }
        };

        // Close video modal
        $scope.closeVideoModal = function() {
          try {
            var videoElement = document.getElementById('videoPlayer');
            if (videoElement) {
              videoElement.pause();
              videoElement.currentTime = 0;
            }
            if (videoModal) videoModal.hide();
            $scope.currentVideoUrl = '';
            $scope.videoError = '';
            
            var productModalEl = document.getElementById('productModal');
            var productModalInstance = bootstrap.Modal.getInstance(productModalEl);
            if (productModalInstance && productModalEl.classList.contains('show')) {
              history.pushState({ state: 'productModal' }, null, location.href);
            } else {
              history.pushState({ state: 'home' }, null, location.href);
            }
          } catch (e) {
            console.error("Close Video Modal Error:", e);
          }
        };

        // Update displayed products
        $scope.updateDisplayedProducts = function() {
          try {
            if ($scope.isLoading || !$scope.dynamicField2Value) return;

            let filteredImages = vm.images;
            
            // Apply category filter
            if ($scope.productNameFilter) {
              filteredImages = $filter('filter')(vm.images, { name: $scope.productNameFilter }) || [];
            }
            
            // Apply search filter if not in search mode
            if ($scope.searchQuery && !$scope.productNameFilter && !$scope.isSearching) {
              filteredImages = $filter('filter')(filteredImages, { name: $scope.searchQuery }) || [];
            }

            // Apply sorting
            if ($scope.sortOrder === 'price') {
              filteredImages = $filter('orderBy')(filteredImages, 'price');
            } else if ($scope.sortOrder === '-price') {
              filteredImages = $filter('orderBy')(filteredImages, '-price');
            } else {
              // Default: newest first (assuming items have a date property)
              filteredImages = $filter('orderBy')(filteredImages, '-date');
            }
            
            $scope.displayedProducts = filteredImages;
          } catch (e) {
            console.error("Update Displayed Products Error:", e);
          }
        };

        // Logout
        $scope.logout = function() {
          try {
            if (confirm('Are you sure you want to logout?')) {
              // Unsubscribe from real-time listener
              fetchDb.off('value', productsListener);
              
              // Clear all data
              localStorage.clear();
              
              // Reload page
              $window.location.reload();
            }
          } catch (e) {
            console.error("Logout Error:", e);
          }
        };

        // Modal event listeners
        $timeout(function() {
          try {
            var productModalEl = document.getElementById('productModal');
            if (productModalEl) {
              productModalEl.addEventListener('show.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isProductModalOpen = true;
                });
              });
              productModalEl.addEventListener('hide.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isProductModalOpen = false;
                  history.pushState({ state: 'home' }, null, location.href);
                });
              });
            }

            var videoModalEl = document.getElementById('videoModal');
            if (videoModalEl) {
              videoModalEl.addEventListener('show.bs.modal', function() {
                var productModalEl = document.getElementById('productModal');
                if ($scope.isProductModalOpen && productModalEl.classList.contains('show')) {
                  document.body.classList.add('modal-open');
                  var backdrop = document.querySelector('.modal-backdrop');
                  if (backdrop) {
                    backdrop.style.display = 'block';
                  }
                }
              });
              videoModalEl.addEventListener('hide.bs.modal', function() {
                var productModalEl = document.getElementById('productModal');
                if ($scope.isProductModalOpen && productModalEl.classList.contains('show')) {
                  productModalEl.style.display = 'block';
                  document.body.classList.add('modal-open');
                  if (!document.querySelector('.modal-backdrop')) {
                    var backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                  }
                }
              });
            }

            var orderModalEl = document.getElementById('myModal');
            if (orderModalEl) {
              orderModalEl.addEventListener('show.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isOrderModalOpen = true;
                });
              });
              orderModalEl.addEventListener('hide.bs.modal', function() {
                $scope.$applyAsync(function() {
                  $scope.isOrderModalOpen = false;
                });
              });
            }
          } catch (e) {
            console.error("Modal Event Listener Error:", e);
          }
        }, 500);

      } catch (e) {
        console.error("Controller Initialization Error:", e);
        alert('Application initialization failed. Please refresh the page.');
      }
    }]);
  </script>
</body>
</html>
