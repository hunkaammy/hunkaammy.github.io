<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Product Gallery with Image + Video (Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <style>
    .drop-zone {
      border: 2px dashed #cbd5e1; /* slate-300 */
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .drop-zone:hover, .drop-zone.active {
      background-color: #f8fafc; /* slate-50 */
      border-color: #3b82f6; /* blue-500 */
    }
    #globalDropOverlay {
      display: none;
    }
    #globalDropOverlay.active {
      display: flex;
    }
    .truncate-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    img[data-src] {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    img.loaded {
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="globalDropOverlay" class="fixed inset-0 bg-black/50 z-50 items-center justify-center text-white text-xl">
    Drop files to upload
  </div>

  <div class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-4">Product Manager</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
      <div class="lg:col-span-1 bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Add New Product</h2>

        <div class="space-y-3">
          <div>
            <label for="nameInput" class="block text-sm font-medium text-gray-700">Name</label>
            <input id="nameInput" type="text" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Product name" />
          </div>

          <div>
            <label for="priceInput" class="block text-sm font-medium text-gray-700">Price</label>
            <input id="priceInput" type="number" step="0.01" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" />
          </div>

          <div>
            <label for="partyCodeInput" class="block text-sm font-medium text-gray-700">Party Code</label>
            <input id="partyCodeInput" type="text" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., ABC123" />
          </div>

          <div>
            <label for="videourlInput" class="block text-sm font-medium text-gray-700">
              Video URL (enter manually or upload below)
            </label>
            <input id="videourlInput" type="url" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="https://..." />
          </div>
        </div>

        <div class="drop-zone rounded-lg p-4 text-center cursor-pointer mt-4" id="imageDropZone">
          <div class="text-gray-500">Click to upload or Drag & Drop multiple images</div>
          <div class="preview mt-4 grid grid-cols-3 gap-2" id="preview"></div>
          <input type="file" id="imageInput" class="hidden" accept="image/*" multiple />
        </div>

        <div class="drop-zone rounded-lg p-4 text-center cursor-pointer mt-4" id="videoDropZone">
          <div class="text-gray-500">Optional: Click to upload or Drag & Drop a video</div>
          <div class="preview mt-4" id="videoPreview"></div>
          <input type="file" id="videoInput" class="hidden" accept="video/*" />
        </div>

        <button id="uploadBtn" class="w-full mt-5 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-lg">
          Upload Product(s)
        </button>
      </div>

      <div class="lg:col-span-2 bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Upload Queue & Progress</h2>
        <div id="progressList" class="space-y-3"></div>
      </div>
    </div>

    <div class="mt-8 bg-white rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold mb-3">Search Products</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="nameSearchInput" class="block text-sm font-medium text-gray-700">Search by Product Name</label>
          <input id="nameSearchInput" type="text" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter product name..." />
        </div>
        <div>
          <label for="partyCodeSearchInput" class="block text-sm font-medium text-gray-700">Search by Party Code</label>
          <input id="partyCodeSearchInput" type="text" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter party code..." />
        </div>
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-lg font-semibold mb-3">Products</h2>
      <div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5"></div>
    </div>
  </div>

  <script>
    // 1) Firebase init
    try {
      const firebaseConfig = {
        apiKey: "AIzaSyAvlig_xWJNP1hFsl4qfisC01VTkOAVhT8",
        authDomain: "htshop-e9c51.firebaseapp.com",
        databaseURL: "https://htshop-e9c51-default-rtdb.firebaseio.com",
        projectId: "htshop-e9c51",
        storageBucket: "htshop-e9c51.appspot.com",
        messagingSenderId: "653137640907",
        appId: "1:653137640907:web:672fd6a9e85ca448a70a4e",
        measurementId: "G-FJ4Q0FHBEG"
      };
      firebase.initializeApp(firebaseConfig);
      console.log('Firebase initialized successfully');
    } catch (err) {
      console.error('Firebase initialization failed:', err);
      alert('Failed to initialize Firebase. Please check your configuration and try again.');
    }

    const database = firebase.database();
    const storage = firebase.storage();

    // 2) Element references
    const imageDropZone = document.getElementById('imageDropZone');
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const videoDropZone = document.getElementById('videoDropZone');
    const videoInput = document.getElementById('videoInput');
    const videoPreview = document.getElementById('videoPreview');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressList = document.getElementById('progressList');
    const galleryGrid = document.getElementById('galleryGrid');
    const globalDropOverlay = document.getElementById('globalDropOverlay');
    const nameSearchInput = document.getElementById('nameSearchInput');
    const partyCodeSearchInput = document.getElementById('partyCodeSearchInput');

    // 3) State
    const uploadQueue = [];
    let isUploading = false;
    let products = [];
    let selectedImageFiles = []; // Accumulator for multiple selections

    // 4) Debounce utility
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // --- ADDED: Image Compression Helper ---
    async function compressImage(file, quality = 0.7) {
        if (!file.type.startsWith('image/')) return file;
        return new Promise((resolve) => {
            const img = new Image();
            const src = URL.createObjectURL(file);
            img.src = src;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const MAX_WIDTH = 1920; 
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => {
                    URL.revokeObjectURL(src);
                    if (blob) {
                         // Force JPG extension for better compatibility with compression
                        const newName = file.name.replace(/\.[^/.]+$/, "") + ".jpg";
                        resolve(new File([blob], newName, { type: 'image/jpeg', lastModified: Date.now() }));
                    } else {
                        resolve(file);
                    }
                }, 'image/jpeg', quality);
            };
            img.onerror = () => { URL.revokeObjectURL(src); resolve(file); };
        });
    }
    // ----------------------------------------

    // 5) UI helpers - FIXED TO APPEND RATHER THAN REPLACE
    function previewImages() {
      preview.innerHTML = '';
      selectedImageFiles.forEach((file, index) => {
        if (!file.type.startsWith('image/')) return;
        const url = URL.createObjectURL(file);
        const imgDiv = document.createElement('div');
        imgDiv.className = "relative group";
        imgDiv.innerHTML = `
            <img src="${url}" class="w-full h-20 object-cover rounded-lg border" />
            <button onclick="removeSelectedImage(${index})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">Ã—</button>
        `;
        preview.appendChild(imgDiv);
      });
    }

    window.removeSelectedImage = function(index) {
        selectedImageFiles.splice(index, 1);
        previewImages();
    };

    function previewVideo(file) {
      if (!file || !file.type.startsWith('video/')) {
        console.error('Invalid video file:', file);
        return;
      }
      const url = URL.createObjectURL(file);
      videoPreview.innerHTML = `
        <video src="${url}" controls class="mx-auto w-full rounded-lg" style="max-height: 240px;"></video>
        <div class="text-xs text-gray-500 mt-1 truncate">${file.name}</div>
      `;
    }

    // 6) Lazy load images
    function setupLazyLoading() {
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.add('loaded');
            img.removeAttribute('data-src');
            obs.unobserve(img);
          }
        });
      }, { rootMargin: '100px' });

      const images = galleryGrid.querySelectorAll('img[data-src]');
      images.forEach(img => observer.observe(img));
    }

    // 7) Drag & Drop and Click-to-Upload
    function setupDropZone(zone, input, isImage) {
      zone.addEventListener('click', () => {
        input.click();
      });

      zone.addEventListener('dragenter', (e) => {
        e.preventDefault();
        zone.classList.add('active');
        globalDropOverlay.classList.remove('active');
      });
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('active');
      });
      zone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        if (!zone.contains(e.relatedTarget)) {
          zone.classList.remove('active');
        }
      });
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('active');
        globalDropOverlay.classList.remove('active');
        const files = e.dataTransfer.files;
        if (files.length) {
          handleFiles(files, isImage);
        }
      });
    }

    function handleFiles(files, isImage) {
        if (isImage) {
            selectedImageFiles.push(...Array.from(files));
            previewImages();
        } else {
            videoInput.files = files;
            previewVideo(files[0]);
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    setupDropZone(imageDropZone, imageInput, true);
    setupDropZone(videoDropZone, videoInput, false);

    window.addEventListener('dragenter', (e) => {
      e.preventDefault();
      if (!imageDropZone.contains(e.target) && !videoDropZone.contains(e.target)) {
        globalDropOverlay.classList.add('active');
      }
    });
    window.addEventListener('dragover', (e) => {
      e.preventDefault();
    });
    window.addEventListener('dragleave', (e) => {
      e.preventDefault();
      if (!e.relatedTarget || e.relatedTarget === document.documentElement || e.relatedTarget === document.body) {
        globalDropOverlay.classList.remove('active');
      }
    });
    window.addEventListener('drop', (e) => {
      e.preventDefault();
      globalDropOverlay.classList.remove('active');
      if (!imageDropZone.contains(e.target) && !videoDropZone.contains(e.target)) {
        const files = e.dataTransfer.files;
        if (files.length) {
          if (files[0].type.startsWith('image/')) {
            handleFiles(files, true);
          } else if (files[0].type.startsWith('video/')) {
            handleFiles(files, false);
          }
        }
      }
    });

    imageInput.addEventListener('change', () => {
      if (imageInput.files.length) {
        handleFiles(imageInput.files, true);
        imageInput.value = ''; // Reset so same file can be picked again
      }
    });
    videoInput.addEventListener('change', () => {
      if (videoInput.files.length) {
        previewVideo(videoInput.files[0]);
      }
    });

    // 8) Upload flow
    uploadBtn.addEventListener('click', () => {
      uploadBatch();
    });

    async function uploadBatch() {
      try {
        const baseName = document.getElementById('nameInput').value.trim();
        const priceInput = parseFloat(document.getElementById('priceInput').value.trim());
        const partyCode = document.getElementById('partyCodeInput').value.trim();
        const videourlInputEl = document.getElementById('videourlInput');

        if (!selectedImageFiles.length) return alert('Please select at least one image.');
        if (!baseName) return alert('Please enter a product name.');
        if (!partyCode) return alert('Please enter a party code.');
        if (isNaN(priceInput) || priceInput <= 0) return alert('Please enter a valid price.');

        const price = priceInput / 2;
        let sharedVideoURL = (videourlInputEl.value || '').trim();

        if (videoInput.files && videoInput.files[0]) {
          const videoFile = videoInput.files[0];
          const vRef = storage.ref(`videos/${new Date().getTime()}_${videoFile.name}`);
          
          const videoStatus = document.createElement('div');
          videoStatus.className = 'p-2 mb-2 text-sm bg-blue-50 text-blue-700 rounded font-bold';
          videoStatus.textContent = 'Uploading shared video...';
          progressList.prepend(videoStatus);

          try {
            await vRef.put(videoFile);
            sharedVideoURL = await vRef.getDownloadURL();
            videoStatus.textContent = 'Shared video uploaded.';
            setTimeout(() => videoStatus.remove(), 2000);
          } catch (err) {
            console.error('Video upload failed:', err);
            videoStatus.textContent = 'Video upload failed. Continuing with images only.';
          }
        }

        for (let i = 0; i < selectedImageFiles.length; i++) {
          let file = selectedImageFiles[i]; // Changed from const to let for compression
          const productName = selectedImageFiles.length > 1 ? `${baseName} ${i + 1}` : baseName;
          
          // --- ADDED: Compress ---
          try {
             file = await compressImage(file); 
             console.log("Compressed file size:", (file.size/1024).toFixed(2), "KB");
          } catch(e) { console.error("Compression failed", e); }
          // -----------------------

          const thumbDataURL = await fileToDataURL(file);
          const progressContainer = document.createElement('div');
          progressContainer.className = 'p-3 bg-gray-100 rounded border border-gray-200';
          progressContainer.innerHTML = `
            <div class="flex items-center">
              <img src="${thumbDataURL}" class="w-12 h-12 object-cover rounded mr-4" />
              <div class="flex-grow">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium text-gray-800 truncate w-48">${productName}</span>
                  <span class="status text-xs text-blue-600 font-bold italic">Waiting...</span>
                </div>
                <div class="bg-gray-300 rounded-full h-2">
                  <div class="progress-bar bg-blue-600 h-2 rounded-full w-0 transition-all duration-300"></div>
                </div>
              </div>
            </div>
          `;
          progressList.prepend(progressContainer);

          uploadQueue.push({
            file,
            name: productName,
            price,
            partyCode,
            videourl: sharedVideoURL,
            progressContainer
          });
        }

        // Reset state
        selectedImageFiles = [];
        imageInput.value = '';
        videoInput.value = '';
        document.getElementById('nameInput').value = '';
        document.getElementById('priceInput').value = '';
        document.getElementById('videourlInput').value = '';
        preview.innerHTML = '';
        videoPreview.innerHTML = '';

        processUploadQueue();
      } catch (err) {
        console.error('Batch prep failed:', err);
      }
    }

    function sanitizePath(s) {
      return s.replace(/[^\w\-]+/g, '_');
    }
    function fileToDataURL(fileToRead) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(fileToRead);
      });
    }

    async function processUploadQueue() {
      if (isUploading || uploadQueue.length === 0) return;

      isUploading = true;
      const item = uploadQueue.shift();

      const { file, name, price, partyCode, videourl, progressContainer } = item;
      const progressBar = progressContainer.querySelector('.progress-bar');
      const statusEl = progressContainer.querySelector('.status');

      const now = new Date().toISOString();
      const storageRef = storage.ref().child(`images/${now}_${sanitizePath(name)}_${file.name}`);

      try {
        await new Promise((resolve, reject) => {
          const task = storageRef.put(file);
          task.on('state_changed',
            (snap) => {
              const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
              progressBar.style.width = pct + '%';
              statusEl.textContent = `${pct}%`;
            },
            reject,
            async () => {
              try {
                const imageURL = await storageRef.getDownloadURL();
                const data = {
                  name,
                  price,
                  partyCode,
                  url: imageURL,
                  videourl: videourl || '',
                  outOfStock: false,
                  date: new Date().toISOString()
                };
                await database.ref().push().set(data);
                statusEl.textContent = 'DONE';
                progressBar.style.width = '100%';
                setTimeout(() => progressContainer.remove(), 1000);
                resolve();
              } catch (e) { reject(e); }
            }
          );
        });
      } catch (err) {
        statusEl.textContent = 'ERROR';
        progressBar.classList.add('bg-red-500');
      } finally {
        isUploading = false;
        processUploadQueue();
      }
    }

    // 9) Render cards
    function renderCard(key, data) {
      const container = document.createElement('div');
      container.className = 'bg-white rounded-xl shadow overflow-hidden';
      container.dataset.key = key;

      container.innerHTML = `
        <img data-src="${data.url}" alt="${escapeHtml(data.name)}"  style="height: 16rem;" class="w-full h-48 object-cover" loading="lazy">
        <div class="p-4">
          <h3 class="font-semibold text-lg mb-2 editable-field truncate-2" onclick="makeEditable(this, '${key}', 'name')" title="Click to edit name">
            ${escapeHtml(data.name)}
          </h3>

          <p class="text-gray-600 mb-1 editable-field" onclick="makeEditable(this, '${key}', 'price')" title="Click to edit price">
            Price: ${Number(data.price).toFixed(2)}
          </p>
          <p class="text-gray-600 mb-2 editable-field" onclick="makeEditable(this, '${key}', 'partyCode')" title="Click to edit party code">
            Party Code: ${escapeHtml(data.partyCode || '')}
          </p>

          <div class="mt-2" id="videoRow-${key}">
            <p class="text-gray-600 mb-2 editable-field" onclick="makeEditableVideo(this, '${key}', 'videourl')" title="Click to edit video URL">
              Video URL: ${escapeHtml(data.videourl || 'No video')}
            </p>
            ${
              data.videourl
                ? `<a href="${data.videourl}" target="_blank" class="text-blue-600 hover:underline text-sm">Watch video</a>`
                : ''
            }
          </div>

          <div class="flex justify-between items-center mt-3">
            <p class="text-gray-600 status-display-${key}">Status: ${data.outOfStock ? 'Out of Stock' : 'Available'}</p>
            <button onclick="toggleStockStatus('${key}', ${!!data.outOfStock})"
              class="text-white py-1 px-3 rounded-full text-sm font-semibold ${data.outOfStock ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}">
              ${data.outOfStock ? 'Mark Available' : 'Mark Out of Stock'}
            </button>
          </div>

          <div class="flex justify-between items-center mt-2">
            <p class="text-sm text-gray-500 uploaded-date-${key}">Uploaded: ${data.date || new Date().toISOString()}</p>
            <button onclick="updateUploadDate('${key}')" class="text-white py-1 px-3 rounded-full text-xs font-semibold bg-blue-500 hover:bg-blue-600">
              Update Date
            </button>
          </div>

          <div class="flex flex-wrap gap-2 items-center mt-4">
            <button onclick="replaceImage('${key}', '${encodeURIComponent(data.url || '')}')"
              class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded text-sm">
              Replace Image
            </button>
            <button onclick="replaceVideo('${key}', '${encodeURIComponent(data.videourl || '')}')"
              class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded text-sm">
              Replace Video
            </button>
            ${
              data.videourl
                ? `<button onclick="removeVideo('${key}', '${encodeURIComponent(data.videourl || '')}')"
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded text-sm">
                    Remove Video
                  </button>`
                : ''
            }
            <button onclick="confirmDelete('${key}')"
              class="ml-auto bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
              Delete
            </button>
          </div>
        </div>
      `;
      return container;
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, s => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      }[s]));
    }

    function batchRenderGallery(nameQuery = '', partyCodeQuery = '') {
      const fragment = document.createDocumentFragment();
      const nameLower = nameQuery.toLowerCase().trim();
      const partyCodeLower = partyCodeQuery.toLowerCase().trim();

      const filteredProducts = products.filter(({ data }) => {
        const nameMatch = !nameLower || (data.name && data.name.toLowerCase().includes(nameLower));
        const partyCodeMatch = !partyCodeLower || (data.partyCode && data.partyCode.toLowerCase() === partyCodeLower);
        return nameMatch && partyCodeMatch;
      });

      filteredProducts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

      const batchSize = 20;
      const batch = filteredProducts.slice(0, batchSize);
      batch.forEach(({ key, data }) => {
        const card = renderCard(key, data);
        fragment.appendChild(card);
      });

      galleryGrid.innerHTML = '';
      galleryGrid.appendChild(fragment);
      setupLazyLoading();

      let isLoadingMore = false;
      let lastIndex = batchSize;
      window.removeEventListener('scroll', window.scrollHandler); 
      window.scrollHandler = () => {
        if (isLoadingMore || lastIndex >= filteredProducts.length) return;
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
          isLoadingMore = true;
          const nextBatch = filteredProducts.slice(lastIndex, lastIndex + batchSize);
          const nextFragment = document.createDocumentFragment();
          nextBatch.forEach(({ key, data }) => {
            const card = renderCard(key, data);
            nextFragment.appendChild(card);
          });
          galleryGrid.appendChild(nextFragment);
          lastIndex += batchSize;
          setupLazyLoading();
          isLoadingMore = false;
        }
      };
      window.addEventListener('scroll', window.scrollHandler);
    }

    database.ref().on('value', (snapshot) => {
      products = [];
      snapshot.forEach(childSnapshot => {
        products.push({ key: childSnapshot.key, data: childSnapshot.val() || {} });
      });
      batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);
    });

    // Event listeners for search
    nameSearchInput.addEventListener('input', debounce(() => {
        batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);
    }, 300));

    partyCodeSearchInput.addEventListener('input', debounce(() => {
        batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);
    }, 300));

    // Inline editing functions
    window.makeEditable = function(el, key, field) {
      const isPrice = field === 'price';
      const prev = el.textContent.replace(/^Price:\s*/i, '').replace(/^Party Code:\s*/i, '').trim();
      const input = document.createElement('input');
      input.type = isPrice ? 'number' : 'text';
      if (isPrice) input.step = '0.01';
      input.value = prev;
      input.className = 'w-full border border-gray-300 rounded px-2 py-1';
      el.replaceWith(input);
      input.focus();
      input.select();
      function commit() {
        let value = input.value.trim();
        if (isPrice) value = (parseFloat(value || '0') || 0);
        database.ref(key).update({[field]: value});
      }
      input.addEventListener('blur', commit);
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') commit(); });
    };

   // Inline editing functions
    window.makeEditable = function(el, key, field) {
      const isPrice = field === 'price';
      const prev = el.textContent.replace(/^Price:\s*/i, '').replace(/^Party Code:\s*/i, '').trim();
      const input = document.createElement('input');
      input.type = isPrice ? 'number' : 'text';
      if (isPrice) input.step = '0.01';
      input.value = prev;
      input.className = 'w-full border border-gray-300 rounded px-2 py-1';
      el.replaceWith(input);
      input.focus();
      input.select();
      
      function commit() {
        let value = input.value.trim();
        if (isPrice) {
          // Parse the input and divide by 2
          let rawPrice = parseFloat(value || '0');
          value = rawPrice / 2; 
        }
        database.ref(key).update({[field]: value});
      }
      
      input.addEventListener('blur', commit);
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') commit(); });
    };

    window.toggleStockStatus = (key, cur) => database.ref(key).update({outOfStock: !cur});
    window.updateUploadDate = (key) => database.ref(key).update({date: new Date().toISOString()});
    window.confirmDelete = (key) => { if(confirm('Delete?')) deleteProduct(key); };

    function isFirebaseStorageUrl(url) { return url && url.includes('firebasestorage.googleapis.com'); }

    async function deleteProduct(key) {
      const snapshot = await database.ref(key).once('value');
      const data = snapshot.val();
      if (data.url && isFirebaseStorageUrl(data.url)) storage.refFromURL(data.url).delete().catch(() => {});
      if (data.videourl && isFirebaseStorageUrl(data.videourl)) storage.refFromURL(data.videourl).delete().catch(() => {});
      database.ref(key).remove();
    }

    window.replaceImage = function(key, currentImageUrlEncoded) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async () => {
        let file = input.files[0]; // Changed const to let
        
        // --- ADDED: Compress ---
        try { file = await compressImage(file); } catch(e) {}
        // -----------------------

        const ref = storage.ref().child(`images/${new Date().toISOString()}_REPLACE_${file.name}`);
        await ref.put(file);
        const newUrl = await ref.getDownloadURL();
        database.ref(key).update({ url: newUrl });
      };
      input.click();
    };

    window.replaceVideo = function(key, currentVideoUrlEncoded) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'video/*';
      input.onchange = async () => {
        const file = input.files[0];
        const ref = storage.ref().child(`videos/${new Date().toISOString()}_REPLACE_${file.name}`);
        await ref.put(file);
        const newUrl = await ref.getDownloadURL();
        database.ref(key).update({ videourl: newUrl });
      };
      input.click();
    };

    window.removeVideo = async (key) => { if(confirm('Remove video?')) database.ref(key).update({videourl: ''}); };

  </script>
</body>
</html>
