<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hindustan Toys - Turbo v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <style>
    .drop-zone { border: 5px dashed #cbd5e1; transition: 0.3s; }
    .drop-zone.active { background-color: #f0f9ff; border-color: #3b82f6; transform: scale(1.01); }
    #globalDropOverlay { display: none; pointer-events: none; z-index: 999; }
    #globalDropOverlay.active { display: flex; pointer-events: all; }
    img[data-src] { opacity: 0; transition: opacity 0.5s; }
    img.loaded { opacity: 1; }
    /* Massive Card Image */
    .product-card img { height: 400px; width: 100%; object-fit: contain; background: white; }
    .status-pill { transition: all 0.2s ease-in-out; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div id="globalDropOverlay" class="fixed inset-0 bg-blue-600/30 items-center justify-center backdrop-blur-sm">
    <div class="bg-white p-16 rounded-[4rem] shadow-2xl border-8 border-blue-600">
       <h2 class="text-5xl font-black text-blue-600">DROP TO ADD üß∏</h2>
    </div>
  </div>

  <div class="max-w-[1600px] mx-auto px-6 py-10">
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-4">
      <div>
        <h1 class="text-5xl font-black text-slate-900 tracking-tight">HINDUSTAN <span class="text-blue-600">TOYS</span></h1>
        <p class="text-slate-500 font-bold uppercase tracking-widest text-xs mt-2">Inventory Management System</p>
      </div>
      <div id="uploadStatus" class="hidden bg-blue-600 text-white px-6 py-3 rounded-full font-black animate-pulse shadow-lg">UPLOADING IN PROGRESS...</div>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-10">
      <div class="xl:col-span-4 space-y-8">
        <div class="bg-white rounded-[3rem] shadow-2xl p-8 border border-slate-100">
          <h2 class="text-2xl font-black mb-6">‚ú® NEW ARRIVALS</h2>
          
          <div class="grid grid-cols-1 gap-4 mb-6">
            <input id="nameInput" type="text" class="w-full rounded-2xl border-slate-200 p-4 font-bold focus:ring-4 focus:ring-blue-100" placeholder="Product Name" />
            <div class="grid grid-cols-2 gap-4">
              <input id="priceInput" type="number" class="w-full rounded-2xl border-slate-200 p-4 font-bold" placeholder="Full Price" />
              <input id="partyCodeInput" type="text" class="w-full rounded-2xl border-slate-200 p-4 font-bold" placeholder="Party Code" />
            </div>
            <input id="videourlInput" type="url" class="w-full rounded-2xl border-slate-200 p-4 font-bold" placeholder="Video URL (Link)" />
          </div>

          <div class="drop-zone rounded-[2.5rem] p-10 text-center cursor-pointer bg-slate-50 border-slate-200" id="imageDropZone">
            <p class="text-slate-400 font-black uppercase text-xs tracking-widest mb-4">Tap or Drag Images Here</p>
            <div class="preview flex flex-wrap gap-6 justify-center" id="preview"></div>
            <input type="file" id="imageInput" class="hidden" accept="image/*" multiple />
          </div>

          <div class="drop-zone rounded-3xl p-4 text-center cursor-pointer mt-4 bg-slate-50 border-slate-100" id="videoDropZone">
            <p class="text-slate-400 text-[10px] font-black uppercase" id="videoInfo">Optional: Attach Video File</p>
            <input type="file" id="videoInput" class="hidden" accept="video/*" />
          </div>

          <button id="uploadBtn" class="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-black py-6 rounded-[2.5rem] shadow-2xl shadow-blue-200 transition active:scale-95 text-xl uppercase tracking-wider">
            Add to Inventory
          </button>
          <button id="clearQueueBtn" class="w-full mt-4 text-xs text-red-500 font-black uppercase hidden">Clear Selection</button>
        </div>
      </div>

      <div class="xl:col-span-8 space-y-10">
        <div class="bg-white rounded-[3rem] shadow-xl p-8 border border-slate-100">
          <h2 class="text-2xl font-black mb-6">üîç QUICK SEARCH</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <input id="nameSearchInput" type="text" class="w-full rounded-2xl border-slate-200 p-5 focus:ring-4 focus:ring-blue-500/10 font-bold" placeholder="Search by name..." />
            <input id="partyCodeSearchInput" type="text" class="w-full rounded-2xl border-slate-200 p-5 focus:ring-4 focus:ring-blue-500/10 font-bold" placeholder="Search by Party Code..." />
          </div>
        </div>

        <div id="progressGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        
        <div id="galleryGrid" class="grid grid-cols-1 md:grid-cols-2 gap-10"></div>
      </div>
    </div>
  </div>

  <script>
    // --- FIREBASE INITIALIZATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyAvlig_xWJNP1hFsl4qfisC01VTkOAVhT8",
      authDomain: "htshop-e9c51.firebaseapp.com",
      databaseURL: "https://htshop-e9c51-default-rtdb.firebaseio.com",
      projectId: "htshop-e9c51",
      storageBucket: "htshop-e9c51.appspot.com",
      messagingSenderId: "653137640907",
      appId: "1:653137640907:web:672fd6a9e85ca448a70a4e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const st = firebase.storage();

    let selectedFiles = [];
    let uploadQueue = [];
    let isUploading = false;

    // --- NON-LAGGY DRAG & DROP ---
    const overlay = document.getElementById('globalDropOverlay');
    let dragCounter = 0;
    window.addEventListener('dragenter', (e) => { e.preventDefault(); dragCounter++; overlay.classList.add('active'); });
    window.addEventListener('dragleave', (e) => { dragCounter--; if (dragCounter === 0) overlay.classList.remove('active'); });
    window.addEventListener('dragover', (e) => e.preventDefault());
    window.addEventListener('drop', (e) => {
      e.preventDefault(); dragCounter = 0; overlay.classList.remove('active');
      if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
      Array.from(files).forEach(f => {
        if (f.type.startsWith('image/')) selectedFiles.push(f);
        else if (f.type.startsWith('video/')) {
          const dt = new DataTransfer(); dt.items.add(f);
          document.getElementById('videoInput').files = dt.files;
          document.getElementById('videoInfo').innerText = "‚úÖ VIDEO READY: " + f.name;
        }
      });
      renderMassivePreview();
    }

    function renderMassivePreview() {
      const p = document.getElementById('preview'); p.innerHTML = '';
      selectedFiles.forEach((f, i) => {
        const url = URL.createObjectURL(f);
        // Previews are now w-64 (256px) - Massive!
        p.innerHTML += `
          <div class="relative">
            <img src="${url}" class="w-64 h-64 rounded-[2rem] object-cover shadow-2xl border-8 border-white">
            <button onclick="removeFile(${i})" class="absolute -top-4 -right-4 bg-red-600 text-white rounded-full w-10 h-10 font-black shadow-xl">‚úï</button>
          </div>`;
      });
      document.getElementById('clearQueueBtn').classList.toggle('hidden', selectedFiles.length === 0);
    }

    window.removeFile = (i) => { selectedFiles.splice(i,1); renderMassivePreview(); };
    document.getElementById('imageDropZone').onclick = () => document.getElementById('imageInput').click();
    document.getElementById('videoDropZone').onclick = () => document.getElementById('videoInput').click();
    document.getElementById('imageInput').onchange = (e) => handleFiles(e.target.files);

    // --- SURGICAL RENDERER ---
    function getCardHtml(key, data) {
      const history = data.partyCodeHistory || [];
      const statusColor = data.outOfStock ? 'text-red-500' : 'text-green-500';
      const btnColor = data.outOfStock ? 'bg-red-500' : 'bg-green-600';
      const statusText = data.outOfStock ? 'SOLD OUT' : 'IN STOCK';

      return `
        <img data-src="${data.url}" class="w-full">
        <div class="p-10">
          <h3 class="text-3xl font-black truncate uppercase mb-6 cursor-pointer" onclick="editField('${key}','name','${data.name}')">${data.name}</h3>
          
          <div class="flex justify-between items-end border-b-2 border-slate-50 pb-8 mb-8">
            <div>
              <p class="text-xs font-black text-slate-300 uppercase tracking-widest mb-1">Our Price</p>
              <p class="text-4xl font-black text-green-600 cursor-pointer" onclick="editPrice('${key}',${data.price})">‚Çπ${data.price.toFixed(2)}</p>
            </div>
            <div class="text-right">
              <p class="text-xs font-black text-slate-300 uppercase tracking-widest mb-1">Party Code</p>
              <p class="text-xl font-black text-blue-600 cursor-pointer" onclick="editPartyCode('${key}','${data.partyCode}')">${data.partyCode}</p>
              <p class="text-[10px] text-slate-300 font-bold">${history.length ? 'Prev: ' + history.join(', ') : ''}</p>
            </div>
          </div>

          <div class="flex justify-between items-center mb-8">
            <span class="text-sm font-black ${statusColor} tracking-tighter">${statusText}</span>
            <button id="stock-btn-${key}" onclick="toggleStock('${key}', ${!!data.outOfStock})" class="py-4 px-8 rounded-2xl text-xs font-black text-white shadow-xl transition active:scale-95 ${btnColor}">
              ${data.outOfStock ? 'MARK AVAILABLE' : 'MARK SOLD OUT'}
            </button>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <button onclick="replaceImage('${key}', '${encodeURIComponent(data.url)}')" class="bg-amber-400 text-amber-900 font-black py-4 rounded-2xl text-[10px] uppercase">Image</button>
            <button onclick="editVideo('${key}')" class="bg-slate-900 text-white font-black py-4 rounded-2xl text-[10px] uppercase">Video</button>
            <button onclick="confirmDelete('${key}')" class="bg-slate-100 text-slate-400 font-black py-4 rounded-2xl hover:bg-red-500 hover:text-white transition">Delete</button>
          </div>
          ${data.videourl ? `<a href="${data.videourl}" target="_blank" class="block text-center mt-6 text-xs font-bold text-blue-500 underline">Watch Toy Video</a>` : ''}
        </div>
      `;
    }

    // --- RAPID DATABASE ACTIONS ---
    window.toggleStock = (key, current) => {
      // Optimistic Update: Change button immediately in UI
      const btn = document.getElementById(`stock-btn-${key}`);
      btn.innerText = "UPDATING...";
      btn.style.opacity = "0.5";
      db.ref(key).update({ outOfStock: !current });
    };

    window.editPrice = (k, c) => { const p = prompt("Enter Full Price:", c*2); if(p) db.ref(k).update({ price: parseFloat(p)/2 }); };
    window.editField = (k, f, c) => { const v = prompt(`Edit ${f}:`, c); if(v) db.ref(k).update({ [f]: v }); };
    window.editPartyCode = async (k, c) => {
      const n = prompt("Change Code:", c);
      if (n && n !== c) {
        const snap = await db.ref(k).once('value');
        const h = snap.val().partyCodeHistory || []; h.push(c);
        await db.ref(k).update({ partyCode: n, partyCodeHistory: h });
      }
    };
    window.editVideo = (key) => {
      const v = prompt("Paste Video Link or leave blank to upload file:");
      if (v) return db.ref(key).update({ videourl: v });
      const i = document.createElement('input'); i.type = 'file'; i.accept = 'video/*';
      i.onchange = async () => {
        const f = i.files[0]; const vRef = st.ref(`vids/${Date.now()}_${f.name}`);
        await vRef.put(f); const url = await vRef.getDownloadURL();
        await db.ref(key).update({ videourl: url });
      };
      i.click();
    };
    window.confirmDelete = (k) => confirm("Bhaiya, delete this toy?") && db.ref(k).remove();
    window.replaceImage = (key, old) => {
      const i = document.createElement('input'); i.type = 'file'; i.accept = 'image/*';
      i.onchange = async () => {
        const f = i.files[0]; const sRef = st.ref(`stock/${Date.now()}_${f.name}`);
        await sRef.put(f); const url = await sRef.getDownloadURL();
        await db.ref(key).update({ url });
      };
      i.click();
    };

    // --- UPLOAD PROCESS ---
    document.getElementById('uploadBtn').onclick = async () => {
      const name = document.getElementById('nameInput').value.trim() || "Toy";
      const price = (parseFloat(document.getElementById('priceInput').value) || 0) / 2;
      const code = document.getElementById('partyCodeInput').value.trim() || "N/A";
      const vidFile = document.getElementById('videoInput').files[0];
      let vUrl = document.getElementById('videourlInput').value.trim();

      if (!selectedFiles.length) return alert("Bhaiya, please select images!");

      document.getElementById('uploadStatus').classList.remove('hidden');
      if (vidFile) {
        const vRef = st.ref(`vids/${Date.now()}_${vidFile.name}`);
        await vRef.put(vidFile);
        vUrl = await vRef.getDownloadURL();
      }

      selectedFiles.forEach((file, i) => {
        const fName = selectedFiles.length > 1 ? `${name} ${i+1}` : name;
        const prog = document.createElement('div');
        prog.className = 'bg-white p-5 rounded-3xl border border-slate-100 flex items-center gap-4 shadow-sm';
        prog.innerHTML = `<div class="flex-1 truncate font-black text-slate-800 text-sm">${fName}</div><div class="w-32 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="progress-bar bg-blue-600 h-full w-0 transition-all"></div></div>`;
        document.getElementById('progressGrid').appendChild(prog);
        uploadQueue.push({ file, name: fName, price, partyCode: code, videourl: vUrl, prog });
      });

      selectedFiles = []; renderMassivePreview();
      document.getElementById('videoInfo').innerText = "Optional: Attach Video File";
      processQueue();
    };

    async function processQueue() {
      if (isUploading || !uploadQueue.length) {
          if(!uploadQueue.length) document.getElementById('uploadStatus').classList.add('hidden');
          return;
      }
      isUploading = true;
      const item = uploadQueue.shift();
      const bar = item.prog.querySelector('.progress-bar');
      const sRef = st.ref(`stock/${Date.now()}_${item.file.name}`);
      const task = sRef.put(item.file);

      task.on('state_changed', (s) => bar.style.width = (s.bytesTransferred/s.totalBytes*100)+'%', null, async () => {
        const url = await sRef.getDownloadURL();
        await db.ref().push({
          name: item.name, price: item.price, partyCode: item.partyCode,
          url, videourl: item.videourl || '', outOfStock: false,
          date: new Date().toISOString(), partyCodeHistory: []
        });
        item.prog.remove(); isUploading = false; processQueue();
      });
    }

    // --- REALTIME LISTENERS (Surgical Updates) ---
    const grid = document.getElementById('galleryGrid');
    
    // Child Added: Fast prepend
    db.ref().on('child_added', (snap) => {
        const data = snap.val();
        if(!data.url) return;
        const card = document.createElement('div');
        card.id = `card-${snap.key}`;
        card.className = 'product-card bg-white rounded-[3rem] shadow-xl overflow-hidden border border-slate-100';
        card.innerHTML = getCardHtml(snap.key, data);
        grid.prepend(card);
        observeImage(card.querySelector('img'));
    });

    // Child Changed: Surgical Refresh
    db.ref().on('child_changed', (snap) => {
        const card = document.getElementById(`card-${snap.key}`);
        if(card) {
            card.innerHTML = getCardHtml(snap.key, snap.val());
            observeImage(card.querySelector('img'));
        }
    });

    // Child Removed
    db.ref().on('child_removed', (snap) => {
        const card = document.getElementById(`card-${snap.key}`);
        if(card) card.remove();
    });

    // Lazy Loading
    function observeImage(img) {
      const obs = new IntersectionObserver((es, o) => {
        es.forEach(e => { if(e.isIntersecting){ e.target.src = e.target.dataset.src; e.target.classList.add('loaded'); o.unobserve(e.target); } });
      });
      obs.observe(img);
    }

    // Search Filter
    function filterInventory() {
      const nameQ = document.getElementById('nameSearchInput').value.toLowerCase();
      const codeQ = document.getElementById('partyCodeSearchInput').value.toLowerCase();
      
      document.querySelectorAll('.product-card').forEach(card => {
        const name = card.querySelector('h3').innerText.toLowerCase();
        const code = card.querySelector('.text-blue-600').innerText.toLowerCase();
        if(name.includes(nameQ) && code.includes(codeQ)) card.style.display = 'block';
        else card.style.display = 'none';
      });
    }

    document.getElementById('nameSearchInput').oninput = filterInventory;
    document.getElementById('partyCodeSearchInput').oninput = filterInventory;

  </script>
</body>
</html>
