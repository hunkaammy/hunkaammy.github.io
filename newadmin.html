<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hindustan Toys - Turbo v11</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <style>
    /* Mobile-First Surgical Logic */
    * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }
    body { background-color: #f1f5f9; -webkit-overflow-scrolling: touch; }
    .toy-card { transform: translateZ(0); backface-visibility: hidden; contain: content; }
    .toy-card img { height: 180px; width: 100%; object-fit: contain; background: white; padding: 10px; }
    @media (min-width: 768px) { .toy-card img { height: 320px; } }
    #globalDropOverlay { display: none; pointer-events: none; }
    #globalDropOverlay.active { display: flex; pointer-events: all; z-index: 9999; }
    img[data-src] { opacity: 0; transition: opacity 0.3s ease-in; }
    img.loaded { opacity: 1; }
    .up-preview { width: 100px; height: 100px; border-radius: 1.5rem; object-fit: cover; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="font-sans text-slate-900">

  <div id="globalDropOverlay" class="fixed inset-0 bg-blue-600/50 items-center justify-center text-white backdrop-blur-sm">
    <div class="bg-white text-blue-600 p-10 rounded-[3rem] shadow-2xl border-8 border-blue-600 text-center mx-4">
       <h2 class="text-3xl font-black italic uppercase text-blue-600">Drop To Add ðŸ§¸</h2>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-3 py-6">
    <header class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-2xl font-black tracking-tighter italic text-slate-800 uppercase">Hindustan <span class="text-blue-600">Toys</span></h1>
        <p id="totalCount" class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Surgical Fix Active</p>
      </div>
      <div id="upIndicator" class="hidden bg-blue-600 text-white px-3 py-1 rounded-full text-[9px] font-black animate-pulse uppercase">Syncing...</div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <div class="lg:col-span-4 space-y-6">
        <div class="bg-white rounded-[2rem] shadow-xl p-6 border border-slate-100">
          <h2 class="text-lg font-black mb-4">âœ¨ ADD NEW TOYS</h2>
          <div class="space-y-3 mb-4">
            <input id="nameInput" type="text" class="w-full rounded-xl border-slate-200 p-3 text-sm font-bold" placeholder="Product Name" />
            <div class="grid grid-cols-2 gap-3">
              <input id="priceInput" type="number" class="w-full rounded-xl border-slate-200 p-3 text-sm font-bold" placeholder="Full Price" />
              <input id="partyCodeInput" type="text" class="w-full rounded-xl border-slate-200 p-3 text-sm font-bold" placeholder="Code" />
            </div>
            <input id="videourlInput" type="url" class="w-full rounded-xl border-slate-200 p-3 text-sm font-bold" placeholder="Manual Video URL (Optional)" />
          </div>

          <div id="dropZone" class="bg-slate-50 border-4 border-dashed border-slate-200 rounded-3xl p-6 text-center cursor-pointer">
            <p class="text-[10px] text-slate-400 font-bold uppercase mb-4">Drag Images Here (Additive)</p>
            <div id="previewGrid" class="flex flex-wrap gap-2 justify-center"></div>
            <input type="file" id="imageInput" class="hidden" accept="image/*" multiple />
          </div>

          <div id="vZone" class="bg-blue-50/50 border-2 border-dashed border-blue-200 rounded-2xl p-4 text-center cursor-pointer mt-3">
            <p id="vLabel" class="text-[9px] text-blue-400 font-black uppercase italic tracking-widest">Optional: Drop Video File</p>
            <input type="file" id="videoInput" class="hidden" accept="video/*" />
          </div>

          <button id="uploadBtn" class="w-full mt-6 bg-blue-600 text-white font-black py-4 rounded-[1.5rem] shadow-xl active:scale-95 transition-transform uppercase text-sm italic tracking-widest">
            Upload All Items
          </button>
          <button id="clearAll" class="w-full mt-3 text-[10px] font-black text-red-500 uppercase hidden">Clear Selection</button>
        </div>
      </div>

      <div class="lg:col-span-8 space-y-4">
        <div class="bg-white p-4 rounded-3xl shadow-lg border border-slate-50 grid grid-cols-2 gap-3">
          <input id="nSearch" type="text" class="w-full rounded-xl border-slate-200 p-3 text-xs font-bold" placeholder="Search Name..." />
          <input id="cSearch" type="text" class="w-full rounded-xl border-slate-200 p-3 text-xs font-bold" placeholder="Search Code..." />
        </div>

        <div id="queue" class="space-y-2"></div>
        <div id="gallery" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-3 pb-20"></div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAvlig_xWJNP1hFsl4qfisC01VTkOAVhT8",
      authDomain: "htshop-e9c51.firebaseapp.com",
      databaseURL: "https://htshop-e9c51-default-rtdb.firebaseio.com",
      projectId: "htshop-e9c51",
      storageBucket: "htshop-e9c51.appspot.com",
      messagingSenderId: "653137640907",
      appId: "1:653137640907:web:672fd6a9e85ca448a70a4e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const st = firebase.storage();

    let masterList = [];
    let selectedImages = [];
    let attachedVideo = null;
    let isUploading = false;
    let pendingUploads = [];

    // --- ELEMENT ACCESS (FIXED NULL CRASH) ---
    const getEl = (id) => document.getElementById(id);

    // --- RAPID OVERLAY ---
    const overlay = getEl('globalDropOverlay');
    let dCounter = 0;
    window.addEventListener('dragenter', (e) => { e.preventDefault(); dCounter++; overlay.classList.add('active'); });
    window.addEventListener('dragleave', (e) => { dCounter--; if(dCounter === 0) overlay.classList.remove('active'); });
    window.addEventListener('dragover', (e) => e.preventDefault());
    window.addEventListener('drop', (e) => { e.preventDefault(); dCounter = 0; overlay.classList.remove('active'); if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); });

    function handleFiles(files) {
      Array.from(files).forEach(f => {
        if(f.type.startsWith('image/')) selectedImages.push(f);
        else if(f.type.startsWith('video/')) { attachedVideo = f; getEl('vLabel').innerText = "âœ… VIDEO READY: " + f.name; }
      });
      renderPreviews();
    }

    function renderPreviews() {
      const g = getEl('previewGrid'); g.innerHTML = '';
      selectedImages.forEach((f, i) => {
        const url = URL.createObjectURL(f);
        g.innerHTML += `<div class="relative"><img src="${url}" class="up-preview"><button onclick="removeImg(${i})" class="absolute -top-1 -right-1 bg-red-600 text-white rounded-full w-5 h-5 text-[10px]">âœ•</button></div>`;
      });
      getEl('clearAll').classList.toggle('hidden', selectedImages.length === 0);
    }

    window.removeImg = (i) => { selectedImages.splice(i,1); renderPreviews(); };
    getEl('dropZone').onclick = () => getEl('imageInput').click();
    getEl('vZone').onclick = () => getEl('videoInput').click();
    getEl('imageInput').onchange = (e) => handleFiles(e.target.files);
    getEl('videoInput').onchange = (e) => { attachedVideo = e.target.files[0]; getEl('vLabel').innerText = "âœ… VIDEO READY"; };
    getEl('clearAll').onclick = () => { selectedImages = []; attachedVideo = null; renderPreviews(); getEl('vLabel').innerText = "Optional: Drop Video File"; };

    // --- SEARCH ENGINE ---
    function performSearch() {
      const nQ = getEl('nSearch').value.toLowerCase().trim();
      const cQ = getEl('cSearch').value.toLowerCase().trim();
      const grid = getEl('gallery');
      const filtered = masterList.filter(toy => {
         const name = (toy.data.name || "").toLowerCase();
         const code = (toy.data.partyCode || "").toLowerCase();
         return name.includes(nQ) && code.includes(cQ);
      });
      grid.innerHTML = '';
      filtered.sort((a,b) => new Date(b.data.date) - new Date(a.data.date)).forEach(toy => grid.appendChild(createToyCard(toy.key, toy.data)));
      getEl('totalCount').innerText = `${filtered.length} TOYS FOUND`;
      initLazy();
    }

    // --- TOY CARD UI ---
    function createToyCard(key, data) {
      const history = data.partyCodeHistory || [];
      const card = document.createElement('div');
      card.className = 'toy-card bg-white rounded-2xl shadow-md border border-slate-50 flex flex-col overflow-hidden';
      card.id = `card-${key}`;
      card.innerHTML = `
        <div class="relative">
          <img data-src="${data.url}" class="w-full">
          ${data.videourl ? '<div class="absolute top-2 right-2 bg-blue-600 text-white p-1 rounded-full"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168l5 3a.5.5 0 010 .864l-5 3A.5.5 0 019 13.596V7.404a.5.5 0 01.755-.432z"></path></svg></div>' : ''}
        </div>
        <div class="p-4 flex-1 flex flex-col">
          <h3 class="text-[12px] font-black truncate uppercase mb-1" onclick="editField('${key}','name','${data.name}')">${data.name}</h3>
          <div class="flex justify-between items-end border-b border-slate-50 pb-2 mb-2">
            <div>
              <p class="text-[7px] font-black text-slate-300 uppercase">PRICE</p>
              <p class="text-sm font-black text-green-600" onclick="editPrice('${key}',${data.price})">â‚¹${data.price.toFixed(0)}</p>
            </div>
            <div class="text-right">
              <p class="text-[7px] font-black text-slate-300 uppercase">CODE</p>
              <p class="text-[10px] font-black text-blue-600" onclick="editCode('${key}','${data.partyCode}')">${data.partyCode}</p>
            </div>
          </div>
          <div class="flex justify-between items-center mb-3">
             <span class="text-[10px] font-black uppercase ${data.outOfStock ? 'text-red-500' : 'text-green-500'}">${data.outOfStock ? 'Sold Out' : 'Available'}</span>
             <button onclick="toggleStock('${key}', ${!!data.outOfStock})" class="py-1.5 px-3 rounded-lg text-[8px] font-black text-white shadow-sm ${data.outOfStock ? 'bg-red-500' : 'bg-green-600'}">
                ${data.outOfStock ? 'MAKE IN STOCK' : 'MARK SOLD OUT'}
             </button>
          </div>
          <div class="flex justify-between items-center mb-3 border-t pt-2 border-slate-50">
             <span class="text-[8px] text-slate-400 font-bold">Uploaded: ${data.date ? data.date.split('T')[0] : 'N/A'}</span>
             <button onclick="instantRefill('${key}')" class="bg-blue-600 text-white px-3 py-1 rounded-full text-[8px] font-bold shadow-lg shadow-blue-50">REFILL TOP</button>
          </div>
          <div class="mt-auto grid grid-cols-3 gap-1">
             <button onclick="replaceImg('${key}')" class="bg-amber-400 text-amber-900 font-bold py-2 rounded-lg text-[8px] uppercase">Img</button>
             <button onclick="replaceVid('${key}')" class="bg-slate-800 text-white font-bold py-2 rounded-lg text-[8px] uppercase">Vid</button>
             <button onclick="delToy('${key}')" class="bg-slate-50 text-slate-300 px-2 rounded-lg">âœ•</button>
          </div>
          ${data.videourl ? `<a href="${data.videourl}" target="_blank" class="block text-center mt-3 text-[8px] font-bold text-blue-500 underline uppercase italic">Demo Link</a>` : ''}
        </div>
      `;
      return card;
    }

    // --- SURGICAL ACTIONS ---
    window.instantRefill = (k) => {
       const card = getEl(`card-${k}`); const gallery = getEl('gallery');
       card.style.opacity = "0.5"; gallery.prepend(card);
       setTimeout(() => card.style.opacity = "1", 150);
       db.ref(k).update({ date: new Date().toISOString() });
    };

    window.toggleStock = (k, s) => { const b = document.querySelector(`#card-${k} button`); if(b) b.style.opacity = "0.3"; db.ref(k).update({ outOfStock: !s }); };
    window.editPrice = (k, c) => { const p = prompt("New Full Price:", c*2); if(p) db.ref(k).update({ price: parseFloat(p)/2 }); };
    window.editField = (k, f, c) => { const v = prompt(`Edit ${f}:`, c); if(v) db.ref(k).update({ [f]: v }); };
    window.editCode = async (k, c) => { const n = prompt("New Code:", c); if(n && n !== c) { const s = await db.ref(k).once('value'); const h = s.val().partyCodeHistory || []; h.push(c); await db.ref(k).update({ partyCode: n, partyCodeHistory: h }); } };
    window.replaceVid = (k) => { const v = prompt("Video Link or leave blank to upload:"); if(v) return db.ref(k).update({ videourl: v }); const i = document.createElement('input'); i.type='file'; i.accept='video/*'; i.onchange = async () => { const f = i.files[0]; const vR = st.ref(`vids/${Date.now()}_${f.name}`); await vR.put(f); const url = await vR.getDownloadURL(); await db.ref(k).update({ videourl: url }); }; i.click(); };
    window.replaceImg = (k) => { const i = document.createElement('input'); i.type='file'; i.accept='image/*'; i.onchange = async () => { const f = i.files[0]; const sR = st.ref(`toys/${Date.now()}_${f.name}`); await sR.put(f); const url = await sR.getDownloadURL(); await db.ref(k).update({ url }); }; i.click(); };
    window.delToy = (k) => confirm("Delete this toy?") && db.ref(k).remove();

    // --- UPLOAD LOGIC ---
    getEl('uploadBtn').onclick = async () => {
      const name = getEl('nameInput').value.trim(); const price = (parseFloat(getEl('priceInput').value) || 0) / 2; const code = getEl('partyCodeInput').value.trim();
      if(!selectedImages.length || !name || !code) return alert("Fill Name, Price and Code!");
      getEl('upIndicator').classList.remove('hidden');
      let vUrl = getEl('videourlInput').value.trim();
      if(attachedVideo) { const vR = st.ref(`vids/${Date.now()}_${attachedVideo.name}`); await vR.put(attachedVideo); vUrl = await vR.getDownloadURL(); }
      selectedImages.forEach((file, i) => {
         const fName = selectedImages.length > 1 ? `${name} ${i+1}` : name;
         const prg = document.createElement('div'); prg.className = 'bg-white p-3 rounded-2xl shadow-sm flex items-center gap-3 mb-2 border border-blue-50'; prg.innerHTML = `<div class="flex-1 truncate text-[10px] font-black uppercase text-blue-600">${fName}</div><div class="w-16 h-1 bg-slate-100 rounded-full overflow-hidden"><div class="progress-bar bg-blue-600 h-full w-0"></div></div>`; getEl('queue').appendChild(prg);
         pendingUploads.push({ file, name: fName, price, partyCode: code, videourl: vUrl, prg });
      });
      selectedImages = []; attachedVideo = null; renderPreviews(); getEl('vLabel').innerText = "Optional: Drop Video File"; getEl('nameInput').value = ''; getEl('priceInput').value = '';
      processQueue();
    };

    async function processQueue() {
      if (isUploading || !pendingUploads.length) { if(!pendingUploads.length) getEl('upIndicator').classList.add('hidden'); return; }
      isUploading = true; const item = pendingUploads.shift(); const bar = item.prg.querySelector('.progress-bar'); const sR = st.ref(`toys/${Date.now()}_${item.file.name}`); const task = sR.put(item.file);
      task.on('state_changed', (s) => bar.style.width = (s.bytesTransferred/s.totalBytes*100)+'%', null, async () => { const url = await sR.getDownloadURL(); await db.ref().push({ name: item.name, price: item.price, partyCode: item.partyCode, url, videourl: item.videourl || '', outOfStock: false, date: new Date().toISOString() }); item.prg.remove(); isUploading = false; processQueue(); });
    }

    // --- SYNC & LAZY ---
    db.ref().on('value', (snap) => { masterList = []; snap.forEach(c => { if(c.val().url) masterList.push({ key: c.key, data: c.val() }); }); performSearch(); });
    function initLazy() { const obs = new IntersectionObserver((es, o) => { es.forEach(e => { if(e.isIntersecting){ e.target.src = e.target.dataset.src; e.target.classList.add('loaded'); o.unobserve(e.target); } }); }); document.querySelectorAll('img[data-src]').forEach(i => obs.observe(i)); }
    let sTimeout;
    getEl('nSearch').oninput = () => { clearTimeout(sTimeout); sTimeout = setTimeout(performSearch, 300); };
    getEl('cSearch').oninput = () => { clearTimeout(sTimeout); sTimeout = setTimeout(performSearch, 300); };
  </script>
</body>
</html>
