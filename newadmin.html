<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Product Gallery with Image + Video (Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind for styles -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <style>
    .drop-zone {
      border: 2px dashed #cbd5e1; /* slate-300 */
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .drop-zone:hover, .drop-zone.active {
      background-color: #f8fafc; /* slate-50 */
      border-color: #3b82f6; /* blue-500 */
    }
    #globalDropOverlay {
      display: none;
    }
    #globalDropOverlay.active {
      display: flex;
    }
    .truncate-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Global Drag & Drop Overlay -->
  <div id="globalDropOverlay" class="fixed inset-0 bg-black/50 z-50 items-center justify-center text-white text-xl">
    Drop files to upload
  </div>

  <div class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-4">Product Manager</h1>

    <!-- Upload Card -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
      <!-- Left: Upload inputs -->
      <div class="lg:col-span-1 bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Add New Product</h2>

        <div class="space-y-3">
          <div>
            <label for="nameInput" class="block text-sm font-medium text-gray-700">Name</label>
            <input id="nameInput" type="text" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Product name" />
          </div>

          <div>
            <label for="priceInput" class="block text-sm font-medium text-gray-700">Price</label>
            <input id="priceInput" type="number" step="0.01" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" />
          </div>

          <div>
            <label for="partyCodeInput" class="block text-sm font-medium text-gray-700">Party Code</label>
            <input id="partyCodeInput" type="text" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., ABC123" />
          </div>

          <div>
            <label for="videourlInput" class="block text-sm font-medium text-gray-700">
              Video URL (auto-filled when you upload a video)
            </label>
            <input id="videourlInput" type="url" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="https://..." />
          </div>
        </div>

        <!-- Image drop zone -->
        <div class="drop-zone rounded-lg p-4 text-center cursor-pointer mt-4" id="imageDropZone">
          <div class="text-gray-500">Click to upload or Drag & Drop an image</div>
          <div class="preview mt-4" id="preview"></div>
          <input type="file" id="imageInput" class="hidden" accept="image/*" />
        </div>

        <!-- Video drop zone -->
        <div class="drop-zone rounded-lg p-4 text-center cursor-pointer mt-4" id="videoDropZone">
          <div class="text-gray-500">Optional: Click to upload or Drag & Drop a video</div>
          <div class="preview mt-4" id="videoPreview"></div>
          <input type="file" id="videoInput" class="hidden" accept="video/*" />
        </div>

        <button id="uploadBtn" class="w-full mt-5 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-lg">
          Upload Product
        </button>
      </div>

      <!-- Middle: Upload queue / progress -->
      <div class="lg:col-span-2 bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Upload Queue & Progress</h2>
        <div id="progressList" class="space-y-3"></div>
      </div>
    </div>

    <!-- Search Card -->
    <div class="mt-8 bg-white rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold mb-3">Search Products</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="nameSearchInput" class="block text-sm font-medium text-gray-700">Search by Product Name</label>
          <input id="nameSearchInput" type="text" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter product name..." />
        </div>
        <div>
          <label for="partyCodeSearchInput" class="block text-sm font-medium text-gray-700">Search by Party Code</label>
          <input id="partyCodeSearchInput" type="text" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter party code..." />
        </div>
      </div>
    </div>

    <!-- Gallery -->
    <div class="mt-8">
      <h2 class="text-lg font-semibold mb-3">Products</h2>
      <div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5"></div>
    </div>
  </div>

  <script>
    // 1) Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyAvlig_xWJNP1hFsl4qfisC01VTkOAVhT8",
      authDomain: "htshop-e9c51.firebaseapp.com",
      databaseURL: "https://htshop-e9c51-default-rtdb.firebaseio.com",
      projectId: "htshop-e9c51",
      storageBucket: "htshop-e9c51.appspot.com",
      messagingSenderId: "653137640907",
      appId: "1:653137640907:web:672fd6a9e85ca448a70a4e",
      measurementId: "G-FJ4Q0FHBEG"
    };
    firebase.initializeApp(firebaseConfig);

    const database = firebase.database();
    const storage = firebase.storage();

    // 2) Element references
    const imageDropZone = document.getElementById('imageDropZone');
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const videoDropZone = document.getElementById('videoDropZone');
    const videoInput = document.getElementById('videoInput');
    const videoPreview = document.getElementById('videoPreview');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressList = document.getElementById('progressList');
    const galleryGrid = document.getElementById('galleryGrid');
    const globalDropOverlay = document.getElementById('globalDropOverlay');
    const nameSearchInput = document.getElementById('nameSearchInput');
    const partyCodeSearchInput = document.getElementById('partyCodeSearchInput');

    // 3) State
    const uploadQueue = [];
    let isUploading = false;
    const loadedImageKeys = new Set();
    let products = [];

    // 4) UI helpers
    function previewImage(file) {
      if (!file || !file.type.startsWith('image/')) return;
      const url = URL.createObjectURL(file);
      preview.innerHTML = `
        <img src="${url}" alt="preview" class="mx-auto w-full rounded-lg object-contain" style="max-height: 240px;" />
        <div class="text-xs text-gray-500 mt-1 truncate">${file.name}</div>
      `;
    }
    function previewVideo(file) {
      if (!file || !file.type.startsWith('video/')) return;
      const url = URL.createObjectURL(file);
      videoPreview.innerHTML = `
        <video src="${url}" controls class="mx-auto w-full rounded-lg" style="max-height: 240px;"></video>
        <div class="text-xs text-gray-500 mt-1 truncate">${file.name}</div>
      `;
    }

    // 5) Drag & Drop
    function setupDropZone(zone, input, previewFn) {
      zone.addEventListener('dragenter', (e) => {
        e.preventDefault();
        zone.classList.add('active');
        globalDropOverlay.classList.remove('active');
      });
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('active');
      });
      zone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        if (!zone.contains(e.relatedTarget)) {
          zone.classList.remove('active');
        }
      });
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('active');
        globalDropOverlay.classList.remove('active');
        const files = e.dataTransfer.files;
        if (files.length) {
          input.files = files;
          previewFn(files[0]);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    }

    setupDropZone(imageDropZone, imageInput, previewImage);
    setupDropZone(videoDropZone, videoInput, previewVideo);

    window.addEventListener('dragenter', (e) => {
      e.preventDefault();
      if (!imageDropZone.contains(e.target) && !videoDropZone.contains(e.target)) {
        globalDropOverlay.classList.add('active');
      }
    });
    window.addEventListener('dragover', (e) => {
      e.preventDefault();
    });
    window.addEventListener('dragleave', (e) => {
      e.preventDefault();
      if (!e.relatedTarget || e.relatedTarget === document.documentElement || e.relatedTarget === document.body) {
        globalDropOverlay.classList.remove('active');
      }
    });
    window.addEventListener('drop', (e) => {
      e.preventDefault();
      globalDropOverlay.classList.remove('active');
      if (!imageDropZone.contains(e.target) && !videoDropZone.contains(e.target)) {
        const files = e.dataTransfer.files;
        if (files.length) {
          const file = files[0];
          if (file.type.startsWith('image/')) {
            imageInput.files = files;
            previewImage(file);
          } else if (file.type.startsWith('video/')) {
            videoInput.files = files;
            previewVideo(file);
          }
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
    });

    imageInput.addEventListener('change', () => {
      if (imageInput.files.length) previewImage(imageInput.files[0]);
    });
    videoInput.addEventListener('change', () => {
      if (videoInput.files.length) previewVideo(videoInput.files[0]);
    });

    // 6) Upload flow
    uploadBtn.addEventListener('click', uploadImage);

    async function uploadImage() {
      const file = imageInput.files[0];
      const name = document.getElementById('nameInput').value.trim();
      const priceInput = parseFloat(document.getElementById('priceInput').value.trim());
      const partyCode = document.getElementById('partyCodeInput').value.trim();
      const videourlInputEl = document.getElementById('videourlInput');

      if (!file || !name || !partyCode || isNaN(priceInput) || priceInput <= 0) {
        alert('Please fill all required fields with valid values.');
        return;
      }

      // Divide price by 2 before uploading
      const price = priceInput / 2;

      let finalVideoURL = (videourlInputEl.value || '').trim();
      if (videoInput.files && videoInput.files[0]) {
        const videoFile = videoInput.files[0];
        const now = new Date().toISOString();
        const videoStorageRef = storage.ref(`${now}_${sanitizePath(name)}_${videoFile.name}`);

        const videoStatus = document.createElement('div');
        videoStatus.className = 'mb-2 text-sm text-blue-600';
        videoStatus.textContent = 'Uploading video...';
        videoPreview.appendChild(videoStatus);

        try {
          await videoStorageRef.put(videoFile);
          finalVideoURL = await videoStorageRef.getDownloadURL();
          videourlInputEl.value = finalVideoURL;
          videoStatus.textContent = 'Video uploaded.';
        } catch (err) {
          console.error('Video upload failed:', err);
          videoStatus.textContent = 'Video upload failed.';
          alert('Video upload failed. You can still upload the image, or try again.');
        }
      }

      const thumbDataURL = await fileToDataURL(file);
      const progressContainer = document.createElement('div');
      progressContainer.className = 'p-3 bg-gray-100 rounded';
      progressContainer.innerHTML = `
        <div class="flex items-center">
          <img src="${thumbDataURL}" alt="thumbnail" class="w-12 h-12 object-cover rounded mr-4" />
          <div class="flex-grow">
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm font-medium text-gray-800 truncate w-48" title="${file.name}">${file.name}</span>
              <span class="status text-sm text-blue-600 font-semibold">Uploading...</span>
            </div>
            <div class="bg-gray-300 rounded-full h-2.5">
              <div class="progress-bar bg-blue-600 h-2.5 rounded-full w-0 transition-all duration-300"></div>
            </div>
          </div>
        </div>
      `;
      progressList.prepend(progressContainer);

      uploadQueue.push({
        file,
        name,
        price,
        partyCode,
        videourl: finalVideoURL || '',
        progressContainer
      });

      imageInput.value = '';
      videoInput.value = '';
      document.getElementById('nameInput').value = '';
      document.getElementById('priceInput').value = '';
      document.getElementById('partyCodeInput').value = '';
      preview.innerHTML = '';
      videoPreview.innerHTML = '';

      processUploadQueue();
    }

    function sanitizePath(s) {
      return s.replace(/[^\w\-]+/g, '_');
    }
    function fileToDataURL(fileToRead) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(fileToRead);
      });
    }

    async function processUploadQueue() {
      if (isUploading) return;
      if (uploadQueue.length === 0) return;

      isUploading = true;
      const item = uploadQueue.shift();

      const { file, name, price, partyCode, videourl, progressContainer } = item;
      const progressBar = progressContainer.querySelector('.progress-bar');
      const statusEl = progressContainer.querySelector('.status');

      const now = new Date().toISOString();
      const storageRef = storage.ref().child(`${now}_${sanitizePath(name)}_${file.name}`);

      try {
        await new Promise((resolve, reject) => {
          const task = storageRef.put(file);
          task.on('state_changed',
            (snap) => {
              const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
              progressBar.style.width = pct + '%';
              statusEl.textContent = `Uploading... ${pct}%`;
            },
            (err) => reject(err),
            async () => {
              try {
                const imageURL = await storageRef.getDownloadURL();
                statusEl.textContent = 'Finalizing...';

                const data = {
                  name,
                  price,
                  partyCode,
                  url: imageURL,
                  videourl: videourl || '',
                  outOfStock: false,
                  date: new Date().toISOString()
                };
                const ref = database.ref().push();
                await ref.set(data);

                statusEl.textContent = 'Done';
                progressBar.style.width = '100%';
                setTimeout(() => progressContainer.remove(), 1200);

                resolve();
              } catch (e) {
                reject(e);
              }
            }
          );
        });
      } catch (err) {
        console.error('Image upload failed:', err.message || err);
        statusEl.textContent = `Failed: ${err.message || 'Unknown error'}`;
        progressBar.classList.remove('bg-blue-600');
        progressBar.classList.add('bg-red-500');
        alert(`Image upload failed: ${err.message || 'Unknown error'}. Please check your Firebase permissions or network connection and try again.`);
      } finally {
        isUploading = false;
        if (uploadQueue.length > 0) processUploadQueue();
      }
    }

    // 7) Render cards
    function renderCard(key, data) {
      const container = document.createElement('div');
      container.className = 'bg-white rounded-xl shadow overflow-hidden';
      container.dataset.key = key;

      container.innerHTML = `
        <img src="${data.url}" alt="${escapeHtml(data.name)}" class="w-full h-48 object-cover" loading="lazy">
        <div class="p-4">
          <h3 class="font-semibold text-lg mb-2 editable-field truncate-2" onclick="makeEditable(this, '${key}', 'name')" title="Click to edit name">
            ${escapeHtml(data.name)}
          </h3>

          <p class="text-gray-600 mb-1 editable-field" onclick="makeEditable(this, '${key}', 'price')" title="Click to edit price">
            Price: ${Number(data.price).toFixed(2)}
          </p>
          <p class="text-gray-600 mb-2 editable-field" onclick="makeEditable(this, '${key}', 'partyCode')" title="Click to edit party code">
            Party Code: ${escapeHtml(data.partyCode || '')}
          </p>

          <div class="mt-2" id="videoRow-${key}">
            ${
              data.videourl
                ? `<a href="${data.videourl}" target="_blank" class="text-blue-600 hover:underline text-sm">Watch video</a>`
                : `<span class="text-sm text-gray-400">No video</span>`
            }
          </div>

          <div class="flex justify-between items-center mt-3">
            <p class="text-gray-600 status-display-${key}">Status: ${data.outOfStock ? 'Out of Stock' : 'Available'}</p>
            <button onclick="toggleStockStatus('${key}', ${!!data.outOfStock})"
              class="text-white py-1 px-3 rounded-full text-sm font-semibold ${data.outOfStock ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}">
              ${data.outOfStock ? 'Mark Available' : 'Mark Out of Stock'}
            </button>
          </div>

          <div class="flex justify-between items-center mt-2">
            <p class="text-sm text-gray-500 uploaded-date-${key}">Uploaded: ${data.date || new Date().toISOString()}</p>
            <button onclick="updateUploadDate('${key}')" class="text-white py-1 px-3 rounded-full text-xs font-semibold bg-blue-500 hover:bg-blue-600">
              Update Date
            </button>
          </div>

          <div class="flex flex-wrap gap-2 items-center mt-4">
            <button onclick="replaceImage('${key}', '${encodeURIComponent(data.url || '')}')"
              class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded text-sm">
              Replace Image
            </button>
            <button onclick="replaceVideo('${key}', '${encodeURIComponent(data.videourl || '')}')"
              class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded text-sm">
              Replace Video
            </button>

            <button onclick="confirmDelete('${key}')"
              class="ml-auto bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
              Delete
            </button>
          </div>
        </div>
      `;
      return container;
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, s => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      }[s]));
    }

    // 8) Optimized Realtime listeners with batch rendering
    function batchRenderGallery(nameQuery = '', partyCodeQuery = '') {
      const fragment = document.createDocumentFragment();
      const nameLower = nameQuery.toLowerCase().trim();
      const partyCodeLower = partyCodeQuery.toLowerCase().trim();

      const filteredProducts = products.filter(({ data }) => {
        const nameMatch = !nameLower || (data.name && data.name.toLowerCase().includes(nameLower));
        const partyCodeMatch = !partyCodeLower || (data.partyCode && data.partyCode.toLowerCase().includes(partyCodeLower));
        return nameMatch && partyCodeMatch;
      });

      filteredProducts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
      filteredProducts.forEach(({ key, data }) => {
        const card = renderCard(key, data);
        fragment.appendChild(card);
      });
      galleryGrid.innerHTML = '';
      galleryGrid.appendChild(fragment);
    }

    database.ref().on('value', (snapshot) => {
      products = [];
      loadedImageKeys.clear();
      snapshot.forEach(childSnapshot => {
        const key = childSnapshot.key;
        const data = childSnapshot.val() || {};
        products.push({ key, data });
        loadedImageKeys.add(key);
      });
      batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);
    });

    database.ref().on('child_changed', (snapshot) => {
      const key = snapshot.key;
      const updatedData = snapshot.val() || {};
      const index = products.findIndex(p => p.key === key);
      if (index !== -1) {
        products[index].data = updatedData;
      } else {
        products.push({ key, data: updatedData });
        loadedImageKeys.add(key);
      }
      batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);
    });

    database.ref().on('child_removed', (snapshot) => {
      const key = snapshot.key;
      products = products.filter(p => p.key !== key);
      loadedImageKeys.delete(key);
      batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);
    });

    // 9) Search functionality
    function handleSearch() {
      batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);
    }

    nameSearchInput.addEventListener('input', handleSearch);
    partyCodeSearchInput.addEventListener('input', handleSearch);

    // 10) Inline editing
    window.makeEditable = function(el, key, field) {
      const isPrice = field === 'price';
      const prev = el.textContent.replace(/^Price:\s*/i, '').replace(/^Party Code:\s*/i, '').trim();
      const input = document.createElement('input');
      input.type = isPrice ? 'number' : 'text';
      if (isPrice) input.step = '0.01';
      input.value = prev;
      input.className = 'w-full border border-gray-300 rounded px-2 py-1';
      el.replaceWith(input);
      input.focus();
      input.select();

      function commit() {
        let value = input.value.trim();
        if (isPrice) value = parseFloat(value || '0') || 0;

        const updateObj = {};
        updateObj[field] = value;
        database.ref(key).update(updateObj).then(() => {
          const span = document.createElement(field === 'name' ? 'h3' : 'p');
          if (field === 'name') {
            span.className = 'font-semibold text-lg mb-2 editable-field truncate-2';
            span.title = 'Click to edit name';
            span.setAttribute('onclick', `makeEditable(this, '${key}', 'name')`);
            span.textContent = String(value);
          } else if (field === 'price') {
            span.className = 'text-gray-600 mb-1 editable-field';
            span.title = 'Click to edit price';
            span.setAttribute('onclick', `makeEditable(this, '${key}', 'price')`);
            span.textContent = `Price: ${Number(value).toFixed(2)}`;
          } else {
            span.className = 'text-gray-600 mb-2 editable-field';
            span.title = 'Click to edit party code';
            span.setAttribute('onclick', `makeEditable(this, '${key}', 'partyCode')`);
            span.textContent = `Party Code: ${String(value)}`;
          }
          input.replaceWith(span);
        }).catch(err => {
          console.error('Update failed:', err);
          alert('Failed to update. Please try again.');
          input.replaceWith(el);
        });
      }
      input.addEventListener('blur', commit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') commit();
        if (e.key === 'Escape') input.replaceWith(el);
      });
    };

    // 11) Stock toggle, update date
    window.toggleStockStatus = function(key, current) {
      database.ref(key).update({ outOfStock: !current }).catch(err => {
        console.error('Toggle stock failed:', err);
        alert('Failed to toggle stock status.');
      });
    };
    window.updateUploadDate = function(key) {
      database.ref(key).update({ date: new Date().toISOString() }).catch(err => {
        console.error('Update date failed:', err);
        alert('Failed to update upload date.');
      });
    };

    // 12) Delete product
    window.confirmDelete = function(key) {
      if (confirm('Are you sure you want to delete this product? This will also remove its associated image and video from storage.')) {
        deleteProduct(key);
      }
    };

    function isFirebaseStorageUrl(url) {
      if (!url) return false;
      return url.startsWith('https://firebasestorage.googleapis.com') ||
             (typeof firebaseConfig?.storageBucket === 'string' && url.includes(firebaseConfig.storageBucket));
    }

    async function deleteProduct(key) {
      // Disable the delete button to prevent multiple clicks
      const deleteButton = document.querySelector(`[data-key="${key}"] button[onclick*="confirmDelete"]`);
      if (deleteButton) {
        deleteButton.disabled = true;
        deleteButton.textContent = 'Deleting...';
      }

      try {
        // Fetch product data
        const snapshot = await database.ref(key).once('value');
        if (!snapshot.exists()) {
          throw new Error('Product not found in database');
        }
        const data = snapshot.val() || {};
        const imageUrl = data.url;
        const videoUrl = data.videourl;

        // Optimistically update UI
        const deletedElement = document.querySelector(`[data-key="${key}"]`);
        if (deletedElement) {
          deletedElement.style.opacity = '0.5';
          deletedElement.style.pointerEvents = 'none';
        }
        products = products.filter(p => p.key !== key);
        loadedImageKeys.delete(key);
        batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);

        // Attempt to delete storage files
        const deletions = [];
        if (imageUrl && isFirebaseStorageUrl(imageUrl)) {
          deletions.push(
            storage.refFromURL(imageUrl).delete().catch(err => {
              console.warn(`Unable to delete image from storage for ${key}:`, err);
              // Continue even if image deletion fails
            })
          );
        }
        if (videoUrl && isFirebaseStorageUrl(videoUrl)) {
          deletions.push(
            storage.refFromURL(videoUrl).delete().catch(err => {
              console.warn(`Unable to delete video from storage for ${key}:`, err);
              // Continue even if video deletion fails
            })
          );
        }

        // Wait for storage deletions to settle
        await Promise.allSettled(deletions);

        // Remove product from database
        await database.ref(key).remove();

        alert('Product deleted successfully.');
      } catch (err) {
        console.error('Failed to delete product:', err);
        alert(`Failed to delete product: ${err.message || 'Unknown error'}. Please check your Firebase permissions and try again.`);
        // Revert UI changes on failure
        batchRenderGallery(nameSearchInput.value, partyCodeSearchInput.value);
      } finally {
        if (deleteButton) {
          deleteButton.disabled = false;
          deleteButton.textContent = 'Delete';
        }
      }
    }

    // 13) Replace image / video
    window.replaceImage = function(key, currentImageUrlEncoded) {
      const currentImageUrl = decodeURIComponent(currentImageUrlEncoded || '');
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        const now = new Date().toISOString();
        const storageRefNew = storage.ref().child(`${now}_REPLACE_${file.name}`);

        try {
          await storageRefNew.put(file);
          const newUrl = await storageRefNew.getDownloadURL();
          await database.ref(key).update({ url: newUrl });

          if (currentImageUrl && isFirebaseStorageUrl(currentImageUrl)) {
            storage.refFromURL(currentImageUrl).delete().catch(err => {
              console.warn('Old image delete failed:', err);
            });
          }

          alert('Image replaced successfully.');
        } catch (err) {
          console.error('Replace image failed:', err);
          alert('Failed to replace image.');
        }
      };
      input.click();
    };

    window.replaceVideo = function(key, restingVideoUrlEncoded) {
      const currentVideoUrl = decodeURIComponent(restingVideoUrlEncoded || '');
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'video/*';
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        const now = new Date().toISOString();
        const storageRefNew = storage.ref().child(`${now}_REPLACE_${file.name}`);

        try {
          await storageRefNew.put(file);
          const newUrl = await storageRefNew.getDownloadURL();
          await database.ref(key).update({ videourl: newUrl });

          if (currentVideoUrl && isFirebaseStorageUrl(currentVideoUrl)) {
            storage.refFromURL(currentVideoUrl).delete().catch(err => {
              console.warn('Old video delete failed:', err);
            });
          }

          alert('Video replaced successfully.');
        } catch (err) {
          console.error('Replace video failed:', err);
          alert('Failed to replace video.');
        }
      };
      input.click();
    };
  </script>
</body>
</html>
